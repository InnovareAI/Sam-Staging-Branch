(()=>{var a={};a.id=2147,a.ids=[2147],a.modules={261:a=>{"use strict";a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{"use strict";a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10131:(a,b,c)=>{"use strict";c.d(b,{Eu:()=>h,Y0:()=>i,mf:()=>f,o0:()=>g});var d=c(13333);class e{constructor(a){this.client=new d.hA(a.apiKey),this.config=a}async checkEmailSuppression(a){try{let b=await this.client.getSuppressions("outbound"),c=b.Suppressions?.find(b=>b.EmailAddress.toLowerCase()===a.toLowerCase());if(c)return{canSend:!1,reason:this.getSuppressionReasonMessage(c.SuppressionReason),suppressionInfo:c};return{canSend:!0}}catch(b){return console.error(`Error checking email suppression for ${a}:`,b),{canSend:!0,reason:"Unable to verify suppression status - will attempt to send"}}}getSuppressionReasonMessage(a){switch(a){case"HardBounce":return"Email address has hard bounced (invalid/non-existent)";case"SpamComplaint":return"Recipient has marked emails as spam";case"ManualSuppression":return"Email address has been manually suppressed";case"Unsubscribe":return"Recipient has unsubscribed from emails";default:return`Email is suppressed (${a})`}}async reactivateEmail(a){try{return await this.client.deleteSuppressions("outbound",{Suppressions:[{EmailAddress:a}]}),{success:!0,message:"Email address reactivated successfully"}}catch(a){return{success:!1,message:a.Message||"Failed to reactivate email address"}}}async sendEmailSafely(a){try{let b=await this.checkEmailSuppression(a.To);if(!b.canSend)return{success:!1,error:`Cannot send email: ${b.reason}`,suppressionInfo:b.suppressionInfo,canRetryAfterReactivation:!0};let c=await this.client.sendEmail({From:a.From||this.config.fromEmail,To:a.To,Subject:a.Subject,HtmlBody:a.HtmlBody,TextBody:a.TextBody,MessageStream:a.MessageStream||"outbound"});return{success:!0,messageId:c.MessageID}}catch(b){if(b.Message?.includes("InactiveRecipientsError")||b.Message?.includes("inactive"))return{success:!1,error:"Recipient is marked as inactive/suppressed in Postmark",suppressionInfo:(await this.checkEmailSuppression(a.To)).suppressionInfo,canRetryAfterReactivation:!0};return{success:!1,error:b.Message||"Unknown email sending error",canRetryAfterReactivation:!1}}}generateTestEmails(){return{safe:["test@innovareai.com","sandbox@3cubed.ai","demo@meet-sam.com"],forTesting:["test@blackhole.postmarkapp.com","bounce@simulator.postmarkapp.com"],description:"Use safe emails for production testing, test emails for development"}}createBypassEmail(a){return Date.now(),console.log(`EMAIL_BYPASS_MODE: Original recipient: ${a}, redirected to test email at ${new Date().toISOString()}`),"test@blackhole.postmarkapp.com"}async bulkCheckSuppressions(a){let b=new Map;try{let c=await this.client.getSuppressions("outbound"),d=new Set(c.Suppressions?.map(a=>a.EmailAddress.toLowerCase())||[]);for(let e of a)if(d.has(e.toLowerCase())){let a=c.Suppressions?.find(a=>a.EmailAddress.toLowerCase()===e.toLowerCase());b.set(e,{canSend:!1,reason:a?this.getSuppressionReasonMessage(a.SuppressionReason):"Suppressed",suppressionInfo:a})}else b.set(e,{canSend:!0})}catch(c){for(let d of(console.error("Error in bulk suppression check:",c),a))b.set(d,{canSend:!0,reason:"Unable to verify suppression status"})}return b}}function f(a){let b=function(a){let b={InnovareAI:{apiKey:process.env.POSTMARK_INNOVAREAI_API_KEY||"",fromEmail:"sp@innovareai.com",companyName:"InnovareAI",contactEmail:"sp@innovareai.com",contactName:"Sarah Powell"},"3cubedai":{apiKey:process.env.POSTMARK_3CUBEDAI_API_KEY||"",fromEmail:"sophia@3cubed.ai",companyName:"3CubedAI",contactEmail:"sophia@3cubed.ai",contactName:"Sophia Caldwell"}}[a];return b?.apiKey?b:(console.error(`Missing Postmark API key for ${a}`),null)}(a);return b?new e(b):null}let g="true"===process.env.EMAIL_BYPASS_MODE;function h(a){return g}function i(){return"test@blackhole.postmarkapp.com"}},10846:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:a=>{"use strict";a.exports=require("punycode")},12412:a=>{"use strict";a.exports=require("assert")},19121:a=>{"use strict";a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},27910:a=>{"use strict";a.exports=require("stream")},28354:a=>{"use strict";a.exports=require("util")},29021:a=>{"use strict";a.exports=require("fs")},29294:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:a=>{"use strict";a.exports=require("path")},44870:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:a=>{"use strict";a.exports=require("crypto")},55591:a=>{"use strict";a.exports=require("https")},57729:()=>{},61688:(a,b,c)=>{"use strict";c.r(b),c.d(b,{handler:()=>G,patchFetch:()=>F,routeModule:()=>B,serverHooks:()=>E,workAsyncStorage:()=>C,workUnitAsyncStorage:()=>D});var d={};c.r(d),c.d(d,{POST:()=>A});var e=c(95736),f=c(9117),g=c(4044),h=c(39326),i=c(32324),j=c(261),k=c(54290),l=c(85328),m=c(38928),n=c(46595),o=c(3421),p=c(17679),q=c(41681),r=c(63446),s=c(86439),t=c(51356),u=c(82461),v=c(10641),w=c(10131);let x={InnovareAI:{postmarkApiKey:process.env.POSTMARK_INNOVAREAI_API_KEY,fromEmail:"sp@innovareai.com",companyName:"InnovareAI",contactEmail:"sp@innovareai.com",contactName:"Sarah Powell"},"3cubedai":{postmarkApiKey:process.env.POSTMARK_3CUBEDAI_API_KEY,fromEmail:"sophia@3cubed.ai",companyName:"3CubedAI",contactEmail:"sophia@3cubed.ai",contactName:"Sophia Caldwell"}},y=["tl@innovareai.com","cl@innovareai.com"];function z(a,b,c="INFO"){let d=new Date().toISOString();console.log(`${"ERROR"===c?"❌":"WARN"===c?"⚠️":"✅"} [${d}] INVITATION_${a}:`),"object"==typeof b?console.log(JSON.stringify(b,null,2)):console.log(b)}async function A(a){try{let b,c=a.headers.get("authorization");if(!c)return v.NextResponse.json({error:"Authorization required"},{status:401});let d="https://latxadqrvrrrcvkktrog.supabase.co",e=process.env.SUPABASE_SERVICE_ROLE_KEY,f=(0,u.UU)(d,e),g=(0,u.UU)(d,"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxhdHhhZHFydnJycmN2a2t0cm9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2OTk5ODYsImV4cCI6MjA2ODI3NTk4Nn0.3WkAgXpk_MyQioVf_SED9O_ArjcT9nH0uy9we2okftE",{global:{headers:{Authorization:c}}}),{data:{user:h},error:i}=await g.auth.getUser();if(i||!h)return v.NextResponse.json({error:"Unauthorized"},{status:401});if(!y.includes(h.email?.toLowerCase()||""))return v.NextResponse.json({error:"Forbidden - Super admin access required"},{status:403});let{email:j,firstName:k,lastName:l,organizationId:m,workspaceId:n,company:o="InnovareAI",role:p="member"}=await a.json();if(!j||!k||!l)return v.NextResponse.json({error:"Email, first name, and last name are required"},{status:400});if(!x[o])return v.NextResponse.json({error:"Invalid company"},{status:400});if(m){let{data:a,error:b}=await f.from("organizations").select("id, name").eq("id",m).single();if(b||!a)return v.NextResponse.json({error:"Organization not found"},{status:404})}console.log("Sending invitation to:",j);let{data:q,error:r}=await f.auth.admin.listUsers();if(r)return console.error("Error checking existing users:",r),v.NextResponse.json({error:"Failed to check existing users: "+r.message},{status:500});let s=q.users.find(a=>a.email?.toLowerCase()===j.toLowerCase());if(s)z("EXISTING_USER_FOUND",{email:j,userId:s.id,userCreatedAt:s.created_at}),b={user:s,source:"existing_user"};else{z("NEW_USER_INVITATION_START",{email:j,firstName:k,lastName:l,organizationId:m,role:p,invitedBy:h.id});let{data:a,error:c}=await f.auth.admin.createUser({email:j,email_confirm:!0,user_metadata:{first_name:k,last_name:l,invited_by:h.id,organization_id:m,role:p}});if(c)return z("INVITATION_ERROR",{error:c,email:j,errorMessage:c.message,errorCode:c.status||"unknown"},"ERROR"),v.NextResponse.json({error:"Failed to send invitation: "+c.message},{status:500});z("SUPABASE_RESPONSE_RECEIVED",{email:j,dataKeys:Object.keys(a||{}),hasUser:!!a?.user,rawResponse:a});let d=function(a,b){if(z("RESPONSE_ANALYSIS",{hasUserProperty:!!a.user,userPropertyId:a.user?.id,directId:a.id,userIdProperty:a.user_id,userIdVariant:a.userId,email:b,fullResponseKeys:Object.keys(a)}),a.user?.id)return z("PRIMARY_PATH_SUCCESS",{userId:a.user.id,email:a.user.email||b,source:"user_object"}),{user:a.user,source:"new_invitation"};let c=[a.id,a.user_id,a.userId,a.user?.id,a.data?.user?.id,a.data?.id].filter(Boolean);if(z("ID_EXTRACTION_ATTEMPT",{possibleIds:c,totalFound:c.length}),c.length>0){let d=c[0],e={id:d,email:b,invited_at:a.invited_at||new Date().toISOString()};return z("FALLBACK_SUCCESS",{userId:d,email:b,source:"id_extraction",extractedFrom:c.length>1?"multiple_sources":"single_source"}),{user:e,source:"fallback_created"}}let d=(a,b="")=>{if(!a||"object"!=typeof a)return null;for(let[c,e]of Object.entries(a)){let a=b?`${b}.${c}`:c;if(("id"===c||c.includes("id")||c.includes("Id"))&&"string"==typeof e&&e.length>10)return z("DEEP_ID_FOUND",{path:a,value:e,key:c}),e;if("object"==typeof e&&null!==e){let b=d(e,a);if(b)return b}}return null},e=d(a);if(e){let c={id:e,email:b,invited_at:a.invited_at||new Date().toISOString()};return z("DEEP_SEARCH_SUCCESS",{userId:e,email:b,source:"deep_inspection"}),{user:c,source:"fallback_created"}}return z("COMPLETE_FAILURE",{message:"No user ID found in any location",responseStructure:{keys:Object.keys(a),hasUser:!!a.user,responseType:typeof a,email:b}},"ERROR"),null}(a,j);if(!d)return z("CRITICAL_EXTRACTION_FAILURE",{message:"Enhanced extraction failed completely",email:j,responseReceived:!!a,supportContact:"Please contact technical support with this error"},"ERROR"),v.NextResponse.json({error:"Failed to create user invitation - unable to extract user ID from Supabase response. Please try again or contact technical support.",details:{email:j,timestamp:new Date().toISOString(),errorCode:"USER_ID_EXTRACTION_FAILED"}},{status:500});b=d,z("EXTRACTION_SUCCESS",{userId:d.user.id,email:d.user.email,source:d.source})}try{let a=(0,w.mf)(o);if(a){let b="https://app.meet-sam.com",c=!s,d=x[o],e=j,f="";(0,w.Eu)(j)&&(e=(0,w.Y0)(),f=` (BYPASS MODE: Original recipient was ${j})`,z("EMAIL_BYPASS_ACTIVE",{originalEmail:j,redirectedTo:e,reason:"EMAIL_BYPASS_MODE enabled"},"WARN"));let g=c?`Welcome to SAM AI - Your Account is Ready!${f}`:`You've been added to SAM AI by ${d.companyName}${f}`,h=c?`
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            ${f?`<div style="background: #fff3cd; padding: 10px; border-radius: 4px; margin-bottom: 20px; color: #856404;"><strong>TEST MODE:</strong> This email was originally intended for ${j}</div>`:""}
            <h1 style="color: #7c3aed;">Welcome to SAM AI!</h1>
            <p>Hello ${k},</p>
            <p>You've been invited to join SAM AI by ${d.companyName}. Your intelligent sales assistant is ready to help you streamline your sales process and boost productivity.</p>
            <div style="margin: 30px 0; text-align: center;">
              <a href="${b}/auth/callback" 
                 style="background-color: #7c3aed; color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; display: inline-block;">
                Access SAM AI Platform
              </a>
            </div>
            <p><strong>What you can do with SAM AI:</strong></p>
            <ul>
              <li>Chat with your AI sales assistant for personalized guidance</li>
              <li>Access comprehensive knowledge base</li>
              <li>Manage your lead pipeline efficiently</li>
              <li>Track campaign performance and analytics</li>
              <li>Collaborate with your team in shared workspaces</li>
            </ul>
            <p style="color: #666; font-size: 14px;">
              If you have any questions, please contact ${d.contactName} at ${d.contactEmail} or our support team.
            </p>
            <hr style="margin: 30px 0; border: none; border-top: 1px solid #eee;">
            <p style="color: #999; font-size: 12px;">
              This invitation was sent by ${d.companyName}. 
              If you didn't expect this invitation, you can safely ignore this email.
            </p>
          </div>
        `:`
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            ${f?`<div style="background: #fff3cd; padding: 10px; border-radius: 4px; margin-bottom: 20px; color: #856404;"><strong>TEST MODE:</strong> This email was originally intended for ${j}</div>`:""}
            <h1 style="color: #7c3aed;">You've been added to SAM AI!</h1>
            <p>Hello ${k},</p>
            <p>Good news! ${d.companyName} has added you to their SAM AI workspace. You can now access the platform with your existing account.</p>
            <div style="margin: 30px 0; text-align: center;">
              <a href="${b}" 
                 style="background-color: #10b981; color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; display: inline-block;">
                Access Your Workspace
              </a>
            </div>
            <p><strong>What you can do with SAM AI:</strong></p>
            <ul>
              <li>Chat with your AI sales assistant for personalized guidance</li>
              <li>Access comprehensive knowledge base</li>
              <li>Manage your lead pipeline efficiently</li>
              <li>Track campaign performance and analytics</li>
              <li>Collaborate with your team in shared workspaces</li>
            </ul>
            <p style="color: #666; font-size: 14px;">
              If you have any questions, please contact ${d.contactName} at ${d.contactEmail} or our support team.
            </p>
            <hr style="margin: 30px 0; border: none; border-top: 1px solid #eee;">
            <p style="color: #999; font-size: 12px;">
              You received this email because ${d.companyName} added you to their SAM AI workspace.
            </p>
          </div>
        `,i=await a.sendEmailSafely({To:e,Subject:g,HtmlBody:h,TextBody:c?`
            Welcome to SAM AI!
            ${f}
            
            Hello ${k},
            
            You've been invited to join SAM AI by ${d.companyName}. Your intelligent sales assistant is ready to help you streamline your sales process and boost productivity.
            
            Access your account at: ${b}/auth/callback
            
            What you can do with SAM AI:
            - Chat with your AI sales assistant for personalized guidance
            - Access comprehensive knowledge base  
            - Manage your lead pipeline efficiently
            - Track campaign performance and analytics
            - Collaborate with your team in shared workspaces
            
            If you have any questions, please contact ${d.contactName} at ${d.contactEmail} or our support team.
            
            This invitation was sent by ${d.companyName}.
          `:`
            You've been added to SAM AI!
            ${f}
            
            Hello ${k},
            
            Good news! ${d.companyName} has added you to their SAM AI workspace. You can now access the platform with your existing account.
            
            Access your workspace at: ${b}
            
            What you can do with SAM AI:
            - Chat with your AI sales assistant for personalized guidance
            - Access comprehensive knowledge base  
            - Manage your lead pipeline efficiently
            - Track campaign performance and analytics
            - Collaborate with your team in shared workspaces
            
            If you have any questions, please contact ${d.contactName} at ${d.contactEmail} or our support team.
            
            You received this email because ${d.companyName} added you to their SAM AI workspace.
          `});i.success?(z("EMAIL_SENT_SUCCESS",{messageId:i.messageId,email:e,originalEmail:j,isNewUser:c,bypassMode:w.o0}),console.log(`Custom ${c?"welcome":"notification"} email sent to ${e} from ${d.companyName}`)):(z("EMAIL_SEND_FAILURE",{error:i.error,email:e,originalEmail:j,suppressionInfo:i.suppressionInfo,canRetryAfterReactivation:i.canRetryAfterReactivation},"WARN"),i.suppressionInfo&&console.warn(`Email suppression detected for ${j}:`,{reason:i.suppressionInfo.SuppressionReason,origin:i.suppressionInfo.Origin,createdAt:i.suppressionInfo.CreatedAt}))}}catch(a){z("EMAIL_SYSTEM_ERROR",{error:a instanceof Error?{name:a.name,message:a.message,stack:a.stack}:a,email:j,company:o},"ERROR"),console.error("Failed to send custom welcome email:",a)}if(n||m){let a=n||m,c=x[o],d=new Date;if(d.setDate(d.getDate()+7),z("WORKSPACE_ASSIGNMENT_START",{targetWorkspaceId:a,userId:b.user?.id,email:j,role:p,company:o,inviteDataSource:b.source,isExistingUser:"existing_user"===b.source}),!b.user?.id)return z("WORKSPACE_ASSIGNMENT_FAILURE_NO_ID",{message:"No user ID available for workspace assignment",inviteDataStructure:{hasUser:!!b.user,userKeys:b.user?Object.keys(b.user):[],source:b.source},email:j,targetWorkspaceId:a,company:o,isExistingUser:!!s},"ERROR"),v.NextResponse.json({error:"User ID required for workspace assignment but not available. Please try again or contact technical support.",details:{email:j,workspace:a,errorCode:"MISSING_USER_ID_FOR_WORKSPACE",timestamp:new Date().toISOString()}},{status:500});z("MEMBERSHIP_CHECK_START",{targetWorkspaceId:a,userId:b.user.id,email:j});let{data:e,error:g}=await f.from("workspace_members").select("id, role, joined_at").eq("workspace_id",a).eq("user_id",b.user.id).maybeSingle();if(g)return z("MEMBERSHIP_CHECK_ERROR",{error:g,targetWorkspaceId:a,userId:b.user.id,email:j,errorMessage:g.message,errorCode:g.code||"unknown"},"ERROR"),v.NextResponse.json({error:"Failed to check existing membership",details:{message:g.message,workspace:a,email:j,errorCode:"MEMBERSHIP_CHECK_FAILED"}},{status:500});if(z("MEMBERSHIP_CHECK_COMPLETE",{existingMembershipFound:!!e,membershipData:e||null,userId:b.user.id,targetWorkspaceId:a}),e)z("MEMBERSHIP_ALREADY_EXISTS",{email:j,userId:b.user.id,targetWorkspaceId:a,existingRole:e.role,joinedAt:e.joined_at,message:"User already a member of workspace"});else{z("MEMBERSHIP_ASSIGNMENT_START",{email:j,userId:b.user.id,targetWorkspaceId:a,role:p,invitedBy:h.id}),z("ENSURING_USER_IN_USERS_TABLE",{userId:b.user.id});let{error:c}=await f.from("users").upsert({id:b.user.id,clerk_id:b.user.id,email:j,first_name:k||"",last_name:l||"",created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{onConflict:"id",ignoreDuplicates:!0});c&&(z("USER_SYNC_ERROR",{error:c,userId:b.user.id,email:j},"ERROR"),console.warn("⚠️ Continuing without user in users table, may cause foreign key issues"));let{error:d}=await f.from("workspace_members").insert({workspace_id:a,user_id:b.user.id,role:p,invited_by:h.id,joined_at:new Date().toISOString()});if(d)return z("MEMBERSHIP_ASSIGNMENT_CRITICAL_FAILURE",{error:d,email:j,userId:b.user.id,targetWorkspaceId:a,role:p,errorMessage:d.message,errorCode:d.code||"unknown",errorDetails:d.details||null},"ERROR"),v.NextResponse.json({error:"Failed to assign user to workspace - this is the core issue that was being debugged",details:{message:d.message,email:j,workspace:a,userId:b.user.id,errorCode:"WORKSPACE_ASSIGNMENT_FAILED",debugInfo:{supabaseError:d,inviteDataSource:b.source,timestamp:new Date().toISOString()}}},{status:500});z("MEMBERSHIP_ASSIGNMENT_SUCCESS",{email:j,userId:b.user.id,targetWorkspaceId:a,role:p,message:"User successfully assigned to workspace"})}z("INVITATION_RECORD_STORE_START",{targetWorkspaceId:a,email:j,role:p,company:o,expiresAt:d.toISOString(),invitedBy:h.id});let{error:i}=await f.from("workspace_invitations").insert({workspace_id:a,email:j,role:p,company:o,expires_at:d.toISOString(),invited_by:h.id});i?z("INVITATION_RECORD_STORE_WARNING",{error:i,email:j,targetWorkspaceId:a,errorMessage:i.message,note:"Membership succeeded but invitation record failed - user is still properly added to workspace"},"WARN"):z("INVITATION_RECORD_STORE_SUCCESS",{email:j,targetWorkspaceId:a,company:c.companyName,message:"User invited and invitation record stored successfully"})}let t=x[o],A="existing_user"===b.source,B=A?"User added to workspace successfully":"Invitation sent successfully";return z("INVITATION_PROCESS_COMPLETE",{email:j,userId:b.user?.id,company:t.companyName,isExistingUser:A,inviteDataSource:b.source,workspaceAssigned:!!(n||m),successMessage:B}),v.NextResponse.json({message:B,company:t.companyName,isNewUser:!A,user:{id:b.user?.id,email:b.user?.email,invited_at:b.user?.invited_at},debug:{source:b.source,timestamp:new Date().toISOString()}})}catch(c){let b="unknown";try{let c=await a.clone().json();b=c?.email||"unknown"}catch{}return z("UNEXPECTED_SERVER_ERROR",{error:c instanceof Error?{name:c.name,message:c.message,stack:c.stack}:c,email:b,timestamp:new Date().toISOString()},"ERROR"),v.NextResponse.json({error:"Internal server error",details:{timestamp:new Date().toISOString(),errorCode:"UNEXPECTED_ERROR",message:"An unexpected error occurred. Please contact technical support."}},{status:500})}}let B=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/admin/invite-user/route",pathname:"/api/admin/invite-user",filename:"route",bundlePath:"app/api/admin/invite-user/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"/Users/tvonlinz/Dev_Master/InnovareAI/Sam-New-Sep-7/app/api/admin/invite-user/route.ts",nextConfigOutput:"standalone",userland:d}),{workAsyncStorage:C,workUnitAsyncStorage:D,serverHooks:E}=B;function F(){return(0,g.patchFetch)({workAsyncStorage:C,workUnitAsyncStorage:D})}async function G(a,b,c){var d;let e="/api/admin/invite-user/route";"/index"===e&&(e="/");let g=await B.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:z,isOnDemandRevalidate:A,revalidateOnlyGenerated:C,resolvedPathname:D}=g,E=(0,j.normalizeAppPath)(e),F=!!(y.dynamicRoutes[E]||y.routes[D]);if(F&&!x){let a=!!y.routes[D],b=y.dynamicRoutes[E];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let G=null;!F||B.isDev||x||(G="/index"===(G=D)?"/":G);let H=!0===B.isDev||!F,I=F&&!H,J=a.method||"GET",K=(0,i.getTracer)(),L=K.getActiveScopeSpan(),M={params:v,prerenderManifest:y,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:H,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:I,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>B.onRequestError(a,b,d,z)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>B.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=K.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${J} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${J} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&A&&C&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!F)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await B.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})},z),b}},l=await B.handleResponse({req:a,nextConfig:w,cacheKey:G,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:C,responseGenerator:k,waitUntil:c.waitUntil});if(!F)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&F||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await g(L):await K.withPropagatedContext(a.headers,()=>K.trace(m.BaseServerSpan.handleRequest,{spanName:`${J} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":J,"http.target":a.url}},g))}catch(b){if(L||b instanceof s.NoFallbackError||await B.onRequestError(a,b,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})}),F)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}},63033:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:a=>{"use strict";a.exports=require("zlib")},78335:()=>{},79551:a=>{"use strict";a.exports=require("url")},81630:a=>{"use strict";a.exports=require("http")},83997:a=>{"use strict";a.exports=require("tty")},86439:a=>{"use strict";a.exports=require("next/dist/shared/lib/no-fallback-error.external")},94735:a=>{"use strict";a.exports=require("events")},96487:()=>{}};var b=require("../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[4586,1692,4842,3333],()=>b(b.s=61688));module.exports=c})();