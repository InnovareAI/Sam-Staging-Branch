(()=>{var a={};a.id=507,a.ids=[507],a.modules={261:a=>{"use strict";a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{"use strict";a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:a=>{"use strict";a.exports=require("punycode")},18389:(a,b,c)=>{"use strict";let d,e,f,g;c.r(b),c.d(b,{handler:()=>dF,patchFetch:()=>dE,routeModule:()=>dA,serverHooks:()=>dD,workAsyncStorage:()=>dB,workUnitAsyncStorage:()=>dC});var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,aa,ab,ac,ad,ae,af,ag,ah,ai,aj,ak,al,am,an,ao,ap,aq,ar,as,at,au,av,aw,ax,ay,az,aA,aB,aC,aD={};c.r(aD),c.d(aD,{GET:()=>dy,POST:()=>dz});var aE=c(95736),aF=c(9117),aG=c(4044),aH=c(39326),aI=c(32324),aJ=c(261),aK=c(54290),aL=c(85328),aM=c(38928),aN=c(46595),aO=c(3421),aP=c(17679),aQ=c(41681),aR=c(63446),aS=c(86439),aT=c(51356),aU=c(50698),aV=c(10641),aW=c(82461);let aX="https://latxadqrvrrrcvkktrog.supabase.co",aY=process.env.SUPABASE_SERVICE_ROLE_KEY||"";(0,aW.UU)(aX,"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxhdHhhZHFydnJycmN2a2t0cm9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2OTk5ODYsImV4cCI6MjA2ODI3NTk4Nn0.3WkAgXpk_MyQioVf_SED9O_ArjcT9nH0uy9we2okftE");let aZ=()=>{if(!aY)throw Error("SUPABASE_SERVICE_ROLE_KEY is not configured");return(0,aW.UU)(aX,aY,{auth:{autoRefreshToken:!1,persistSession:!1}})};function a$(a,b,c,d,e){if("m"===d)throw TypeError("Private method is not writable");if("a"===d&&!e)throw TypeError("Private accessor was defined without a setter");if("function"==typeof b?a!==b||!e:!b.has(a))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===d?e.call(a,c):e?e.value=c:b.set(a,c),c}function a_(a,b,c,d){if("a"===c&&!d)throw TypeError("Private accessor was defined without a getter");if("function"==typeof b?a!==b||!d:!b.has(a))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===c?d:"a"===c?d.call(a):d?d.value:b.get(a)}let a0=function(){let{crypto:a}=globalThis;if(a?.randomUUID)return a0=a.randomUUID.bind(a),a.randomUUID();let b=new Uint8Array(1),c=a?()=>a.getRandomValues(b)[0]:()=>255*Math.random()&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,a=>(a^c()&15>>a/4).toString(16))};function a1(a){return"object"==typeof a&&null!==a&&("name"in a&&"AbortError"===a.name||"message"in a&&String(a.message).includes("FetchRequestCanceledException"))}let a2=a=>{if(a instanceof Error)return a;if("object"==typeof a&&null!==a){try{if("[object Error]"===Object.prototype.toString.call(a)){let b=Error(a.message,a.cause?{cause:a.cause}:{});return a.stack&&(b.stack=a.stack),a.cause&&!b.cause&&(b.cause=a.cause),a.name&&(b.name=a.name),b}}catch{}try{return Error(JSON.stringify(a))}catch{}}return Error(a)};class a3 extends Error{}class a4 extends a3{constructor(a,b,c,d){super(`${a4.makeMessage(a,b,c)}`),this.status=a,this.headers=d,this.requestID=d?.get("x-request-id"),this.error=b,this.code=b?.code,this.param=b?.param,this.type=b?.type}static makeMessage(a,b,c){let d=b?.message?"string"==typeof b.message?b.message:JSON.stringify(b.message):b?JSON.stringify(b):c;return a&&d?`${a} ${d}`:a?`${a} status code (no body)`:d||"(no status code or body)"}static generate(a,b,c,d){if(!a||!d)return new a6({message:c,cause:a2(b)});let e=b?.error;return 400===a?new a8(a,e,c,d):401===a?new a9(a,e,c,d):403===a?new ba(a,e,c,d):404===a?new bb(a,e,c,d):409===a?new bc(a,e,c,d):422===a?new bd(a,e,c,d):429===a?new be(a,e,c,d):a>=500?new bf(a,e,c,d):new a4(a,e,c,d)}}class a5 extends a4{constructor({message:a}={}){super(void 0,void 0,a||"Request was aborted.",void 0)}}class a6 extends a4{constructor({message:a,cause:b}){super(void 0,void 0,a||"Connection error.",void 0),b&&(this.cause=b)}}class a7 extends a6{constructor({message:a}={}){super({message:a??"Request timed out."})}}class a8 extends a4{}class a9 extends a4{}class ba extends a4{}class bb extends a4{}class bc extends a4{}class bd extends a4{}class be extends a4{}class bf extends a4{}class bg extends a3{constructor(){super("Could not parse response content as the length limit was reached")}}class bh extends a3{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}class bi extends Error{constructor(a){super(a)}}let bj=/^[a-z][a-z0-9+.-]*:/i,bk=a=>(bk=Array.isArray)(a),bl=bk;function bm(a){return"object"!=typeof a?{}:a??{}}function bn(a){return null!=a&&"object"==typeof a&&!Array.isArray(a)}let bo=a=>new Promise(b=>setTimeout(b,a)),bp="5.19.1",bq=a=>"x32"===a?"x32":"x86_64"===a||"x64"===a?"x64":"arm"===a?"arm":"aarch64"===a||"arm64"===a?"arm64":a?`other:${a}`:"unknown",br=a=>(a=a.toLowerCase()).includes("ios")?"iOS":"android"===a?"Android":"darwin"===a?"MacOS":"win32"===a?"Windows":"freebsd"===a?"FreeBSD":"openbsd"===a?"OpenBSD":"linux"===a?"Linux":a?`Other:${a}`:"Unknown";function bs(...a){let b=globalThis.ReadableStream;if(void 0===b)throw Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new b(...a)}function bt(a){let b=Symbol.asyncIterator in a?a[Symbol.asyncIterator]():a[Symbol.iterator]();return bs({start(){},async pull(a){let{done:c,value:d}=await b.next();c?a.close():a.enqueue(d)},async cancel(){await b.return?.()}})}function bu(a){if(a[Symbol.asyncIterator])return a;let b=a.getReader();return{async next(){try{let a=await b.read();return a?.done&&b.releaseLock(),a}catch(a){throw b.releaseLock(),a}},async return(){let a=b.cancel();return b.releaseLock(),await a,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}async function bv(a){if(null===a||"object"!=typeof a)return;if(a[Symbol.asyncIterator])return void await a[Symbol.asyncIterator]().return?.();let b=a.getReader(),c=b.cancel();b.releaseLock(),await c}let bw=({headers:a,body:b})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(b)}),bx="RFC3986",by=a=>String(a),bz={RFC1738:a=>String(a).replace(/%20/g,"+"),RFC3986:by},bA=(a,b)=>(bA=Object.hasOwn??Function.prototype.call.bind(Object.prototype.hasOwnProperty))(a,b),bB=(()=>{let a=[];for(let b=0;b<256;++b)a.push("%"+((b<16?"0":"")+b.toString(16)).toUpperCase());return a})();function bC(a,b){if(bk(a)){let c=[];for(let d=0;d<a.length;d+=1)c.push(b(a[d]));return c}return b(a)}let bD={brackets:a=>String(a)+"[]",comma:"comma",indices:(a,b)=>String(a)+"["+b+"]",repeat:a=>String(a)},bE=function(a,b){Array.prototype.push.apply(a,bk(b)?b:[b])},bF={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:(a,b,c,d,e)=>{if(0===a.length)return a;let f=a;if("symbol"==typeof a?f=Symbol.prototype.toString.call(a):"string"!=typeof a&&(f=String(a)),"iso-8859-1"===c)return escape(f).replace(/%u[0-9a-f]{4}/gi,function(a){return"%26%23"+parseInt(a.slice(2),16)+"%3B"});let g="";for(let a=0;a<f.length;a+=1024){let b=f.length>=1024?f.slice(a,a+1024):f,c=[];for(let a=0;a<b.length;++a){let d=b.charCodeAt(a);if(45===d||46===d||95===d||126===d||d>=48&&d<=57||d>=65&&d<=90||d>=97&&d<=122||"RFC1738"===e&&(40===d||41===d)){c[c.length]=b.charAt(a);continue}if(d<128){c[c.length]=bB[d];continue}if(d<2048){c[c.length]=bB[192|d>>6]+bB[128|63&d];continue}if(d<55296||d>=57344){c[c.length]=bB[224|d>>12]+bB[128|d>>6&63]+bB[128|63&d];continue}a+=1,d=65536+((1023&d)<<10|1023&b.charCodeAt(a)),c[c.length]=bB[240|d>>18]+bB[128|d>>12&63]+bB[128|d>>6&63]+bB[128|63&d]}g+=c.join("")}return g},encodeValuesOnly:!1,format:bx,formatter:by,indices:!1,serializeDate:a=>(e??(e=Function.prototype.call.bind(Date.prototype.toISOString)))(a),skipNulls:!1,strictNullHandling:!1},bG={};function bH(a){let b;return(f??(f=(b=new globalThis.TextEncoder).encode.bind(b)))(a)}function bI(a){let b;return(g??(g=(b=new globalThis.TextDecoder).decode.bind(b)))(a)}class bJ{constructor(){h.set(this,void 0),i.set(this,void 0),a$(this,h,new Uint8Array,"f"),a$(this,i,null,"f")}decode(a){let b;if(null==a)return[];let c=a instanceof ArrayBuffer?new Uint8Array(a):"string"==typeof a?bH(a):a;a$(this,h,function(a){let b=0;for(let c of a)b+=c.length;let c=new Uint8Array(b),d=0;for(let b of a)c.set(b,d),d+=b.length;return c}([a_(this,h,"f"),c]),"f");let d=[];for(;null!=(b=function(a,b){for(let c=b??0;c<a.length;c++){if(10===a[c])return{preceding:c,index:c+1,carriage:!1};if(13===a[c])return{preceding:c,index:c+1,carriage:!0}}return null}(a_(this,h,"f"),a_(this,i,"f")));){if(b.carriage&&null==a_(this,i,"f")){a$(this,i,b.index,"f");continue}if(null!=a_(this,i,"f")&&(b.index!==a_(this,i,"f")+1||b.carriage)){d.push(bI(a_(this,h,"f").subarray(0,a_(this,i,"f")-1))),a$(this,h,a_(this,h,"f").subarray(a_(this,i,"f")),"f"),a$(this,i,null,"f");continue}let a=null!==a_(this,i,"f")?b.preceding-1:b.preceding,c=bI(a_(this,h,"f").subarray(0,a));d.push(c),a$(this,h,a_(this,h,"f").subarray(b.index),"f"),a$(this,i,null,"f")}return d}flush(){return a_(this,h,"f").length?this.decode("\n"):[]}}h=new WeakMap,i=new WeakMap,bJ.NEWLINE_CHARS=new Set(["\n","\r"]),bJ.NEWLINE_REGEXP=/\r\n|[\n\r]/g;let bK={off:0,error:200,warn:300,info:400,debug:500},bL=(a,b,c)=>{if(a){if(Object.prototype.hasOwnProperty.call(bK,a))return a;bQ(c).warn(`${b} was set to ${JSON.stringify(a)}, expected one of ${JSON.stringify(Object.keys(bK))}`)}};function bM(){}function bN(a,b,c){return!b||bK[a]>bK[c]?bM:b[a].bind(b)}let bO={error:bM,warn:bM,info:bM,debug:bM},bP=new WeakMap;function bQ(a){let b=a.logger,c=a.logLevel??"off";if(!b)return bO;let d=bP.get(b);if(d&&d[0]===c)return d[1];let e={error:bN("error",b,c),warn:bN("warn",b,c),info:bN("info",b,c),debug:bN("debug",b,c)};return bP.set(b,[c,e]),e}let bR=a=>(a.options&&(a.options={...a.options},delete a.options.headers),a.headers&&(a.headers=Object.fromEntries((a.headers instanceof Headers?[...a.headers]:Object.entries(a.headers)).map(([a,b])=>[a,"authorization"===a.toLowerCase()||"cookie"===a.toLowerCase()||"set-cookie"===a.toLowerCase()?"***":b]))),"retryOfRequestLogID"in a&&(a.retryOfRequestLogID&&(a.retryOf=a.retryOfRequestLogID),delete a.retryOfRequestLogID),a);class bS{constructor(a,b,c){this.iterator=a,j.set(this,void 0),this.controller=b,a$(this,j,c,"f")}static fromSSEResponse(a,b,c){let d=!1,e=c?bQ(c):console;async function*f(){if(d)throw new a3("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");d=!0;let c=!1;try{for await(let d of bT(a,b))if(!c){if(d.data.startsWith("[DONE]")){c=!0;continue}if(null!==d.event&&d.event.startsWith("thread.")){let a;try{a=JSON.parse(d.data)}catch(a){throw console.error("Could not parse message into JSON:",d.data),console.error("From chunk:",d.raw),a}if("error"==d.event)throw new a4(void 0,a.error,a.message,void 0);yield{event:d.event,data:a}}else{let b;try{b=JSON.parse(d.data)}catch(a){throw e.error("Could not parse message into JSON:",d.data),e.error("From chunk:",d.raw),a}if(b&&b.error)throw new a4(void 0,b.error,void 0,a.headers);yield b}}c=!0}catch(a){if(a1(a))return;throw a}finally{c||b.abort()}}return new bS(f,b,c)}static fromReadableStream(a,b,c){let d=!1;async function*e(){let b=new bJ;for await(let c of bu(a))for(let a of b.decode(c))yield a;for(let a of b.flush())yield a}return new bS(async function*(){if(d)throw new a3("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");d=!0;let a=!1;try{for await(let b of e())!a&&b&&(yield JSON.parse(b));a=!0}catch(a){if(a1(a))return;throw a}finally{a||b.abort()}},b,c)}[(j=new WeakMap,Symbol.asyncIterator)](){return this.iterator()}tee(){let a=[],b=[],c=this.iterator(),d=d=>({next:()=>{if(0===d.length){let d=c.next();a.push(d),b.push(d)}return d.shift()}});return[new bS(()=>d(a),this.controller,a_(this,j,"f")),new bS(()=>d(b),this.controller,a_(this,j,"f"))]}toReadableStream(){let a,b=this;return bs({async start(){a=b[Symbol.asyncIterator]()},async pull(b){try{let{value:c,done:d}=await a.next();if(d)return b.close();let e=bH(JSON.stringify(c)+"\n");b.enqueue(e)}catch(a){b.error(a)}},async cancel(){await a.return?.()}})}}async function*bT(a,b){if(!a.body){if(b.abort(),void 0!==globalThis.navigator&&"ReactNative"===globalThis.navigator.product)throw new a3("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api");throw new a3("Attempted to iterate over a response with no body")}let c=new bV,d=new bJ;for await(let b of bU(bu(a.body)))for(let a of d.decode(b)){let b=c.decode(a);b&&(yield b)}for(let a of d.flush()){let b=c.decode(a);b&&(yield b)}}async function*bU(a){let b=new Uint8Array;for await(let c of a){let a;if(null==c)continue;let d=c instanceof ArrayBuffer?new Uint8Array(c):"string"==typeof c?bH(c):c,e=new Uint8Array(b.length+d.length);for(e.set(b),e.set(d,b.length),b=e;-1!==(a=function(a){for(let b=0;b<a.length-1;b++){if(10===a[b]&&10===a[b+1]||13===a[b]&&13===a[b+1])return b+2;if(13===a[b]&&10===a[b+1]&&b+3<a.length&&13===a[b+2]&&10===a[b+3])return b+4}return -1}(b));)yield b.slice(0,a),b=b.slice(a)}b.length>0&&(yield b)}class bV{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(a){if(a.endsWith("\r")&&(a=a.substring(0,a.length-1)),!a){if(!this.event&&!this.data.length)return null;let a={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],a}if(this.chunks.push(a),a.startsWith(":"))return null;let[b,c,d]=function(a,b){let c=a.indexOf(":");return -1!==c?[a.substring(0,c),b,a.substring(c+b.length)]:[a,"",""]}(a,":");return d.startsWith(" ")&&(d=d.substring(1)),"event"===b?this.event=d:"data"===b&&this.data.push(d),null}}async function bW(a,b){let{response:c,requestLogID:d,retryOfRequestLogID:e,startTime:f}=b,g=await (async()=>{if(b.options.stream)return(bQ(a).debug("response",c.status,c.url,c.headers,c.body),b.options.__streamClass)?b.options.__streamClass.fromSSEResponse(c,b.controller,a):bS.fromSSEResponse(c,b.controller,a);if(204===c.status)return null;if(b.options.__binaryResponse)return c;let d=c.headers.get("content-type"),e=d?.split(";")[0]?.trim();return e?.includes("application/json")||e?.endsWith("+json")?bX(await c.json(),c):await c.text()})();return bQ(a).debug(`[${d}] response parsed`,bR({retryOfRequestLogID:e,url:c.url,status:c.status,body:g,durationMs:Date.now()-f})),g}function bX(a,b){return!a||"object"!=typeof a||Array.isArray(a)?a:Object.defineProperty(a,"_request_id",{value:b.headers.get("x-request-id"),enumerable:!1})}class bY extends Promise{constructor(a,b,c=bW){super(a=>{a(null)}),this.responsePromise=b,this.parseResponse=c,k.set(this,void 0),a$(this,k,a,"f")}_thenUnwrap(a){return new bY(a_(this,k,"f"),this.responsePromise,async(b,c)=>bX(a(await this.parseResponse(b,c),c),c.response))}asResponse(){return this.responsePromise.then(a=>a.response)}async withResponse(){let[a,b]=await Promise.all([this.parse(),this.asResponse()]);return{data:a,response:b,request_id:b.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(a=>this.parseResponse(a_(this,k,"f"),a))),this.parsedPromise}then(a,b){return this.parse().then(a,b)}catch(a){return this.parse().catch(a)}finally(a){return this.parse().finally(a)}}k=new WeakMap;class bZ{constructor(a,b,c,d){l.set(this,void 0),a$(this,l,a,"f"),this.options=d,this.response=b,this.body=c}hasNextPage(){return!!this.getPaginatedItems().length&&null!=this.nextPageRequestOptions()}async getNextPage(){let a=this.nextPageRequestOptions();if(!a)throw new a3("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await a_(this,l,"f").requestAPIList(this.constructor,a)}async *iterPages(){let a=this;for(yield a;a.hasNextPage();)a=await a.getNextPage(),yield a}async *[(l=new WeakMap,Symbol.asyncIterator)](){for await(let a of this.iterPages())for(let b of a.getPaginatedItems())yield b}}class b$ extends bY{constructor(a,b,c){super(a,b,async(a,b)=>new c(a,b.response,await bW(a,b),b.options))}async *[Symbol.asyncIterator](){for await(let a of(await this))yield a}}class b_ extends bZ{constructor(a,b,c,d){super(a,b,c,d),this.data=c.data||[],this.object=c.object}getPaginatedItems(){return this.data??[]}nextPageRequestOptions(){return null}}class b0 extends bZ{constructor(a,b,c,d){super(a,b,c,d),this.data=c.data||[],this.has_more=c.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return!1!==this.has_more&&super.hasNextPage()}nextPageRequestOptions(){let a=this.getPaginatedItems(),b=a[a.length-1]?.id;return b?{...this.options,query:{...bm(this.options.query),after:b}}:null}}class b1 extends bZ{constructor(a,b,c,d){super(a,b,c,d),this.data=c.data||[],this.has_more=c.has_more||!1,this.last_id=c.last_id||""}getPaginatedItems(){return this.data??[]}hasNextPage(){return!1!==this.has_more&&super.hasNextPage()}nextPageRequestOptions(){let a=this.last_id;return a?{...this.options,query:{...bm(this.options.query),after:a}}:null}}let b2=()=>{if("undefined"==typeof File){let{process:a}=globalThis;throw Error("`File` is not defined as a global, which is required for file uploads."+("string"==typeof a?.versions?.node&&20>parseInt(a.versions.node.split("."))?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function b3(a,b,c){return b2(),new File(a,b??"unknown_file",c)}function b4(a){return("object"==typeof a&&null!==a&&("name"in a&&a.name&&String(a.name)||"url"in a&&a.url&&String(a.url)||"filename"in a&&a.filename&&String(a.filename)||"path"in a&&a.path&&String(a.path))||"").split(/[\\/]/).pop()||void 0}let b5=a=>null!=a&&"object"==typeof a&&"function"==typeof a[Symbol.asyncIterator],b6=async(a,b)=>({...a,body:await b8(a.body,b)}),b7=new WeakMap,b8=async(a,b)=>{if(!await function(a){let b="function"==typeof a?a:a.fetch,c=b7.get(b);if(c)return c;let d=(async()=>{try{let a="Response"in b?b.Response:(await b("data:,")).constructor,c=new FormData;if(c.toString()===await new a(c).text())return!1;return!0}catch{return!0}})();return b7.set(b,d),d}(b))throw TypeError("The provided fetch function does not support file uploads with the current global FormData class.");let c=new FormData;return await Promise.all(Object.entries(a||{}).map(([a,b])=>cb(c,a,b))),c},b9=a=>a instanceof Blob&&"name"in a,ca=a=>{if((a=>"object"==typeof a&&null!==a&&(a instanceof Response||b5(a)||b9(a)))(a))return!0;if(Array.isArray(a))return a.some(ca);if(a&&"object"==typeof a){for(let b in a)if(ca(a[b]))return!0}return!1},cb=async(a,b,c)=>{if(void 0!==c){if(null==c)throw TypeError(`Received null for "${b}"; to pass null in FormData, you must use the string 'null'`);if("string"==typeof c||"number"==typeof c||"boolean"==typeof c)a.append(b,String(c));else if(c instanceof Response)a.append(b,b3([await c.blob()],b4(c)));else if(b5(c))a.append(b,b3([await new Response(bt(c)).blob()],b4(c)));else if(b9(c))a.append(b,c,b4(c));else if(Array.isArray(c))await Promise.all(c.map(c=>cb(a,b+"[]",c)));else if("object"==typeof c)await Promise.all(Object.entries(c).map(([c,d])=>cb(a,`${b}[${c}]`,d)));else throw TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${c} instead`)}},cc=a=>null!=a&&"object"==typeof a&&"number"==typeof a.size&&"string"==typeof a.type&&"function"==typeof a.text&&"function"==typeof a.slice&&"function"==typeof a.arrayBuffer;async function cd(a,b,c){let d,e;if(b2(),null!=(d=a=await a)&&"object"==typeof d&&"string"==typeof d.name&&"number"==typeof d.lastModified&&cc(d))return a instanceof File?a:b3([await a.arrayBuffer()],a.name);if(null!=(e=a)&&"object"==typeof e&&"string"==typeof e.url&&"function"==typeof e.blob){let d=await a.blob();return b||(b=new URL(a.url).pathname.split(/[\\/]/).pop()),b3(await ce(d),b,c)}let f=await ce(a);if(b||(b=b4(a)),!c?.type){let a=f.find(a=>"object"==typeof a&&"type"in a&&a.type);"string"==typeof a&&(c={...c,type:a})}return b3(f,b,c)}async function ce(a){let b=[];if("string"==typeof a||ArrayBuffer.isView(a)||a instanceof ArrayBuffer)b.push(a);else if(cc(a))b.push(a instanceof Blob?a:await a.arrayBuffer());else if(b5(a))for await(let c of a)b.push(...await ce(c));else{let b=a?.constructor?.name;throw Error(`Unexpected data type: ${typeof a}${b?`; constructor: ${b}`:""}${function(a){if("object"!=typeof a||null===a)return"";let b=Object.getOwnPropertyNames(a);return`; props: [${b.map(a=>`"${a}"`).join(", ")}]`}(a)}`)}return b}class cf{constructor(a){this._client=a}}function cg(a){return a.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}let ch=Object.freeze(Object.create(null)),ci=((a=cg)=>function(b,...c){let d;if(1===b.length)return b[0];let e=!1,f=[],g=b.reduce((b,d,g)=>{/[?#]/.test(d)&&(e=!0);let h=c[g],i=(e?encodeURIComponent:a)(""+h);return g!==c.length&&(null==h||"object"==typeof h&&h.toString===Object.getPrototypeOf(Object.getPrototypeOf(h.hasOwnProperty??ch)??ch)?.toString)&&(i=h+"",f.push({start:b.length+d.length,length:i.length,error:`Value of type ${Object.prototype.toString.call(h).slice(8,-1)} is not a valid path parameter`})),b+d+(g===c.length?"":i)},""),h=g.split(/[?#]/,1)[0],i=/(?<=^|\/)(?:\.|%2e){1,2}(?=\/|$)/gi;for(;null!==(d=i.exec(h));)f.push({start:d.index,length:d[0].length,error:`Value "${d[0]}" can't be safely passed as a path parameter`});if(f.sort((a,b)=>a.start-b.start),f.length>0){let a=0,b=f.reduce((b,c)=>{let d=" ".repeat(c.start-a),e="^".repeat(c.length);return a=c.start+c.length,b+d+e},"");throw new a3(`Path parameters result in path with invalid segments:
${f.map(a=>a.error).join("\n")}
${g}
${b}`)}return g})(cg);class cj extends cf{list(a,b={},c){return this._client.getAPIList(ci`/chat/completions/${a}/messages`,b0,{query:b,...c})}}function ck(a){return void 0!==a&&"function"in a&&void 0!==a.function}function cl(a){return a?.$brand==="auto-parseable-response-format"}function cm(a){return a?.$brand==="auto-parseable-tool"}function cn(a,b){let c=a.choices.map(a=>{var c,d;if("length"===a.finish_reason)throw new bg;if("content_filter"===a.finish_reason)throw new bh;return cp(a.message.tool_calls),{...a,message:{...a.message,...a.message.tool_calls?{tool_calls:a.message.tool_calls?.map(a=>(function(a,b){let c=a.tools?.find(a=>ck(a)&&a.function?.name===b.function.name);return{...b,function:{...b.function,parsed_arguments:cm(c)?c.$parseRaw(b.function.arguments):c?.function.strict?JSON.parse(b.function.arguments):null}}})(b,a))??void 0}:void 0,parsed:a.message.content&&!a.message.refusal?(c=b,d=a.message.content,c.response_format?.type!=="json_schema"?null:c.response_format?.type==="json_schema"?"$parseRaw"in c.response_format?c.response_format.$parseRaw(d):JSON.parse(d):null):null}}});return{...a,choices:c}}function co(a){return!!cl(a.response_format)||(a.tools?.some(a=>cm(a)||"function"===a.type&&!0===a.function.strict)??!1)}function cp(a){for(let b of a||[])if("function"!==b.type)throw new a3(`Currently only \`function\` tool calls are supported; Received \`${b.type}\``)}let cq=a=>a?.role==="assistant",cr=a=>a?.role==="tool";class cs{constructor(){m.add(this),this.controller=new AbortController,n.set(this,void 0),o.set(this,()=>{}),p.set(this,()=>{}),q.set(this,void 0),r.set(this,()=>{}),s.set(this,()=>{}),t.set(this,{}),u.set(this,!1),v.set(this,!1),w.set(this,!1),x.set(this,!1),a$(this,n,new Promise((a,b)=>{a$(this,o,a,"f"),a$(this,p,b,"f")}),"f"),a$(this,q,new Promise((a,b)=>{a$(this,r,a,"f"),a$(this,s,b,"f")}),"f"),a_(this,n,"f").catch(()=>{}),a_(this,q,"f").catch(()=>{})}_run(a){setTimeout(()=>{a().then(()=>{this._emitFinal(),this._emit("end")},a_(this,m,"m",y).bind(this))},0)}_connected(){this.ended||(a_(this,o,"f").call(this),this._emit("connect"))}get ended(){return a_(this,u,"f")}get errored(){return a_(this,v,"f")}get aborted(){return a_(this,w,"f")}abort(){this.controller.abort()}on(a,b){return(a_(this,t,"f")[a]||(a_(this,t,"f")[a]=[])).push({listener:b}),this}off(a,b){let c=a_(this,t,"f")[a];if(!c)return this;let d=c.findIndex(a=>a.listener===b);return d>=0&&c.splice(d,1),this}once(a,b){return(a_(this,t,"f")[a]||(a_(this,t,"f")[a]=[])).push({listener:b,once:!0}),this}emitted(a){return new Promise((b,c)=>{a$(this,x,!0,"f"),"error"!==a&&this.once("error",c),this.once(a,b)})}async done(){a$(this,x,!0,"f"),await a_(this,q,"f")}_emit(a,...b){if(a_(this,u,"f"))return;"end"===a&&(a$(this,u,!0,"f"),a_(this,r,"f").call(this));let c=a_(this,t,"f")[a];if(c&&(a_(this,t,"f")[a]=c.filter(a=>!a.once),c.forEach(({listener:a})=>a(...b))),"abort"===a){let a=b[0];a_(this,x,"f")||c?.length||Promise.reject(a),a_(this,p,"f").call(this,a),a_(this,s,"f").call(this,a),this._emit("end");return}if("error"===a){let a=b[0];a_(this,x,"f")||c?.length||Promise.reject(a),a_(this,p,"f").call(this,a),a_(this,s,"f").call(this,a),this._emit("end")}}_emitFinal(){}}n=new WeakMap,o=new WeakMap,p=new WeakMap,q=new WeakMap,r=new WeakMap,s=new WeakMap,t=new WeakMap,u=new WeakMap,v=new WeakMap,w=new WeakMap,x=new WeakMap,m=new WeakSet,y=function(a){if(a$(this,v,!0,"f"),a instanceof Error&&"AbortError"===a.name&&(a=new a5),a instanceof a5)return a$(this,w,!0,"f"),this._emit("abort",a);if(a instanceof a3)return this._emit("error",a);if(a instanceof Error){let b=new a3(a.message);return b.cause=a,this._emit("error",b)}return this._emit("error",new a3(String(a)))};class ct extends cs{constructor(){super(...arguments),z.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(a){this._chatCompletions.push(a),this._emit("chatCompletion",a);let b=a.choices[0]?.message;return b&&this._addMessage(b),a}_addMessage(a,b=!0){if("content"in a||(a.content=null),this.messages.push(a),b){if(this._emit("message",a),cr(a)&&a.content)this._emit("functionToolCallResult",a.content);else if(cq(a)&&a.tool_calls)for(let b of a.tool_calls)"function"===b.type&&this._emit("functionToolCall",b.function)}}async finalChatCompletion(){await this.done();let a=this._chatCompletions[this._chatCompletions.length-1];if(!a)throw new a3("stream ended without producing a ChatCompletion");return a}async finalContent(){return await this.done(),a_(this,z,"m",A).call(this)}async finalMessage(){return await this.done(),a_(this,z,"m",B).call(this)}async finalFunctionToolCall(){return await this.done(),a_(this,z,"m",C).call(this)}async finalFunctionToolCallResult(){return await this.done(),a_(this,z,"m",D).call(this)}async totalUsage(){return await this.done(),a_(this,z,"m",E).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){let a=this._chatCompletions[this._chatCompletions.length-1];a&&this._emit("finalChatCompletion",a);let b=a_(this,z,"m",B).call(this);b&&this._emit("finalMessage",b);let c=a_(this,z,"m",A).call(this);c&&this._emit("finalContent",c);let d=a_(this,z,"m",C).call(this);d&&this._emit("finalFunctionToolCall",d);let e=a_(this,z,"m",D).call(this);null!=e&&this._emit("finalFunctionToolCallResult",e),this._chatCompletions.some(a=>a.usage)&&this._emit("totalUsage",a_(this,z,"m",E).call(this))}async _createChatCompletion(a,b,c){let d=c?.signal;d&&(d.aborted&&this.controller.abort(),d.addEventListener("abort",()=>this.controller.abort())),a_(this,z,"m",F).call(this,b);let e=await a.chat.completions.create({...b,stream:!1},{...c,signal:this.controller.signal});return this._connected(),this._addChatCompletion(cn(e,b))}async _runChatCompletion(a,b,c){for(let a of b.messages)this._addMessage(a,!1);return await this._createChatCompletion(a,b,c)}async _runTools(a,b,c){let d="tool",{tool_choice:e="auto",stream:f,...g}=b,h="string"!=typeof e&&"function"===e.type&&e?.function?.name,{maxChatCompletions:i=10}=c||{},j=b.tools.map(a=>{if(cm(a)){if(!a.$callback)throw new a3("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:a.$callback,name:a.function.name,description:a.function.description||"",parameters:a.function.parameters,parse:a.$parseRaw,strict:!0}}}return a}),k={};for(let a of j)"function"===a.type&&(k[a.function.name||a.function.function.name]=a.function);let l="tools"in b?j.map(a=>"function"===a.type?{type:"function",function:{name:a.function.name||a.function.function.name,parameters:a.function.parameters,description:a.function.description,strict:a.function.strict}}:a):void 0;for(let a of b.messages)this._addMessage(a,!1);for(let b=0;b<i;++b){let b=await this._createChatCompletion(a,{...g,tool_choice:e,tools:l,messages:[...this.messages]},c),f=b.choices[0]?.message;if(!f)throw new a3("missing message in ChatCompletion response");if(!f.tool_calls?.length)break;for(let a of f.tool_calls){let b;if("function"!==a.type)continue;let c=a.id,{name:e,arguments:f}=a.function,g=k[e];if(g){if(h&&h!==e){let a=`Invalid tool_call: ${JSON.stringify(e)}. ${JSON.stringify(h)} requested. Please try again`;this._addMessage({role:d,tool_call_id:c,content:a});continue}}else{let a=`Invalid tool_call: ${JSON.stringify(e)}. Available options are: ${Object.keys(k).map(a=>JSON.stringify(a)).join(", ")}. Please try again`;this._addMessage({role:d,tool_call_id:c,content:a});continue}try{b="function"==typeof g.parse?await g.parse(f):f}catch(b){let a=b instanceof Error?b.message:String(b);this._addMessage({role:d,tool_call_id:c,content:a});continue}let i=await g.function(b,this),j=a_(this,z,"m",G).call(this,i);if(this._addMessage({role:d,tool_call_id:c,content:j}),h)return}}}}z=new WeakSet,A=function(){return a_(this,z,"m",B).call(this).content??null},B=function(){let a=this.messages.length;for(;a-- >0;){let b=this.messages[a];if(cq(b))return{...b,content:b.content??null,refusal:b.refusal??null}}throw new a3("stream ended without producing a ChatCompletionMessage with role=assistant")},C=function(){for(let a=this.messages.length-1;a>=0;a--){let b=this.messages[a];if(cq(b)&&b?.tool_calls?.length)return b.tool_calls.filter(a=>"function"===a.type).at(-1)?.function}},D=function(){for(let a=this.messages.length-1;a>=0;a--){let b=this.messages[a];if(cr(b)&&null!=b.content&&"string"==typeof b.content&&this.messages.some(a=>"assistant"===a.role&&a.tool_calls?.some(a=>"function"===a.type&&a.id===b.tool_call_id)))return b.content}},E=function(){let a={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(let{usage:b}of this._chatCompletions)b&&(a.completion_tokens+=b.completion_tokens,a.prompt_tokens+=b.prompt_tokens,a.total_tokens+=b.total_tokens);return a},F=function(a){if(null!=a.n&&a.n>1)throw new a3("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},G=function(a){return"string"==typeof a?a:void 0===a?"undefined":JSON.stringify(a)};class cu extends ct{static runTools(a,b,c){let d=new cu,e={...c,headers:{...c?.headers,"X-Stainless-Helper-Method":"runTools"}};return d._run(()=>d._runTools(a,b,e)),d}_addMessage(a,b=!0){super._addMessage(a,b),cq(a)&&a.content&&this._emit("content",a.content)}}let cv={STR:1,NUM:2,ARR:4,OBJ:8,NULL:16,BOOL:32,NAN:64,INFINITY:128,MINUS_INFINITY:256,INF:384,ALL:511};class cw extends Error{}class cx extends Error{}let cy=a=>(function(a,b=cv.ALL){if("string"!=typeof a)throw TypeError(`expecting str, got ${typeof a}`);if(!a.trim())throw Error(`${a} is empty`);return((a,b)=>{let c=a.length,d=0,e=a=>{throw new cw(`${a} at position ${d}`)},f=a=>{throw new cx(`${a} at position ${d}`)},g=()=>(l(),d>=c&&e("Unexpected end of input"),'"'===a[d])?h():"{"===a[d]?i():"["===a[d]?j():"null"===a.substring(d,d+4)||cv.NULL&b&&c-d<4&&"null".startsWith(a.substring(d))?(d+=4,null):"true"===a.substring(d,d+4)||cv.BOOL&b&&c-d<4&&"true".startsWith(a.substring(d))?(d+=4,!0):"false"===a.substring(d,d+5)||cv.BOOL&b&&c-d<5&&"false".startsWith(a.substring(d))?(d+=5,!1):"Infinity"===a.substring(d,d+8)||cv.INFINITY&b&&c-d<8&&"Infinity".startsWith(a.substring(d))?(d+=8,1/0):"-Infinity"===a.substring(d,d+9)||cv.MINUS_INFINITY&b&&1<c-d&&c-d<9&&"-Infinity".startsWith(a.substring(d))?(d+=9,-1/0):"NaN"===a.substring(d,d+3)||cv.NAN&b&&c-d<3&&"NaN".startsWith(a.substring(d))?(d+=3,NaN):k(),h=()=>{let g=d,h=!1;for(d++;d<c&&('"'!==a[d]||h&&"\\"===a[d-1]);)h="\\"===a[d]&&!h,d++;if('"'==a.charAt(d))try{return JSON.parse(a.substring(g,++d-Number(h)))}catch(a){f(String(a))}else if(cv.STR&b)try{return JSON.parse(a.substring(g,d-Number(h))+'"')}catch(b){return JSON.parse(a.substring(g,a.lastIndexOf("\\"))+'"')}e("Unterminated string literal")},i=()=>{d++,l();let f={};try{for(;"}"!==a[d];){if(l(),d>=c&&cv.OBJ&b)return f;let e=h();l(),d++;try{let a=g();Object.defineProperty(f,e,{value:a,writable:!0,enumerable:!0,configurable:!0})}catch(a){if(cv.OBJ&b)return f;throw a}l(),","===a[d]&&d++}}catch(a){if(cv.OBJ&b)return f;e("Expected '}' at end of object")}return d++,f},j=()=>{d++;let c=[];try{for(;"]"!==a[d];)c.push(g()),l(),","===a[d]&&d++}catch(a){if(cv.ARR&b)return c;e("Expected ']' at end of array")}return d++,c},k=()=>{if(0===d){"-"===a&&cv.NUM&b&&e("Not sure what '-' is");try{return JSON.parse(a)}catch(c){if(cv.NUM&b)try{if("."===a[a.length-1])return JSON.parse(a.substring(0,a.lastIndexOf(".")));return JSON.parse(a.substring(0,a.lastIndexOf("e")))}catch(a){}f(String(c))}}let g=d;for("-"===a[d]&&d++;a[d]&&!",]}".includes(a[d]);)d++;d!=c||cv.NUM&b||e("Unterminated number literal");try{return JSON.parse(a.substring(g,d))}catch(c){"-"===a.substring(g,d)&&cv.NUM&b&&e("Not sure what '-' is");try{return JSON.parse(a.substring(g,a.lastIndexOf("e")))}catch(a){f(String(a))}}},l=()=>{for(;d<c&&" \n\r	".includes(a[d]);)d++};return g()})(a.trim(),b)})(a,cv.ALL^cv.NUM);class cz extends ct{constructor(a){super(),H.add(this),I.set(this,void 0),J.set(this,void 0),K.set(this,void 0),a$(this,I,a,"f"),a$(this,J,[],"f")}get currentChatCompletionSnapshot(){return a_(this,K,"f")}static fromReadableStream(a){let b=new cz(null);return b._run(()=>b._fromReadableStream(a)),b}static createChatCompletion(a,b,c){let d=new cz(b);return d._run(()=>d._runChatCompletion(a,{...b,stream:!0},{...c,headers:{...c?.headers,"X-Stainless-Helper-Method":"stream"}})),d}async _createChatCompletion(a,b,c){super._createChatCompletion;let d=c?.signal;d&&(d.aborted&&this.controller.abort(),d.addEventListener("abort",()=>this.controller.abort())),a_(this,H,"m",L).call(this);let e=await a.chat.completions.create({...b,stream:!0},{...c,signal:this.controller.signal});for await(let a of(this._connected(),e))a_(this,H,"m",N).call(this,a);if(e.controller.signal?.aborted)throw new a5;return this._addChatCompletion(a_(this,H,"m",Q).call(this))}async _fromReadableStream(a,b){let c,d=b?.signal;d&&(d.aborted&&this.controller.abort(),d.addEventListener("abort",()=>this.controller.abort())),a_(this,H,"m",L).call(this),this._connected();let e=bS.fromReadableStream(a,this.controller);for await(let a of e)c&&c!==a.id&&this._addChatCompletion(a_(this,H,"m",Q).call(this)),a_(this,H,"m",N).call(this,a),c=a.id;if(e.controller.signal?.aborted)throw new a5;return this._addChatCompletion(a_(this,H,"m",Q).call(this))}[(I=new WeakMap,J=new WeakMap,K=new WeakMap,H=new WeakSet,L=function(){this.ended||a$(this,K,void 0,"f")},M=function(a){let b=a_(this,J,"f")[a.index];return b||(b={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},a_(this,J,"f")[a.index]=b),b},N=function(a){if(this.ended)return;let b=a_(this,H,"m",S).call(this,a);for(let c of(this._emit("chunk",a,b),a.choices)){let a=b.choices[c.index];null!=c.delta.content&&a.message?.role==="assistant"&&a.message?.content&&(this._emit("content",c.delta.content,a.message.content),this._emit("content.delta",{delta:c.delta.content,snapshot:a.message.content,parsed:a.message.parsed})),null!=c.delta.refusal&&a.message?.role==="assistant"&&a.message?.refusal&&this._emit("refusal.delta",{delta:c.delta.refusal,snapshot:a.message.refusal}),c.logprobs?.content!=null&&a.message?.role==="assistant"&&this._emit("logprobs.content.delta",{content:c.logprobs?.content,snapshot:a.logprobs?.content??[]}),c.logprobs?.refusal!=null&&a.message?.role==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:c.logprobs?.refusal,snapshot:a.logprobs?.refusal??[]});let d=a_(this,H,"m",M).call(this,a);for(let b of(a.finish_reason&&(a_(this,H,"m",P).call(this,a),null!=d.current_tool_call_index&&a_(this,H,"m",O).call(this,a,d.current_tool_call_index)),c.delta.tool_calls??[]))d.current_tool_call_index!==b.index&&(a_(this,H,"m",P).call(this,a),null!=d.current_tool_call_index&&a_(this,H,"m",O).call(this,a,d.current_tool_call_index)),d.current_tool_call_index=b.index;for(let b of c.delta.tool_calls??[]){let c=a.message.tool_calls?.[b.index];c?.type&&(c?.type==="function"?this._emit("tool_calls.function.arguments.delta",{name:c.function?.name,index:b.index,arguments:c.function.arguments,parsed_arguments:c.function.parsed_arguments,arguments_delta:b.function?.arguments??""}):c?.type)}}},O=function(a,b){if(a_(this,H,"m",M).call(this,a).done_tool_calls.has(b))return;let c=a.message.tool_calls?.[b];if(!c)throw Error("no tool call snapshot");if(!c.type)throw Error("tool call snapshot missing `type`");if("function"===c.type){let a=a_(this,I,"f")?.tools?.find(a=>ck(a)&&a.function.name===c.function.name);this._emit("tool_calls.function.arguments.done",{name:c.function.name,index:b,arguments:c.function.arguments,parsed_arguments:cm(a)?a.$parseRaw(c.function.arguments):a?.function.strict?JSON.parse(c.function.arguments):null})}else c.type},P=function(a){let b=a_(this,H,"m",M).call(this,a);if(a.message.content&&!b.content_done){b.content_done=!0;let c=a_(this,H,"m",R).call(this);this._emit("content.done",{content:a.message.content,parsed:c?c.$parseRaw(a.message.content):null})}a.message.refusal&&!b.refusal_done&&(b.refusal_done=!0,this._emit("refusal.done",{refusal:a.message.refusal})),a.logprobs?.content&&!b.logprobs_content_done&&(b.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:a.logprobs.content})),a.logprobs?.refusal&&!b.logprobs_refusal_done&&(b.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:a.logprobs.refusal}))},Q=function(){if(this.ended)throw new a3("stream has ended, this shouldn't happen");let a=a_(this,K,"f");if(!a)throw new a3("request ended without sending any chunks");return a$(this,K,void 0,"f"),a$(this,J,[],"f"),function(a,b){var c;let{id:d,choices:e,created:f,model:g,system_fingerprint:h,...i}=a;return c={...i,id:d,choices:e.map(({message:b,finish_reason:c,index:d,logprobs:e,...f})=>{if(!c)throw new a3(`missing finish_reason for choice ${d}`);let{content:g=null,function_call:h,tool_calls:i,...j}=b,k=b.role;if(!k)throw new a3(`missing role for choice ${d}`);if(h){let{arguments:a,name:i}=h;if(null==a)throw new a3(`missing function_call.arguments for choice ${d}`);if(!i)throw new a3(`missing function_call.name for choice ${d}`);return{...f,message:{content:g,function_call:{arguments:a,name:i},role:k,refusal:b.refusal??null},finish_reason:c,index:d,logprobs:e}}return i?{...f,index:d,finish_reason:c,logprobs:e,message:{...j,role:k,content:g,refusal:b.refusal??null,tool_calls:i.map((b,c)=>{let{function:e,type:f,id:g,...h}=b,{arguments:i,name:j,...k}=e||{};if(null==g)throw new a3(`missing choices[${d}].tool_calls[${c}].id
${cA(a)}`);if(null==f)throw new a3(`missing choices[${d}].tool_calls[${c}].type
${cA(a)}`);if(null==j)throw new a3(`missing choices[${d}].tool_calls[${c}].function.name
${cA(a)}`);if(null==i)throw new a3(`missing choices[${d}].tool_calls[${c}].function.arguments
${cA(a)}`);return{...h,id:g,type:f,function:{...k,name:j,arguments:i}}})}}:{...f,message:{...j,content:g,role:k,refusal:b.refusal??null},finish_reason:c,index:d,logprobs:e}}),created:f,model:g,object:"chat.completion",...h?{system_fingerprint:h}:{}},b&&co(b)?cn(c,b):{...c,choices:c.choices.map(a=>(cp(a.message.tool_calls),{...a,message:{...a.message,parsed:null,...a.message.tool_calls?{tool_calls:a.message.tool_calls}:void 0}}))}}(a,a_(this,I,"f"))},R=function(){let a=a_(this,I,"f")?.response_format;return cl(a)?a:null},S=function(a){var b,c,d,e;let f=a_(this,K,"f"),{choices:g,...h}=a;for(let{delta:g,finish_reason:i,index:j,logprobs:k=null,...l}of(f?Object.assign(f,h):f=a$(this,K,{...h,choices:[]},"f"),a.choices)){let a=f.choices[j];if(a||(a=f.choices[j]={finish_reason:i,index:j,message:{},logprobs:k,...l}),k)if(a.logprobs){let{content:d,refusal:e,...f}=k;Object.assign(a.logprobs,f),d&&((b=a.logprobs).content??(b.content=[]),a.logprobs.content.push(...d)),e&&((c=a.logprobs).refusal??(c.refusal=[]),a.logprobs.refusal.push(...e))}else a.logprobs=Object.assign({},k);if(i&&(a.finish_reason=i,a_(this,I,"f")&&co(a_(this,I,"f")))){if("length"===i)throw new bg;if("content_filter"===i)throw new bh}if(Object.assign(a,l),!g)continue;let{content:h,refusal:m,function_call:n,role:o,tool_calls:p,...q}=g;if(Object.assign(a.message,q),m&&(a.message.refusal=(a.message.refusal||"")+m),o&&(a.message.role=o),n&&(a.message.function_call?(n.name&&(a.message.function_call.name=n.name),n.arguments&&((d=a.message.function_call).arguments??(d.arguments=""),a.message.function_call.arguments+=n.arguments)):a.message.function_call=n),h&&(a.message.content=(a.message.content||"")+h,!a.message.refusal&&a_(this,H,"m",R).call(this)&&(a.message.parsed=cy(a.message.content))),p)for(let{index:b,id:c,type:d,function:f,...g}of(a.message.tool_calls||(a.message.tool_calls=[]),p)){let h=(e=a.message.tool_calls)[b]??(e[b]={});Object.assign(h,g),c&&(h.id=c),d&&(h.type=d),f&&(h.function??(h.function={name:f.name??"",arguments:""})),f?.name&&(h.function.name=f.name),f?.arguments&&(h.function.arguments+=f.arguments,function(a,b){if(!a||!("tools"in a)||!a.tools)return!1;let c=a.tools?.find(a=>ck(a)&&a.function?.name===b.function.name);return ck(c)&&(cm(c)||c?.function.strict||!1)}(a_(this,I,"f"),h)&&(h.function.parsed_arguments=cy(h.function.arguments)))}}return f},Symbol.asyncIterator)](){let a=[],b=[],c=!1;return this.on("chunk",c=>{let d=b.shift();d?d.resolve(c):a.push(c)}),this.on("end",()=>{for(let a of(c=!0,b))a.resolve(void 0);b.length=0}),this.on("abort",a=>{for(let d of(c=!0,b))d.reject(a);b.length=0}),this.on("error",a=>{for(let d of(c=!0,b))d.reject(a);b.length=0}),{next:async()=>a.length?{value:a.shift(),done:!1}:c?{value:void 0,done:!0}:new Promise((a,c)=>b.push({resolve:a,reject:c})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new bS(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function cA(a){return JSON.stringify(a)}class cB extends cz{static fromReadableStream(a){let b=new cB(null);return b._run(()=>b._fromReadableStream(a)),b}static runTools(a,b,c){let d=new cB(b),e={...c,headers:{...c?.headers,"X-Stainless-Helper-Method":"runTools"}};return d._run(()=>d._runTools(a,b,e)),d}}class cC extends cf{constructor(){super(...arguments),this.messages=new cj(this._client)}create(a,b){return this._client.post("/chat/completions",{body:a,...b,stream:a.stream??!1})}retrieve(a,b){return this._client.get(ci`/chat/completions/${a}`,b)}update(a,b,c){return this._client.post(ci`/chat/completions/${a}`,{body:b,...c})}list(a={},b){return this._client.getAPIList("/chat/completions",b0,{query:a,...b})}delete(a,b){return this._client.delete(ci`/chat/completions/${a}`,b)}parse(a,b){for(let b of a.tools??[]){if("function"!==b.type)throw new a3(`Currently only \`function\` tool types support auto-parsing; Received \`${b.type}\``);if(!0!==b.function.strict)throw new a3(`The \`${b.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}return this._client.chat.completions.create(a,{...b,headers:{...b?.headers,"X-Stainless-Helper-Method":"chat.completions.parse"}})._thenUnwrap(b=>cn(b,a))}runTools(a,b){return a.stream?cB.runTools(this._client,a,b):cu.runTools(this._client,a,b)}stream(a,b){return cz.createChatCompletion(this._client,a,b)}}cC.Messages=cj;class cD extends cf{constructor(){super(...arguments),this.completions=new cC(this._client)}}cD.Completions=cC;let cE=Symbol("brand.privateNullableHeaders"),cF=a=>{let b=new Headers,c=new Set;for(let d of a){let a=new Set;for(let[e,f]of function*(a){let b;if(!a)return;if(cE in a){let{values:b,nulls:c}=a;for(let a of(yield*b.entries(),c))yield[a,null];return}let c=!1;for(let d of(a instanceof Headers?b=a.entries():bl(a)?b=a:(c=!0,b=Object.entries(a??{})),b)){let a=d[0];if("string"!=typeof a)throw TypeError("expected header name to be a string");let b=bl(d[1])?d[1]:[d[1]],e=!1;for(let d of b)void 0!==d&&(c&&!e&&(e=!0,yield[a,null]),yield[a,d])}}(d)){let d=e.toLowerCase();a.has(d)||(b.delete(e),a.add(d)),null===f?(b.delete(e),c.add(d)):(b.append(e,f),c.delete(d))}}return{[cE]:!0,values:b,nulls:c}};class cG extends cf{create(a,b){return this._client.post("/audio/speech",{body:a,...b,headers:cF([{Accept:"application/octet-stream"},b?.headers]),__binaryResponse:!0})}}class cH extends cf{create(a,b){return this._client.post("/audio/transcriptions",b6({body:a,...b,stream:a.stream??!1,__metadata:{model:a.model}},this._client))}}class cI extends cf{create(a,b){return this._client.post("/audio/translations",b6({body:a,...b,__metadata:{model:a.model}},this._client))}}class cJ extends cf{constructor(){super(...arguments),this.transcriptions=new cH(this._client),this.translations=new cI(this._client),this.speech=new cG(this._client)}}cJ.Transcriptions=cH,cJ.Translations=cI,cJ.Speech=cG;class cK extends cf{create(a,b){return this._client.post("/batches",{body:a,...b})}retrieve(a,b){return this._client.get(ci`/batches/${a}`,b)}list(a={},b){return this._client.getAPIList("/batches",b0,{query:a,...b})}cancel(a,b){return this._client.post(ci`/batches/${a}/cancel`,b)}}class cL extends cf{create(a,b){return this._client.post("/assistants",{body:a,...b,headers:cF([{"OpenAI-Beta":"assistants=v2"},b?.headers])})}retrieve(a,b){return this._client.get(ci`/assistants/${a}`,{...b,headers:cF([{"OpenAI-Beta":"assistants=v2"},b?.headers])})}update(a,b,c){return this._client.post(ci`/assistants/${a}`,{body:b,...c,headers:cF([{"OpenAI-Beta":"assistants=v2"},c?.headers])})}list(a={},b){return this._client.getAPIList("/assistants",b0,{query:a,...b,headers:cF([{"OpenAI-Beta":"assistants=v2"},b?.headers])})}delete(a,b){return this._client.delete(ci`/assistants/${a}`,{...b,headers:cF([{"OpenAI-Beta":"assistants=v2"},b?.headers])})}}class cM extends cf{create(a,b){return this._client.post("/realtime/sessions",{body:a,...b,headers:cF([{"OpenAI-Beta":"assistants=v2"},b?.headers])})}}class cN extends cf{create(a,b){return this._client.post("/realtime/transcription_sessions",{body:a,...b,headers:cF([{"OpenAI-Beta":"assistants=v2"},b?.headers])})}}class cO extends cf{constructor(){super(...arguments),this.sessions=new cM(this._client),this.transcriptionSessions=new cN(this._client)}}cO.Sessions=cM,cO.TranscriptionSessions=cN;class cP extends cf{create(a,b,c){return this._client.post(ci`/threads/${a}/messages`,{body:b,...c,headers:cF([{"OpenAI-Beta":"assistants=v2"},c?.headers])})}retrieve(a,b,c){let{thread_id:d}=b;return this._client.get(ci`/threads/${d}/messages/${a}`,{...c,headers:cF([{"OpenAI-Beta":"assistants=v2"},c?.headers])})}update(a,b,c){let{thread_id:d,...e}=b;return this._client.post(ci`/threads/${d}/messages/${a}`,{body:e,...c,headers:cF([{"OpenAI-Beta":"assistants=v2"},c?.headers])})}list(a,b={},c){return this._client.getAPIList(ci`/threads/${a}/messages`,b0,{query:b,...c,headers:cF([{"OpenAI-Beta":"assistants=v2"},c?.headers])})}delete(a,b,c){let{thread_id:d}=b;return this._client.delete(ci`/threads/${d}/messages/${a}`,{...c,headers:cF([{"OpenAI-Beta":"assistants=v2"},c?.headers])})}}class cQ extends cf{retrieve(a,b,c){let{thread_id:d,run_id:e,...f}=b;return this._client.get(ci`/threads/${d}/runs/${e}/steps/${a}`,{query:f,...c,headers:cF([{"OpenAI-Beta":"assistants=v2"},c?.headers])})}list(a,b,c){let{thread_id:d,...e}=b;return this._client.getAPIList(ci`/threads/${d}/runs/${a}/steps`,b0,{query:e,...c,headers:cF([{"OpenAI-Beta":"assistants=v2"},c?.headers])})}}let cR=a=>void 0!==globalThis.process?globalThis.process.env?.[a]?.trim()??void 0:void 0!==globalThis.Deno?globalThis.Deno.env?.get?.(a)?.trim():void 0;class cS extends cs{constructor(){super(...arguments),T.add(this),V.set(this,[]),W.set(this,{}),X.set(this,{}),Y.set(this,void 0),Z.set(this,void 0),$.set(this,void 0),_.set(this,void 0),aa.set(this,void 0),ab.set(this,void 0),ac.set(this,void 0),ad.set(this,void 0),ae.set(this,void 0)}[(V=new WeakMap,W=new WeakMap,X=new WeakMap,Y=new WeakMap,Z=new WeakMap,$=new WeakMap,_=new WeakMap,aa=new WeakMap,ab=new WeakMap,ac=new WeakMap,ad=new WeakMap,ae=new WeakMap,T=new WeakSet,Symbol.asyncIterator)](){let a=[],b=[],c=!1;return this.on("event",c=>{let d=b.shift();d?d.resolve(c):a.push(c)}),this.on("end",()=>{for(let a of(c=!0,b))a.resolve(void 0);b.length=0}),this.on("abort",a=>{for(let d of(c=!0,b))d.reject(a);b.length=0}),this.on("error",a=>{for(let d of(c=!0,b))d.reject(a);b.length=0}),{next:async()=>a.length?{value:a.shift(),done:!1}:c?{value:void 0,done:!0}:new Promise((a,c)=>b.push({resolve:a,reject:c})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(a){let b=new U;return b._run(()=>b._fromReadableStream(a)),b}async _fromReadableStream(a,b){let c=b?.signal;c&&(c.aborted&&this.controller.abort(),c.addEventListener("abort",()=>this.controller.abort())),this._connected();let d=bS.fromReadableStream(a,this.controller);for await(let a of d)a_(this,T,"m",af).call(this,a);if(d.controller.signal?.aborted)throw new a5;return this._addRun(a_(this,T,"m",ag).call(this))}toReadableStream(){return new bS(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(a,b,c,d){let e=new U;return e._run(()=>e._runToolAssistantStream(a,b,c,{...d,headers:{...d?.headers,"X-Stainless-Helper-Method":"stream"}})),e}async _createToolAssistantStream(a,b,c,d){let e=d?.signal;e&&(e.aborted&&this.controller.abort(),e.addEventListener("abort",()=>this.controller.abort()));let f={...c,stream:!0},g=await a.submitToolOutputs(b,f,{...d,signal:this.controller.signal});for await(let a of(this._connected(),g))a_(this,T,"m",af).call(this,a);if(g.controller.signal?.aborted)throw new a5;return this._addRun(a_(this,T,"m",ag).call(this))}static createThreadAssistantStream(a,b,c){let d=new U;return d._run(()=>d._threadAssistantStream(a,b,{...c,headers:{...c?.headers,"X-Stainless-Helper-Method":"stream"}})),d}static createAssistantStream(a,b,c,d){let e=new U;return e._run(()=>e._runAssistantStream(a,b,c,{...d,headers:{...d?.headers,"X-Stainless-Helper-Method":"stream"}})),e}currentEvent(){return a_(this,ac,"f")}currentRun(){return a_(this,ad,"f")}currentMessageSnapshot(){return a_(this,Y,"f")}currentRunStepSnapshot(){return a_(this,ae,"f")}async finalRunSteps(){return await this.done(),Object.values(a_(this,W,"f"))}async finalMessages(){return await this.done(),Object.values(a_(this,X,"f"))}async finalRun(){if(await this.done(),!a_(this,Z,"f"))throw Error("Final run was not received.");return a_(this,Z,"f")}async _createThreadAssistantStream(a,b,c){let d=c?.signal;d&&(d.aborted&&this.controller.abort(),d.addEventListener("abort",()=>this.controller.abort()));let e={...b,stream:!0},f=await a.createAndRun(e,{...c,signal:this.controller.signal});for await(let a of(this._connected(),f))a_(this,T,"m",af).call(this,a);if(f.controller.signal?.aborted)throw new a5;return this._addRun(a_(this,T,"m",ag).call(this))}async _createAssistantStream(a,b,c,d){let e=d?.signal;e&&(e.aborted&&this.controller.abort(),e.addEventListener("abort",()=>this.controller.abort()));let f={...c,stream:!0},g=await a.create(b,f,{...d,signal:this.controller.signal});for await(let a of(this._connected(),g))a_(this,T,"m",af).call(this,a);if(g.controller.signal?.aborted)throw new a5;return this._addRun(a_(this,T,"m",ag).call(this))}static accumulateDelta(a,b){for(let[c,d]of Object.entries(b)){if(!a.hasOwnProperty(c)){a[c]=d;continue}let b=a[c];if(null==b||"index"===c||"type"===c){a[c]=d;continue}if("string"==typeof b&&"string"==typeof d)b+=d;else if("number"==typeof b&&"number"==typeof d)b+=d;else if(bn(b)&&bn(d))b=this.accumulateDelta(b,d);else if(Array.isArray(b)&&Array.isArray(d)){if(b.every(a=>"string"==typeof a||"number"==typeof a)){b.push(...d);continue}for(let a of d){if(!bn(a))throw Error(`Expected array delta entry to be an object but got: ${a}`);let c=a.index;if(null==c)throw console.error(a),Error("Expected array delta entry to have an `index` property");if("number"!=typeof c)throw Error(`Expected array delta entry \`index\` property to be a number but got ${c}`);let d=b[c];null==d?b.push(a):b[c]=this.accumulateDelta(d,a)}continue}else throw Error(`Unhandled record type: ${c}, deltaValue: ${d}, accValue: ${b}`);a[c]=b}return a}_addRun(a){return a}async _threadAssistantStream(a,b,c){return await this._createThreadAssistantStream(b,a,c)}async _runAssistantStream(a,b,c,d){return await this._createAssistantStream(b,a,c,d)}async _runToolAssistantStream(a,b,c,d){return await this._createToolAssistantStream(b,a,c,d)}}U=cS,af=function(a){if(!this.ended)switch(a$(this,ac,a,"f"),a_(this,T,"m",aj).call(this,a),a.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":a_(this,T,"m",an).call(this,a);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":a_(this,T,"m",ai).call(this,a);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":a_(this,T,"m",ah).call(this,a);break;case"error":throw Error("Encountered an error event in event processing - errors should be processed earlier")}},ag=function(){if(this.ended)throw new a3("stream has ended, this shouldn't happen");if(!a_(this,Z,"f"))throw Error("Final run has not been received");return a_(this,Z,"f")},ah=function(a){let[b,c]=a_(this,T,"m",al).call(this,a,a_(this,Y,"f"));for(let a of(a$(this,Y,b,"f"),a_(this,X,"f")[b.id]=b,c)){let c=b.content[a.index];c?.type=="text"&&this._emit("textCreated",c.text)}switch(a.event){case"thread.message.created":this._emit("messageCreated",a.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",a.data.delta,b),a.data.delta.content)for(let c of a.data.delta.content){if("text"==c.type&&c.text){let a=c.text,d=b.content[c.index];if(d&&"text"==d.type)this._emit("textDelta",a,d.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(c.index!=a_(this,$,"f")){if(a_(this,_,"f"))switch(a_(this,_,"f").type){case"text":this._emit("textDone",a_(this,_,"f").text,a_(this,Y,"f"));break;case"image_file":this._emit("imageFileDone",a_(this,_,"f").image_file,a_(this,Y,"f"))}a$(this,$,c.index,"f")}a$(this,_,b.content[c.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(void 0!==a_(this,$,"f")){let b=a.data.content[a_(this,$,"f")];if(b)switch(b.type){case"image_file":this._emit("imageFileDone",b.image_file,a_(this,Y,"f"));break;case"text":this._emit("textDone",b.text,a_(this,Y,"f"))}}a_(this,Y,"f")&&this._emit("messageDone",a.data),a$(this,Y,void 0,"f")}},ai=function(a){let b=a_(this,T,"m",ak).call(this,a);switch(a$(this,ae,b,"f"),a.event){case"thread.run.step.created":this._emit("runStepCreated",a.data);break;case"thread.run.step.delta":let c=a.data.delta;if(c.step_details&&"tool_calls"==c.step_details.type&&c.step_details.tool_calls&&"tool_calls"==b.step_details.type)for(let a of c.step_details.tool_calls)a.index==a_(this,aa,"f")?this._emit("toolCallDelta",a,b.step_details.tool_calls[a.index]):(a_(this,ab,"f")&&this._emit("toolCallDone",a_(this,ab,"f")),a$(this,aa,a.index,"f"),a$(this,ab,b.step_details.tool_calls[a.index],"f"),a_(this,ab,"f")&&this._emit("toolCallCreated",a_(this,ab,"f")));this._emit("runStepDelta",a.data.delta,b);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":a$(this,ae,void 0,"f"),"tool_calls"==a.data.step_details.type&&a_(this,ab,"f")&&(this._emit("toolCallDone",a_(this,ab,"f")),a$(this,ab,void 0,"f")),this._emit("runStepDone",a.data,b)}},aj=function(a){a_(this,V,"f").push(a),this._emit("event",a)},ak=function(a){switch(a.event){case"thread.run.step.created":return a_(this,W,"f")[a.data.id]=a.data,a.data;case"thread.run.step.delta":let b=a_(this,W,"f")[a.data.id];if(!b)throw Error("Received a RunStepDelta before creation of a snapshot");let c=a.data;if(c.delta){let d=U.accumulateDelta(b,c.delta);a_(this,W,"f")[a.data.id]=d}return a_(this,W,"f")[a.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":a_(this,W,"f")[a.data.id]=a.data}if(a_(this,W,"f")[a.data.id])return a_(this,W,"f")[a.data.id];throw Error("No snapshot available")},al=function(a,b){let c=[];switch(a.event){case"thread.message.created":return[a.data,c];case"thread.message.delta":if(!b)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let d=a.data;if(d.delta.content)for(let a of d.delta.content)if(a.index in b.content){let c=b.content[a.index];b.content[a.index]=a_(this,T,"m",am).call(this,a,c)}else b.content[a.index]=a,c.push(a);return[b,c];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(b)return[b,c];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},am=function(a,b){return U.accumulateDelta(b,a)},an=function(a){switch(a$(this,ad,a.data,"f"),a.event){case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":case"thread.run.incomplete":a$(this,Z,a.data,"f"),a_(this,ab,"f")&&(this._emit("toolCallDone",a_(this,ab,"f")),a$(this,ab,void 0,"f"))}};class cT extends cf{constructor(){super(...arguments),this.steps=new cQ(this._client)}create(a,b,c){let{include:d,...e}=b;return this._client.post(ci`/threads/${a}/runs`,{query:{include:d},body:e,...c,headers:cF([{"OpenAI-Beta":"assistants=v2"},c?.headers]),stream:b.stream??!1})}retrieve(a,b,c){let{thread_id:d}=b;return this._client.get(ci`/threads/${d}/runs/${a}`,{...c,headers:cF([{"OpenAI-Beta":"assistants=v2"},c?.headers])})}update(a,b,c){let{thread_id:d,...e}=b;return this._client.post(ci`/threads/${d}/runs/${a}`,{body:e,...c,headers:cF([{"OpenAI-Beta":"assistants=v2"},c?.headers])})}list(a,b={},c){return this._client.getAPIList(ci`/threads/${a}/runs`,b0,{query:b,...c,headers:cF([{"OpenAI-Beta":"assistants=v2"},c?.headers])})}cancel(a,b,c){let{thread_id:d}=b;return this._client.post(ci`/threads/${d}/runs/${a}/cancel`,{...c,headers:cF([{"OpenAI-Beta":"assistants=v2"},c?.headers])})}async createAndPoll(a,b,c){let d=await this.create(a,b,c);return await this.poll(d.id,{thread_id:a},c)}createAndStream(a,b,c){return cS.createAssistantStream(a,this._client.beta.threads.runs,b,c)}async poll(a,b,c){let d=cF([c?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":c?.pollIntervalMs?.toString()??void 0}]);for(;;){let{data:e,response:f}=await this.retrieve(a,b,{...c,headers:{...c?.headers,...d}}).withResponse();switch(e.status){case"queued":case"in_progress":case"cancelling":let g=5e3;if(c?.pollIntervalMs)g=c.pollIntervalMs;else{let a=f.headers.get("openai-poll-after-ms");if(a){let b=parseInt(a);isNaN(b)||(g=b)}}await bo(g);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return e}}}stream(a,b,c){return cS.createAssistantStream(a,this._client.beta.threads.runs,b,c)}submitToolOutputs(a,b,c){let{thread_id:d,...e}=b;return this._client.post(ci`/threads/${d}/runs/${a}/submit_tool_outputs`,{body:e,...c,headers:cF([{"OpenAI-Beta":"assistants=v2"},c?.headers]),stream:b.stream??!1})}async submitToolOutputsAndPoll(a,b,c){let d=await this.submitToolOutputs(a,b,c);return await this.poll(d.id,b,c)}submitToolOutputsStream(a,b,c){return cS.createToolAssistantStream(a,this._client.beta.threads.runs,b,c)}}cT.Steps=cQ;class cU extends cf{constructor(){super(...arguments),this.runs=new cT(this._client),this.messages=new cP(this._client)}create(a={},b){return this._client.post("/threads",{body:a,...b,headers:cF([{"OpenAI-Beta":"assistants=v2"},b?.headers])})}retrieve(a,b){return this._client.get(ci`/threads/${a}`,{...b,headers:cF([{"OpenAI-Beta":"assistants=v2"},b?.headers])})}update(a,b,c){return this._client.post(ci`/threads/${a}`,{body:b,...c,headers:cF([{"OpenAI-Beta":"assistants=v2"},c?.headers])})}delete(a,b){return this._client.delete(ci`/threads/${a}`,{...b,headers:cF([{"OpenAI-Beta":"assistants=v2"},b?.headers])})}createAndRun(a,b){return this._client.post("/threads/runs",{body:a,...b,headers:cF([{"OpenAI-Beta":"assistants=v2"},b?.headers]),stream:a.stream??!1})}async createAndRunPoll(a,b){let c=await this.createAndRun(a,b);return await this.runs.poll(c.id,{thread_id:c.thread_id},b)}createAndRunStream(a,b){return cS.createThreadAssistantStream(a,this._client.beta.threads,b)}}cU.Runs=cT,cU.Messages=cP;class cV extends cf{constructor(){super(...arguments),this.realtime=new cO(this._client),this.assistants=new cL(this._client),this.threads=new cU(this._client)}}cV.Realtime=cO,cV.Assistants=cL,cV.Threads=cU;class cW extends cf{create(a,b){return this._client.post("/completions",{body:a,...b,stream:a.stream??!1})}}class cX extends cf{retrieve(a,b,c){let{container_id:d}=b;return this._client.get(ci`/containers/${d}/files/${a}/content`,{...c,headers:cF([{Accept:"application/binary"},c?.headers]),__binaryResponse:!0})}}class cY extends cf{constructor(){super(...arguments),this.content=new cX(this._client)}create(a,b,c){return this._client.post(ci`/containers/${a}/files`,b6({body:b,...c},this._client))}retrieve(a,b,c){let{container_id:d}=b;return this._client.get(ci`/containers/${d}/files/${a}`,c)}list(a,b={},c){return this._client.getAPIList(ci`/containers/${a}/files`,b0,{query:b,...c})}delete(a,b,c){let{container_id:d}=b;return this._client.delete(ci`/containers/${d}/files/${a}`,{...c,headers:cF([{Accept:"*/*"},c?.headers])})}}cY.Content=cX;class cZ extends cf{constructor(){super(...arguments),this.files=new cY(this._client)}create(a,b){return this._client.post("/containers",{body:a,...b})}retrieve(a,b){return this._client.get(ci`/containers/${a}`,b)}list(a={},b){return this._client.getAPIList("/containers",b0,{query:a,...b})}delete(a,b){return this._client.delete(ci`/containers/${a}`,{...b,headers:cF([{Accept:"*/*"},b?.headers])})}}cZ.Files=cY;class c$ extends cf{create(a,b,c){let{include:d,...e}=b;return this._client.post(ci`/conversations/${a}/items`,{query:{include:d},body:e,...c})}retrieve(a,b,c){let{conversation_id:d,...e}=b;return this._client.get(ci`/conversations/${d}/items/${a}`,{query:e,...c})}list(a,b={},c){return this._client.getAPIList(ci`/conversations/${a}/items`,b1,{query:b,...c})}delete(a,b,c){let{conversation_id:d}=b;return this._client.delete(ci`/conversations/${d}/items/${a}`,c)}}class c_ extends cf{constructor(){super(...arguments),this.items=new c$(this._client)}create(a,b){return this._client.post("/conversations",{body:a,...b})}retrieve(a,b){return this._client.get(ci`/conversations/${a}`,b)}update(a,b,c){return this._client.post(ci`/conversations/${a}`,{body:b,...c})}delete(a,b){return this._client.delete(ci`/conversations/${a}`,b)}}c_.Items=c$;class c0 extends cf{create(a,b){let c=!!a.encoding_format,d=c?a.encoding_format:"base64";c&&bQ(this._client).debug("embeddings/user defined encoding_format:",a.encoding_format);let e=this._client.post("/embeddings",{body:{...a,encoding_format:d},...b});return c?e:(bQ(this._client).debug("embeddings/decoding base64 embeddings from base64"),e._thenUnwrap(a=>(a&&a.data&&a.data.forEach(a=>{let b=a.embedding;a.embedding=(a=>{if("undefined"!=typeof Buffer){let b=Buffer.from(a,"base64");return Array.from(new Float32Array(b.buffer,b.byteOffset,b.length/Float32Array.BYTES_PER_ELEMENT))}{let b=atob(a),c=b.length,d=new Uint8Array(c);for(let a=0;a<c;a++)d[a]=b.charCodeAt(a);return Array.from(new Float32Array(d.buffer))}})(b)}),a)))}}class c1 extends cf{retrieve(a,b,c){let{eval_id:d,run_id:e}=b;return this._client.get(ci`/evals/${d}/runs/${e}/output_items/${a}`,c)}list(a,b,c){let{eval_id:d,...e}=b;return this._client.getAPIList(ci`/evals/${d}/runs/${a}/output_items`,b0,{query:e,...c})}}class c2 extends cf{constructor(){super(...arguments),this.outputItems=new c1(this._client)}create(a,b,c){return this._client.post(ci`/evals/${a}/runs`,{body:b,...c})}retrieve(a,b,c){let{eval_id:d}=b;return this._client.get(ci`/evals/${d}/runs/${a}`,c)}list(a,b={},c){return this._client.getAPIList(ci`/evals/${a}/runs`,b0,{query:b,...c})}delete(a,b,c){let{eval_id:d}=b;return this._client.delete(ci`/evals/${d}/runs/${a}`,c)}cancel(a,b,c){let{eval_id:d}=b;return this._client.post(ci`/evals/${d}/runs/${a}`,c)}}c2.OutputItems=c1;class c3 extends cf{constructor(){super(...arguments),this.runs=new c2(this._client)}create(a,b){return this._client.post("/evals",{body:a,...b})}retrieve(a,b){return this._client.get(ci`/evals/${a}`,b)}update(a,b,c){return this._client.post(ci`/evals/${a}`,{body:b,...c})}list(a={},b){return this._client.getAPIList("/evals",b0,{query:a,...b})}delete(a,b){return this._client.delete(ci`/evals/${a}`,b)}}c3.Runs=c2;class c4 extends cf{create(a,b){return this._client.post("/files",b6({body:a,...b},this._client))}retrieve(a,b){return this._client.get(ci`/files/${a}`,b)}list(a={},b){return this._client.getAPIList("/files",b0,{query:a,...b})}delete(a,b){return this._client.delete(ci`/files/${a}`,b)}content(a,b){return this._client.get(ci`/files/${a}/content`,{...b,headers:cF([{Accept:"application/binary"},b?.headers]),__binaryResponse:!0})}async waitForProcessing(a,{pollInterval:b=5e3,maxWait:c=18e5}={}){let d=new Set(["processed","error","deleted"]),e=Date.now(),f=await this.retrieve(a);for(;!f.status||!d.has(f.status);)if(await bo(b),f=await this.retrieve(a),Date.now()-e>c)throw new a7({message:`Giving up on waiting for file ${a} to finish processing after ${c} milliseconds.`});return f}}class c5 extends cf{}class c6 extends cf{run(a,b){return this._client.post("/fine_tuning/alpha/graders/run",{body:a,...b})}validate(a,b){return this._client.post("/fine_tuning/alpha/graders/validate",{body:a,...b})}}class c7 extends cf{constructor(){super(...arguments),this.graders=new c6(this._client)}}c7.Graders=c6;class c8 extends cf{create(a,b,c){return this._client.getAPIList(ci`/fine_tuning/checkpoints/${a}/permissions`,b_,{body:b,method:"post",...c})}retrieve(a,b={},c){return this._client.get(ci`/fine_tuning/checkpoints/${a}/permissions`,{query:b,...c})}delete(a,b,c){let{fine_tuned_model_checkpoint:d}=b;return this._client.delete(ci`/fine_tuning/checkpoints/${d}/permissions/${a}`,c)}}class c9 extends cf{constructor(){super(...arguments),this.permissions=new c8(this._client)}}c9.Permissions=c8;class da extends cf{list(a,b={},c){return this._client.getAPIList(ci`/fine_tuning/jobs/${a}/checkpoints`,b0,{query:b,...c})}}class db extends cf{constructor(){super(...arguments),this.checkpoints=new da(this._client)}create(a,b){return this._client.post("/fine_tuning/jobs",{body:a,...b})}retrieve(a,b){return this._client.get(ci`/fine_tuning/jobs/${a}`,b)}list(a={},b){return this._client.getAPIList("/fine_tuning/jobs",b0,{query:a,...b})}cancel(a,b){return this._client.post(ci`/fine_tuning/jobs/${a}/cancel`,b)}listEvents(a,b={},c){return this._client.getAPIList(ci`/fine_tuning/jobs/${a}/events`,b0,{query:b,...c})}pause(a,b){return this._client.post(ci`/fine_tuning/jobs/${a}/pause`,b)}resume(a,b){return this._client.post(ci`/fine_tuning/jobs/${a}/resume`,b)}}db.Checkpoints=da;class dc extends cf{constructor(){super(...arguments),this.methods=new c5(this._client),this.jobs=new db(this._client),this.checkpoints=new c9(this._client),this.alpha=new c7(this._client)}}dc.Methods=c5,dc.Jobs=db,dc.Checkpoints=c9,dc.Alpha=c7;class dd extends cf{}class de extends cf{constructor(){super(...arguments),this.graderModels=new dd(this._client)}}de.GraderModels=dd;class df extends cf{createVariation(a,b){return this._client.post("/images/variations",b6({body:a,...b},this._client))}edit(a,b){return this._client.post("/images/edits",b6({body:a,...b,stream:a.stream??!1},this._client))}generate(a,b){return this._client.post("/images/generations",{body:a,...b,stream:a.stream??!1})}}class dg extends cf{retrieve(a,b){return this._client.get(ci`/models/${a}`,b)}list(a){return this._client.getAPIList("/models",b_,a)}delete(a,b){return this._client.delete(ci`/models/${a}`,b)}}class dh extends cf{create(a,b){return this._client.post("/moderations",{body:a,...b})}}class di extends cf{create(a,b){return this._client.post("/realtime/client_secrets",{body:a,...b})}}class dj extends cf{constructor(){super(...arguments),this.clientSecrets=new di(this._client)}}function dk(a,b){let c=a.output.map(a=>{if("function_call"===a.type)return{...a,parsed_arguments:function(a,b){var c,d;let e=(c=a.tools??[],d=b.name,c.find(a=>"function"===a.type&&a.name===d));return{...b,...b,parsed_arguments:e?.$brand==="auto-parseable-tool"?e.$parseRaw(b.arguments):e?.strict?JSON.parse(b.arguments):null}}(b,a)};if("message"===a.type){let c=a.content.map(a=>{var c,d;return"output_text"===a.type?{...a,parsed:(c=b,d=a.text,c.text?.format?.type!=="json_schema"?null:"$parseRaw"in c.text?.format?(c.text?.format).$parseRaw(d):JSON.parse(d))}:a});return{...a,content:c}}return a}),d=Object.assign({},a,{output:c});return Object.getOwnPropertyDescriptor(a,"output_text")||dl(d),Object.defineProperty(d,"output_parsed",{enumerable:!0,get(){for(let a of d.output)if("message"===a.type){for(let b of a.content)if("output_text"===b.type&&null!==b.parsed)return b.parsed}return null}}),d}function dl(a){let b=[];for(let c of a.output)if("message"===c.type)for(let a of c.content)"output_text"===a.type&&b.push(a.text);a.output_text=b.join("")}dj.ClientSecrets=di;class dm extends cs{constructor(a){super(),ao.add(this),ap.set(this,void 0),aq.set(this,void 0),ar.set(this,void 0),a$(this,ap,a,"f")}static createResponse(a,b,c){let d=new dm(b);return d._run(()=>d._createOrRetrieveResponse(a,b,{...c,headers:{...c?.headers,"X-Stainless-Helper-Method":"stream"}})),d}async _createOrRetrieveResponse(a,b,c){let d,e=c?.signal;e&&(e.aborted&&this.controller.abort(),e.addEventListener("abort",()=>this.controller.abort())),a_(this,ao,"m",as).call(this);let f=null;for await(let e of("response_id"in b?(d=await a.responses.retrieve(b.response_id,{stream:!0},{...c,signal:this.controller.signal,stream:!0}),f=b.starting_after??null):d=await a.responses.create({...b,stream:!0},{...c,signal:this.controller.signal}),this._connected(),d))a_(this,ao,"m",at).call(this,e,f);if(d.controller.signal?.aborted)throw new a5;return a_(this,ao,"m",au).call(this)}[(ap=new WeakMap,aq=new WeakMap,ar=new WeakMap,ao=new WeakSet,as=function(){this.ended||a$(this,aq,void 0,"f")},at=function(a,b){if(this.ended)return;let c=(a,c)=>{(null==b||c.sequence_number>b)&&this._emit(a,c)},d=a_(this,ao,"m",av).call(this,a);switch(c("event",a),a.type){case"response.output_text.delta":{let b=d.output[a.output_index];if(!b)throw new a3(`missing output at index ${a.output_index}`);if("message"===b.type){let d=b.content[a.content_index];if(!d)throw new a3(`missing content at index ${a.content_index}`);if("output_text"!==d.type)throw new a3(`expected content to be 'output_text', got ${d.type}`);c("response.output_text.delta",{...a,snapshot:d.text})}break}case"response.function_call_arguments.delta":{let b=d.output[a.output_index];if(!b)throw new a3(`missing output at index ${a.output_index}`);"function_call"===b.type&&c("response.function_call_arguments.delta",{...a,snapshot:b.arguments});break}default:c(a.type,a)}},au=function(){if(this.ended)throw new a3("stream has ended, this shouldn't happen");let a=a_(this,aq,"f");if(!a)throw new a3("request ended without sending any events");a$(this,aq,void 0,"f");let b=function(a,b){var c;return b&&(c=b,cl(c.text?.format))?dk(a,b):{...a,output_parsed:null,output:a.output.map(a=>"function_call"===a.type?{...a,parsed_arguments:null}:"message"===a.type?{...a,content:a.content.map(a=>({...a,parsed:null}))}:a)}}(a,a_(this,ap,"f"));return a$(this,ar,b,"f"),b},av=function(a){let b=a_(this,aq,"f");if(!b){if("response.created"!==a.type)throw new a3(`When snapshot hasn't been set yet, expected 'response.created' event, got ${a.type}`);return a$(this,aq,a.response,"f")}switch(a.type){case"response.output_item.added":b.output.push(a.item);break;case"response.content_part.added":{let c=b.output[a.output_index];if(!c)throw new a3(`missing output at index ${a.output_index}`);"message"===c.type&&c.content.push(a.part);break}case"response.output_text.delta":{let c=b.output[a.output_index];if(!c)throw new a3(`missing output at index ${a.output_index}`);if("message"===c.type){let b=c.content[a.content_index];if(!b)throw new a3(`missing content at index ${a.content_index}`);if("output_text"!==b.type)throw new a3(`expected content to be 'output_text', got ${b.type}`);b.text+=a.delta}break}case"response.function_call_arguments.delta":{let c=b.output[a.output_index];if(!c)throw new a3(`missing output at index ${a.output_index}`);"function_call"===c.type&&(c.arguments+=a.delta);break}case"response.completed":a$(this,aq,a.response,"f")}return b},Symbol.asyncIterator)](){let a=[],b=[],c=!1;return this.on("event",c=>{let d=b.shift();d?d.resolve(c):a.push(c)}),this.on("end",()=>{for(let a of(c=!0,b))a.resolve(void 0);b.length=0}),this.on("abort",a=>{for(let d of(c=!0,b))d.reject(a);b.length=0}),this.on("error",a=>{for(let d of(c=!0,b))d.reject(a);b.length=0}),{next:async()=>a.length?{value:a.shift(),done:!1}:c?{value:void 0,done:!0}:new Promise((a,c)=>b.push({resolve:a,reject:c})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();let a=a_(this,ar,"f");if(!a)throw new a3("stream ended without producing a ChatCompletion");return a}}class dn extends cf{list(a,b={},c){return this._client.getAPIList(ci`/responses/${a}/input_items`,b0,{query:b,...c})}}class dp extends cf{constructor(){super(...arguments),this.inputItems=new dn(this._client)}create(a,b){return this._client.post("/responses",{body:a,...b,stream:a.stream??!1})._thenUnwrap(a=>("object"in a&&"response"===a.object&&dl(a),a))}retrieve(a,b={},c){return this._client.get(ci`/responses/${a}`,{query:b,...c,stream:b?.stream??!1})._thenUnwrap(a=>("object"in a&&"response"===a.object&&dl(a),a))}delete(a,b){return this._client.delete(ci`/responses/${a}`,{...b,headers:cF([{Accept:"*/*"},b?.headers])})}parse(a,b){return this._client.responses.create(a,b)._thenUnwrap(b=>dk(b,a))}stream(a,b){return dm.createResponse(this._client,a,b)}cancel(a,b){return this._client.post(ci`/responses/${a}/cancel`,b)}}dp.InputItems=dn;class dq extends cf{create(a,b,c){return this._client.post(ci`/uploads/${a}/parts`,b6({body:b,...c},this._client))}}class dr extends cf{constructor(){super(...arguments),this.parts=new dq(this._client)}create(a,b){return this._client.post("/uploads",{body:a,...b})}cancel(a,b){return this._client.post(ci`/uploads/${a}/cancel`,b)}complete(a,b,c){return this._client.post(ci`/uploads/${a}/complete`,{body:b,...c})}}dr.Parts=dq;let ds=async a=>{let b=await Promise.allSettled(a),c=b.filter(a=>"rejected"===a.status);if(c.length){for(let a of c)console.error(a.reason);throw Error(`${c.length} promise(s) failed - see the above errors`)}let d=[];for(let a of b)"fulfilled"===a.status&&d.push(a.value);return d};class dt extends cf{create(a,b,c){return this._client.post(ci`/vector_stores/${a}/file_batches`,{body:b,...c,headers:cF([{"OpenAI-Beta":"assistants=v2"},c?.headers])})}retrieve(a,b,c){let{vector_store_id:d}=b;return this._client.get(ci`/vector_stores/${d}/file_batches/${a}`,{...c,headers:cF([{"OpenAI-Beta":"assistants=v2"},c?.headers])})}cancel(a,b,c){let{vector_store_id:d}=b;return this._client.post(ci`/vector_stores/${d}/file_batches/${a}/cancel`,{...c,headers:cF([{"OpenAI-Beta":"assistants=v2"},c?.headers])})}async createAndPoll(a,b,c){let d=await this.create(a,b);return await this.poll(a,d.id,c)}listFiles(a,b,c){let{vector_store_id:d,...e}=b;return this._client.getAPIList(ci`/vector_stores/${d}/file_batches/${a}/files`,b0,{query:e,...c,headers:cF([{"OpenAI-Beta":"assistants=v2"},c?.headers])})}async poll(a,b,c){let d=cF([c?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":c?.pollIntervalMs?.toString()??void 0}]);for(;;){let{data:e,response:f}=await this.retrieve(b,{vector_store_id:a},{...c,headers:d}).withResponse();switch(e.status){case"in_progress":let g=5e3;if(c?.pollIntervalMs)g=c.pollIntervalMs;else{let a=f.headers.get("openai-poll-after-ms");if(a){let b=parseInt(a);isNaN(b)||(g=b)}}await bo(g);break;case"failed":case"cancelled":case"completed":return e}}}async uploadAndPoll(a,{files:b,fileIds:c=[]},d){if(null==b||0==b.length)throw Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");let e=Math.min(d?.maxConcurrency??5,b.length),f=this._client,g=b.values(),h=[...c];async function i(a){for(let b of a){let a=await f.files.create({file:b,purpose:"assistants"},d);h.push(a.id)}}let j=Array(e).fill(g).map(i);return await ds(j),await this.createAndPoll(a,{file_ids:h})}}class du extends cf{create(a,b,c){return this._client.post(ci`/vector_stores/${a}/files`,{body:b,...c,headers:cF([{"OpenAI-Beta":"assistants=v2"},c?.headers])})}retrieve(a,b,c){let{vector_store_id:d}=b;return this._client.get(ci`/vector_stores/${d}/files/${a}`,{...c,headers:cF([{"OpenAI-Beta":"assistants=v2"},c?.headers])})}update(a,b,c){let{vector_store_id:d,...e}=b;return this._client.post(ci`/vector_stores/${d}/files/${a}`,{body:e,...c,headers:cF([{"OpenAI-Beta":"assistants=v2"},c?.headers])})}list(a,b={},c){return this._client.getAPIList(ci`/vector_stores/${a}/files`,b0,{query:b,...c,headers:cF([{"OpenAI-Beta":"assistants=v2"},c?.headers])})}delete(a,b,c){let{vector_store_id:d}=b;return this._client.delete(ci`/vector_stores/${d}/files/${a}`,{...c,headers:cF([{"OpenAI-Beta":"assistants=v2"},c?.headers])})}async createAndPoll(a,b,c){let d=await this.create(a,b,c);return await this.poll(a,d.id,c)}async poll(a,b,c){let d=cF([c?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":c?.pollIntervalMs?.toString()??void 0}]);for(;;){let e=await this.retrieve(b,{vector_store_id:a},{...c,headers:d}).withResponse(),f=e.data;switch(f.status){case"in_progress":let g=5e3;if(c?.pollIntervalMs)g=c.pollIntervalMs;else{let a=e.response.headers.get("openai-poll-after-ms");if(a){let b=parseInt(a);isNaN(b)||(g=b)}}await bo(g);break;case"failed":case"completed":return f}}}async upload(a,b,c){let d=await this._client.files.create({file:b,purpose:"assistants"},c);return this.create(a,{file_id:d.id},c)}async uploadAndPoll(a,b,c){let d=await this.upload(a,b,c);return await this.poll(a,d.id,c)}content(a,b,c){let{vector_store_id:d}=b;return this._client.getAPIList(ci`/vector_stores/${d}/files/${a}/content`,b_,{...c,headers:cF([{"OpenAI-Beta":"assistants=v2"},c?.headers])})}}class dv extends cf{constructor(){super(...arguments),this.files=new du(this._client),this.fileBatches=new dt(this._client)}create(a,b){return this._client.post("/vector_stores",{body:a,...b,headers:cF([{"OpenAI-Beta":"assistants=v2"},b?.headers])})}retrieve(a,b){return this._client.get(ci`/vector_stores/${a}`,{...b,headers:cF([{"OpenAI-Beta":"assistants=v2"},b?.headers])})}update(a,b,c){return this._client.post(ci`/vector_stores/${a}`,{body:b,...c,headers:cF([{"OpenAI-Beta":"assistants=v2"},c?.headers])})}list(a={},b){return this._client.getAPIList("/vector_stores",b0,{query:a,...b,headers:cF([{"OpenAI-Beta":"assistants=v2"},b?.headers])})}delete(a,b){return this._client.delete(ci`/vector_stores/${a}`,{...b,headers:cF([{"OpenAI-Beta":"assistants=v2"},b?.headers])})}search(a,b,c){return this._client.getAPIList(ci`/vector_stores/${a}/search`,b_,{body:b,method:"post",...c,headers:cF([{"OpenAI-Beta":"assistants=v2"},c?.headers])})}}dv.Files=du,dv.FileBatches=dt;class dw extends cf{constructor(){super(...arguments),aw.add(this)}async unwrap(a,b,c=this._client.webhookSecret,d=300){return await this.verifySignature(a,b,c,d),JSON.parse(a)}async verifySignature(a,b,c=this._client.webhookSecret,d=300){if("undefined"==typeof crypto||"function"!=typeof crypto.subtle.importKey||"function"!=typeof crypto.subtle.verify)throw Error("Webhook signature verification is only supported when the `crypto` global is defined");a_(this,aw,"m",ax).call(this,c);let e=cF([b]).values,f=a_(this,aw,"m",ay).call(this,e,"webhook-signature"),g=a_(this,aw,"m",ay).call(this,e,"webhook-timestamp"),h=a_(this,aw,"m",ay).call(this,e,"webhook-id"),i=parseInt(g,10);if(isNaN(i))throw new bi("Invalid webhook timestamp format");let j=Math.floor(Date.now()/1e3);if(j-i>d)throw new bi("Webhook timestamp is too old");if(i>j+d)throw new bi("Webhook timestamp is too new");let k=f.split(" ").map(a=>a.startsWith("v1,")?a.substring(3):a),l=c.startsWith("whsec_")?Buffer.from(c.replace("whsec_",""),"base64"):Buffer.from(c,"utf-8"),m=h?`${h}.${g}.${a}`:`${g}.${a}`,n=await crypto.subtle.importKey("raw",l,{name:"HMAC",hash:"SHA-256"},!1,["verify"]);for(let a of k)try{let b=Buffer.from(a,"base64");if(await crypto.subtle.verify("HMAC",n,b,new TextEncoder().encode(m)))return}catch{continue}throw new bi("The given webhook signature does not match the expected signature")}}aw=new WeakSet,ax=function(a){if("string"!=typeof a||0===a.length)throw Error("The webhook secret must either be set using the env var, OPENAI_WEBHOOK_SECRET, on the client class, OpenAI({ webhookSecret: '123' }), or passed to this function")},ay=function(a,b){if(!a)throw Error("Headers are required");let c=a.get(b);if(null==c)throw Error(`Missing required header: ${b}`);return c};class dx{constructor({baseURL:a=cR("OPENAI_BASE_URL"),apiKey:b=cR("OPENAI_API_KEY"),organization:c=cR("OPENAI_ORG_ID")??null,project:d=cR("OPENAI_PROJECT_ID")??null,webhookSecret:e=cR("OPENAI_WEBHOOK_SECRET")??null,...f}={}){if(az.add(this),aB.set(this,void 0),this.completions=new cW(this),this.chat=new cD(this),this.embeddings=new c0(this),this.files=new c4(this),this.images=new df(this),this.audio=new cJ(this),this.moderations=new dh(this),this.models=new dg(this),this.fineTuning=new dc(this),this.graders=new de(this),this.vectorStores=new dv(this),this.webhooks=new dw(this),this.beta=new cV(this),this.batches=new cK(this),this.uploads=new dr(this),this.responses=new dp(this),this.realtime=new dj(this),this.conversations=new c_(this),this.evals=new c3(this),this.containers=new cZ(this),void 0===b)throw new a3("Missing credentials. Please pass an `apiKey`, or set the `OPENAI_API_KEY` environment variable.");let g={apiKey:b,organization:c,project:d,webhookSecret:e,...f,baseURL:a||"https://api.openai.com/v1"};if(!g.dangerouslyAllowBrowser&&"undefined"!=typeof window&&void 0!==window.document&&"undefined"!=typeof navigator)throw new a3("It looks like you're running in a browser-like environment.\n\nThis is disabled by default, as it risks exposing your secret API credentials to attackers.\nIf you understand the risks and have appropriate mitigations in place,\nyou can set the `dangerouslyAllowBrowser` option to `true`, e.g.,\n\nnew OpenAI({ apiKey, dangerouslyAllowBrowser: true });\n\nhttps://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety\n");this.baseURL=g.baseURL,this.timeout=g.timeout??aA.DEFAULT_TIMEOUT,this.logger=g.logger??console;let h="warn";this.logLevel=h,this.logLevel=bL(g.logLevel,"ClientOptions.logLevel",this)??bL(cR("OPENAI_LOG"),"process.env['OPENAI_LOG']",this)??h,this.fetchOptions=g.fetchOptions,this.maxRetries=g.maxRetries??2,this.fetch=g.fetch??function(){if("undefined"!=typeof fetch)return fetch;throw Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new OpenAI({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}(),a$(this,aB,bw,"f"),this._options=g,this.apiKey="string"==typeof b?b:"Missing Key",this.organization=c,this.project=d,this.webhookSecret=e}withOptions(a){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,organization:this.organization,project:this.project,webhookSecret:this.webhookSecret,...a})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:a,nulls:b}){}async authHeaders(a){return cF([{Authorization:`Bearer ${this.apiKey}`}])}stringifyQuery(a){return function(a,b={}){let c,d=a,e=function(a=bF){let b;if(void 0!==a.allowEmptyArrays&&"boolean"!=typeof a.allowEmptyArrays)throw TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(void 0!==a.encodeDotInKeys&&"boolean"!=typeof a.encodeDotInKeys)throw TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(null!==a.encoder&&void 0!==a.encoder&&"function"!=typeof a.encoder)throw TypeError("Encoder has to be a function.");let c=a.charset||bF.charset;if(void 0!==a.charset&&"utf-8"!==a.charset&&"iso-8859-1"!==a.charset)throw TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let d=bx;if(void 0!==a.format){if(!bA(bz,a.format))throw TypeError("Unknown format option provided.");d=a.format}let e=bz[d],f=bF.filter;if(("function"==typeof a.filter||bk(a.filter))&&(f=a.filter),b=a.arrayFormat&&a.arrayFormat in bD?a.arrayFormat:"indices"in a?a.indices?"indices":"repeat":bF.arrayFormat,"commaRoundTrip"in a&&"boolean"!=typeof a.commaRoundTrip)throw TypeError("`commaRoundTrip` must be a boolean, or absent");let g=void 0===a.allowDots?!0==!!a.encodeDotInKeys||bF.allowDots:!!a.allowDots;return{addQueryPrefix:"boolean"==typeof a.addQueryPrefix?a.addQueryPrefix:bF.addQueryPrefix,allowDots:g,allowEmptyArrays:"boolean"==typeof a.allowEmptyArrays?!!a.allowEmptyArrays:bF.allowEmptyArrays,arrayFormat:b,charset:c,charsetSentinel:"boolean"==typeof a.charsetSentinel?a.charsetSentinel:bF.charsetSentinel,commaRoundTrip:!!a.commaRoundTrip,delimiter:void 0===a.delimiter?bF.delimiter:a.delimiter,encode:"boolean"==typeof a.encode?a.encode:bF.encode,encodeDotInKeys:"boolean"==typeof a.encodeDotInKeys?a.encodeDotInKeys:bF.encodeDotInKeys,encoder:"function"==typeof a.encoder?a.encoder:bF.encoder,encodeValuesOnly:"boolean"==typeof a.encodeValuesOnly?a.encodeValuesOnly:bF.encodeValuesOnly,filter:f,format:d,formatter:e,serializeDate:"function"==typeof a.serializeDate?a.serializeDate:bF.serializeDate,skipNulls:"boolean"==typeof a.skipNulls?a.skipNulls:bF.skipNulls,sort:"function"==typeof a.sort?a.sort:null,strictNullHandling:"boolean"==typeof a.strictNullHandling?a.strictNullHandling:bF.strictNullHandling}}(b);"function"==typeof e.filter?d=(0,e.filter)("",d):bk(e.filter)&&(c=e.filter);let f=[];if("object"!=typeof d||null===d)return"";let g=bD[e.arrayFormat],h="comma"===g&&e.commaRoundTrip;c||(c=Object.keys(d)),e.sort&&c.sort(e.sort);let i=new WeakMap;for(let a=0;a<c.length;++a){let b=c[a];e.skipNulls&&null===d[b]||bE(f,function a(b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s){var t,u;let v,w=b,x=s,y=0,z=!1;for(;void 0!==(x=x.get(bG))&&!z;){let a=x.get(b);if(y+=1,void 0!==a)if(a===y)throw RangeError("Cyclic object value");else z=!0;void 0===x.get(bG)&&(y=0)}if("function"==typeof k?w=k(c,w):w instanceof Date?w=n?.(w):"comma"===d&&bk(w)&&(w=bC(w,function(a){return a instanceof Date?n?.(a):a})),null===w){if(g)return j&&!q?j(c,bF.encoder,r,"key",o):c;w=""}if("string"==typeof(t=w)||"number"==typeof t||"boolean"==typeof t||"symbol"==typeof t||"bigint"==typeof t||(u=w)&&"object"==typeof u&&u.constructor&&u.constructor.isBuffer&&u.constructor.isBuffer(u)){if(j){let a=q?c:j(c,bF.encoder,r,"key",o);return[p?.(a)+"="+p?.(j(w,bF.encoder,r,"value",o))]}return[p?.(c)+"="+p?.(String(w))]}let A=[];if(void 0===w)return A;if("comma"===d&&bk(w))q&&j&&(w=bC(w,j)),v=[{value:w.length>0?w.join(",")||null:void 0}];else if(bk(k))v=k;else{let a=Object.keys(w);v=l?a.sort(l):a}let B=i?String(c).replace(/\./g,"%2E"):String(c),C=e&&bk(w)&&1===w.length?B+"[]":B;if(f&&bk(w)&&0===w.length)return C+"[]";for(let c=0;c<v.length;++c){let t=v[c],u="object"==typeof t&&void 0!==t.value?t.value:w[t];if(h&&null===u)continue;let x=m&&i?t.replace(/\./g,"%2E"):t,z=bk(w)?"function"==typeof d?d(C,x):C:C+(m?"."+x:"["+x+"]");s.set(b,y);let B=new WeakMap;B.set(bG,s),bE(A,a(u,z,d,e,f,g,h,i,"comma"===d&&q&&bk(w)?null:j,k,l,m,n,o,p,q,r,B))}return A}(d[b],b,g,h,e.allowEmptyArrays,e.strictNullHandling,e.skipNulls,e.encodeDotInKeys,e.encode?e.encoder:null,e.filter,e.sort,e.allowDots,e.serializeDate,e.format,e.formatter,e.encodeValuesOnly,e.charset,i))}let j=f.join(e.delimiter),k=!0===e.addQueryPrefix?"?":"";return e.charsetSentinel&&("iso-8859-1"===e.charset?k+="utf8=%26%2310003%3B&":k+="utf8=%E2%9C%93&"),j.length>0?k+j:""}(a,{arrayFormat:"brackets"})}getUserAgent(){return`${this.constructor.name}/JS ${bp}`}defaultIdempotencyKey(){return`stainless-node-retry-${a0()}`}makeStatusError(a,b,c,d){return a4.generate(a,b,c,d)}async _callApiKey(){let a,b=this._options.apiKey;if("function"!=typeof b)return!1;try{a=await b()}catch(a){if(a instanceof a3)throw a;throw new a3(`Failed to get token from 'apiKey' function: ${a.message}`,{cause:a})}if("string"!=typeof a||!a)throw new a3(`Expected 'apiKey' function argument to return a string but it returned ${a}`);return this.apiKey=a,!0}buildURL(a,b,c){let d=!a_(this,az,"m",aC).call(this)&&c||this.baseURL,e=new URL(bj.test(a)?a:d+(d.endsWith("/")&&a.startsWith("/")?a.slice(1):a)),f=this.defaultQuery();return!function(a){if(!a)return!0;for(let b in a)return!1;return!0}(f)&&(b={...f,...b}),"object"==typeof b&&b&&!Array.isArray(b)&&(e.search=this.stringifyQuery(b)),e.toString()}async prepareOptions(a){await this._callApiKey()}async prepareRequest(a,{url:b,options:c}){}get(a,b){return this.methodRequest("get",a,b)}post(a,b){return this.methodRequest("post",a,b)}patch(a,b){return this.methodRequest("patch",a,b)}put(a,b){return this.methodRequest("put",a,b)}delete(a,b){return this.methodRequest("delete",a,b)}methodRequest(a,b,c){return this.request(Promise.resolve(c).then(c=>({method:a,path:b,...c})))}request(a,b=null){return new bY(this,this.makeRequest(a,b,void 0))}async makeRequest(a,b,c){let d=await a,e=d.maxRetries??this.maxRetries;null==b&&(b=e),await this.prepareOptions(d);let{req:f,url:g,timeout:h}=await this.buildRequest(d,{retryCount:e-b});await this.prepareRequest(f,{url:g,options:d});let i="log_"+(0x1000000*Math.random()|0).toString(16).padStart(6,"0"),j=void 0===c?"":`, retryOf: ${c}`,k=Date.now();if(bQ(this).debug(`[${i}] sending request`,bR({retryOfRequestLogID:c,method:d.method,url:g,options:d,headers:f.headers})),d.signal?.aborted)throw new a5;let l=new AbortController,m=await this.fetchWithTimeout(g,f,h,l).catch(a2),n=Date.now();if(m instanceof globalThis.Error){let a=`retrying, ${b} attempts remaining`;if(d.signal?.aborted)throw new a5;let e=a1(m)||/timed? ?out/i.test(String(m)+("cause"in m?String(m.cause):""));if(b)return bQ(this).info(`[${i}] connection ${e?"timed out":"failed"} - ${a}`),bQ(this).debug(`[${i}] connection ${e?"timed out":"failed"} (${a})`,bR({retryOfRequestLogID:c,url:g,durationMs:n-k,message:m.message})),this.retryRequest(d,b,c??i);if(bQ(this).info(`[${i}] connection ${e?"timed out":"failed"} - error; no more retries left`),bQ(this).debug(`[${i}] connection ${e?"timed out":"failed"} (error; no more retries left)`,bR({retryOfRequestLogID:c,url:g,durationMs:n-k,message:m.message})),e)throw new a7;throw new a6({cause:m})}let o=[...m.headers.entries()].filter(([a])=>"x-request-id"===a).map(([a,b])=>", "+a+": "+JSON.stringify(b)).join(""),p=`[${i}${j}${o}] ${f.method} ${g} ${m.ok?"succeeded":"failed"} with status ${m.status} in ${n-k}ms`;if(!m.ok){let a=await this.shouldRetry(m);if(b&&a){let a=`retrying, ${b} attempts remaining`;return await bv(m.body),bQ(this).info(`${p} - ${a}`),bQ(this).debug(`[${i}] response error (${a})`,bR({retryOfRequestLogID:c,url:m.url,status:m.status,headers:m.headers,durationMs:n-k})),this.retryRequest(d,b,c??i,m.headers)}let e=a?"error; no more retries left":"error; not retryable";bQ(this).info(`${p} - ${e}`);let f=await m.text().catch(a=>a2(a).message),g=(a=>{try{return JSON.parse(a)}catch(a){return}})(f),h=g?void 0:f;throw bQ(this).debug(`[${i}] response error (${e})`,bR({retryOfRequestLogID:c,url:m.url,status:m.status,headers:m.headers,message:h,durationMs:Date.now()-k})),this.makeStatusError(m.status,g,h,m.headers)}return bQ(this).info(p),bQ(this).debug(`[${i}] response start`,bR({retryOfRequestLogID:c,url:m.url,status:m.status,headers:m.headers,durationMs:n-k})),{response:m,options:d,controller:l,requestLogID:i,retryOfRequestLogID:c,startTime:k}}getAPIList(a,b,c){return this.requestAPIList(b,{method:"get",path:a,...c})}requestAPIList(a,b){return new b$(this,this.makeRequest(b,null,void 0),a)}async fetchWithTimeout(a,b,c,d){let{signal:e,method:f,...g}=b||{};e&&e.addEventListener("abort",()=>d.abort());let h=setTimeout(()=>d.abort(),c),i=globalThis.ReadableStream&&g.body instanceof globalThis.ReadableStream||"object"==typeof g.body&&null!==g.body&&Symbol.asyncIterator in g.body,j={signal:d.signal,...i?{duplex:"half"}:{},method:"GET",...g};f&&(j.method=f.toUpperCase());try{return await this.fetch.call(void 0,a,j)}finally{clearTimeout(h)}}async shouldRetry(a){let b=a.headers.get("x-should-retry");return"true"===b||"false"!==b&&(408===a.status||409===a.status||429===a.status||!!(a.status>=500))}async retryRequest(a,b,c,d){let e,f=d?.get("retry-after-ms");if(f){let a=parseFloat(f);Number.isNaN(a)||(e=a)}let g=d?.get("retry-after");if(g&&!e){let a=parseFloat(g);e=Number.isNaN(a)?Date.parse(g)-Date.now():1e3*a}if(!(e&&0<=e&&e<6e4)){let c=a.maxRetries??this.maxRetries;e=this.calculateDefaultRetryTimeoutMillis(b,c)}return await bo(e),this.makeRequest(a,b-1,c)}calculateDefaultRetryTimeoutMillis(a,b){return Math.min(.5*Math.pow(2,b-a),8)*(1-.25*Math.random())*1e3}async buildRequest(a,{retryCount:b=0}={}){let c={...a},{method:d,path:e,query:f,defaultBaseURL:g}=c,h=this.buildURL(e,f,g);"timeout"in c&&((a,b)=>{if("number"!=typeof b||!Number.isInteger(b))throw new a3(`${a} must be an integer`);if(b<0)throw new a3(`${a} must be a positive integer`)})("timeout",c.timeout),c.timeout=c.timeout??this.timeout;let{bodyHeaders:i,body:j}=this.buildBody({options:c}),k=await this.buildHeaders({options:a,method:d,bodyHeaders:i,retryCount:b});return{req:{method:d,headers:k,...c.signal&&{signal:c.signal},...globalThis.ReadableStream&&j instanceof globalThis.ReadableStream&&{duplex:"half"},...j&&{body:j},...this.fetchOptions??{},...c.fetchOptions??{}},url:h,timeout:c.timeout}}async buildHeaders({options:a,method:b,bodyHeaders:c,retryCount:e}){let f={};this.idempotencyHeader&&"get"!==b&&(a.idempotencyKey||(a.idempotencyKey=this.defaultIdempotencyKey()),f[this.idempotencyHeader]=a.idempotencyKey);let g=cF([f,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(e),...a.timeout?{"X-Stainless-Timeout":String(Math.trunc(a.timeout/1e3))}:{},...d??(d=(()=>{let a="undefined"!=typeof Deno&&null!=Deno.build?"deno":"undefined"!=typeof EdgeRuntime?"edge":"[object process]"===Object.prototype.toString.call(void 0!==globalThis.process?globalThis.process:0)?"node":"unknown";if("deno"===a)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":bp,"X-Stainless-OS":br(Deno.build.os),"X-Stainless-Arch":bq(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:Deno.version?.deno??"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":bp,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if("node"===a)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":bp,"X-Stainless-OS":br(globalThis.process.platform??"unknown"),"X-Stainless-Arch":bq(globalThis.process.arch??"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version??"unknown"};let b=function(){if("undefined"==typeof navigator||!navigator)return null;for(let{key:a,pattern:b}of[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}]){let c=b.exec(navigator.userAgent);if(c){let b=c[1]||0,d=c[2]||0,e=c[3]||0;return{browser:a,version:`${b}.${d}.${e}`}}}return null}();return b?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":bp,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${b.browser}`,"X-Stainless-Runtime-Version":b.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":bp,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}})()),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project},await this.authHeaders(a),this._options.defaultHeaders,c,a.headers]);return this.validateHeaders(g),g.values}buildBody({options:{body:a,headers:b}}){if(!a)return{bodyHeaders:void 0,body:void 0};let c=cF([b]);return ArrayBuffer.isView(a)||a instanceof ArrayBuffer||a instanceof DataView||"string"==typeof a&&c.values.has("content-type")||globalThis.Blob&&a instanceof globalThis.Blob||a instanceof FormData||a instanceof URLSearchParams||globalThis.ReadableStream&&a instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:a}:"object"==typeof a&&(Symbol.asyncIterator in a||Symbol.iterator in a&&"next"in a&&"function"==typeof a.next)?{bodyHeaders:void 0,body:bt(a)}:a_(this,aB,"f").call(this,{body:a,headers:c})}}async function dy(a,{params:b}){try{let{userId:a}=await (0,aU.j)();if(!a)return aV.NextResponse.json({error:"Unauthorized"},{status:401});let{id:c}=await b,d=aZ(),{data:e}=await d.from("users").select("id, current_workspace_id").eq("clerk_id",a).single();if(!e)return aV.NextResponse.json({error:"User not found"},{status:404});let{data:f}=await d.from("sam_conversations").select("id").eq("id",c).eq("workspace_id",e.current_workspace_id).eq("user_id",e.id).single();if(!f)return aV.NextResponse.json({error:"Conversation not found"},{status:404});let{data:g,error:h}=await d.from("sam_conversation_messages").select(`
        id,
        role,
        content,
        model_used,
        token_count,
        processing_time_ms,
        confidence_score,
        relevance_score,
        message_order,
        metadata,
        created_at
      `).eq("conversation_id",c).eq("tenant_id",e.current_workspace_id).order("message_order",{ascending:!0});if(h)return console.error("Error fetching messages:",h),aV.NextResponse.json({error:h.message},{status:400});return aV.NextResponse.json({messages:g})}catch(a){return console.error("Error in messages GET:",a),aV.NextResponse.json({error:"Internal server error"},{status:500})}}async function dz(a,{params:b}){try{let{userId:c}=await (0,aU.j)();if(!c)return aV.NextResponse.json({error:"Unauthorized"},{status:401});let{id:d}=await b,{content:e}=await a.json();if(!e?.trim())return aV.NextResponse.json({error:"Message content required"},{status:400});let f=aZ(),{data:g}=await f.from("users").select("id, current_workspace_id").eq("clerk_id",c).single();if(!g)return aV.NextResponse.json({error:"User not found"},{status:404});let{data:h}=await f.from("sam_conversations").select("id, current_discovery_stage, conversation_context, business_profile").eq("id",d).eq("workspace_id",g.current_workspace_id).eq("user_id",g.id).single();if(!h)return aV.NextResponse.json({error:"Conversation not found"},{status:404});let{data:i}=await f.from("sam_conversation_messages").select("message_order").eq("conversation_id",d).order("message_order",{ascending:!1}).limit(1).single(),j=(i?.message_order||0)+1,{data:k,error:l}=await f.from("sam_conversation_messages").insert({conversation_id:d,tenant_id:g.current_workspace_id,role:"user",content:e.trim(),message_order:j,metadata:{}}).select().single();if(l)return console.error("Error storing user message:",l),aV.NextResponse.json({error:l.message},{status:400});let m="",n="fallback",o=Date.now();try{let a=process.env.OPENROUTER_API_KEY;if(a&&"your_openrouter_api_key_here"!==a){let b=new dx({apiKey:a,baseURL:"https://openrouter.ai/api/v1",defaultHeaders:{"HTTP-Referer":"https://app.meet-sam.com","X-Title":"SAM AI Sales Assistant"}}),{data:c}=await f.from("sam_conversation_messages").select("role, content").eq("conversation_id",d).order("message_order",{ascending:!1}).limit(10),g=c?.reverse().map(a=>({role:a.role,content:a.content}))||[],h=`You are Sam, an expert AI sales assistant. Your role is to help users with all aspects of sales, lead management, customer relationships, and business growth.

Key traits:
- Professional yet friendly and approachable
- Expert in sales methodology, CRM, lead qualification
- Provide actionable, specific advice
- Ask clarifying questions to better understand needs
- Reference best practices from sales industry

Context: This is a multi-tenant sales platform. The user is working in their own workspace with their own data and leads.

Keep responses focused, helpful, and sales-oriented. If the user asks about non-sales topics, gently redirect to how you can help with their sales objectives.`,i=await b.chat.completions.create({model:"anthropic/claude-3.5-sonnet",messages:[{role:"system",content:h},...g,{role:"user",content:e.trim()}],max_tokens:800,temperature:.7});m=i.choices[0]?.message?.content||"I apologize, but I encountered an issue generating a response. Please try again.",n="anthropic/claude-3.5-sonnet"}else m=`Hi! I'm Sam, your AI sales assistant. I understand you said: "${e.trim()}"

I'm here to help you with:
 Sales process optimization
 Lead qualification and management  
 Customer relationship insights
 Pipeline analysis and forecasting
 Sales strategy development

To enable my full AI capabilities, please add your OpenRouter API key to the environment. For now, I can still help with general sales guidance - what specific sales challenge can I assist you with today?`,n="fallback"}catch(a){console.error("OpenRouter API Error:",a),m=`I'm experiencing some technical difficulties right now. As your AI sales assistant, I'm still here to help! 

You mentioned: "${e.trim()}"

While I resolve this issue, I can still provide general sales guidance. What specific sales challenge are you working on? I can help with lead qualification, pipeline management, customer relationship strategies, or sales process optimization.`,n="error-fallback"}let p=Date.now()-o,{data:q,error:r}=await f.from("sam_conversation_messages").insert({conversation_id:d,tenant_id:g.current_workspace_id,role:"assistant",content:m,model_used:n,processing_time_ms:p,message_order:j+1,confidence_score:"fallback"===n?.6:.9,relevance_score:"fallback"===n?.7:.85,metadata:{using_openrouter:"fallback"!==n,api_configured:"your_openrouter_api_key_here"!==process.env.OPENROUTER_API_KEY}}).select().single();if(r)return console.error("Error storing Sam message:",r),aV.NextResponse.json({error:r.message},{status:400});return await f.from("sam_conversations").update({last_user_message:e.trim(),last_sam_message:m,last_active_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",d),aV.NextResponse.json({userMessage:k,samMessage:q,success:!0})}catch(a){return console.error("Error in messages POST:",a),aV.NextResponse.json({error:"Internal server error"},{status:500})}}aA=dx,aB=new WeakMap,az=new WeakSet,aC=function(){return"https://api.openai.com/v1"!==this.baseURL},dx.OpenAI=aA,dx.DEFAULT_TIMEOUT=6e5,dx.OpenAIError=a3,dx.APIError=a4,dx.APIConnectionError=a6,dx.APIConnectionTimeoutError=a7,dx.APIUserAbortError=a5,dx.NotFoundError=bb,dx.ConflictError=bc,dx.RateLimitError=be,dx.BadRequestError=a8,dx.AuthenticationError=a9,dx.InternalServerError=bf,dx.PermissionDeniedError=ba,dx.UnprocessableEntityError=bd,dx.InvalidWebhookSignatureError=bi,dx.toFile=cd,dx.Completions=cW,dx.Chat=cD,dx.Embeddings=c0,dx.Files=c4,dx.Images=df,dx.Audio=cJ,dx.Moderations=dh,dx.Models=dg,dx.FineTuning=dc,dx.Graders=de,dx.VectorStores=dv,dx.Webhooks=dw,dx.Beta=cV,dx.Batches=cK,dx.Uploads=dr,dx.Responses=dp,dx.Realtime=dj,dx.Conversations=c_,dx.Evals=c3,dx.Containers=cZ;let dA=new aE.AppRouteRouteModule({definition:{kind:aF.RouteKind.APP_ROUTE,page:"/api/sam/conversations/[id]/messages/route",pathname:"/api/sam/conversations/[id]/messages",filename:"route",bundlePath:"app/api/sam/conversations/[id]/messages/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"/Users/tvonlinz/Dev_Master/InnovareAI/Sam-New-Sep-7/app/api/sam/conversations/[id]/messages/route.ts",nextConfigOutput:"standalone",userland:aD}),{workAsyncStorage:dB,workUnitAsyncStorage:dC,serverHooks:dD}=dA;function dE(){return(0,aG.patchFetch)({workAsyncStorage:dB,workUnitAsyncStorage:dC})}async function dF(a,b,c){var d;let e="/api/sam/conversations/[id]/messages/route";"/index"===e&&(e="/");let f=await dA.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!f)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:g,params:h,nextConfig:i,isDraftMode:j,prerenderManifest:k,routerServerContext:l,isOnDemandRevalidate:m,revalidateOnlyGenerated:n,resolvedPathname:o}=f,p=(0,aJ.normalizeAppPath)(e),q=!!(k.dynamicRoutes[p]||k.routes[o]);if(q&&!j){let a=!!k.routes[o],b=k.dynamicRoutes[p];if(b&&!1===b.fallback&&!a)throw new aS.NoFallbackError}let r=null;!q||dA.isDev||j||(r="/index"===(r=o)?"/":r);let s=!0===dA.isDev||!q,t=q&&!s,u=a.method||"GET",v=(0,aI.getTracer)(),w=v.getActiveScopeSpan(),x={params:h,prerenderManifest:k,renderOpts:{experimental:{cacheComponents:!!i.experimental.cacheComponents,authInterrupts:!!i.experimental.authInterrupts},supportsDynamicResponse:s,incrementalCache:(0,aH.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=i.experimental)?void 0:d.cacheLife,isRevalidate:t,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>dA.onRequestError(a,b,d,l)},sharedContext:{buildId:g}},y=new aK.NodeNextRequest(a),z=new aK.NodeNextResponse(b),A=aL.NextRequestAdapter.fromNodeNextRequest(y,(0,aL.signalFromNodeResponse)(b));try{let d=async c=>dA.handle(A,x).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=v.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==aM.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${u} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${u} ${a.url}`)}),f=async f=>{var g,h;let o=async({previousCacheEntry:g})=>{try{if(!(0,aH.getRequestMeta)(a,"minimalMode")&&m&&n&&!g)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(f);a.fetchMetrics=x.renderOpts.fetchMetrics;let h=x.renderOpts.pendingWaitUntil;h&&c.waitUntil&&(c.waitUntil(h),h=void 0);let i=x.renderOpts.collectedTags;if(!q)return await (0,aO.I)(y,z,e,x.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,aP.toNodeOutgoingHttpHeaders)(e.headers);i&&(b[aR.NEXT_CACHE_TAGS_HEADER]=i),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==x.renderOpts.collectedRevalidate&&!(x.renderOpts.collectedRevalidate>=aR.INFINITE_CACHE)&&x.renderOpts.collectedRevalidate,d=void 0===x.renderOpts.collectedExpire||x.renderOpts.collectedExpire>=aR.INFINITE_CACHE?void 0:x.renderOpts.collectedExpire;return{value:{kind:aT.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==g?void 0:g.isStale)&&await dA.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,aN.c)({isRevalidate:t,isOnDemandRevalidate:m})},l),b}},p=await dA.handleResponse({req:a,nextConfig:i,cacheKey:r,routeKind:aF.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:k,isRoutePPREnabled:!1,isOnDemandRevalidate:m,revalidateOnlyGenerated:n,responseGenerator:o,waitUntil:c.waitUntil});if(!q)return null;if((null==p||null==(g=p.value)?void 0:g.kind)!==aT.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==p||null==(h=p.value)?void 0:h.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,aH.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",m?"REVALIDATED":p.isMiss?"MISS":p.isStale?"STALE":"HIT"),j&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let s=(0,aP.fromNodeOutgoingHttpHeaders)(p.value.headers);return(0,aH.getRequestMeta)(a,"minimalMode")&&q||s.delete(aR.NEXT_CACHE_TAGS_HEADER),!p.cacheControl||b.getHeader("Cache-Control")||s.get("Cache-Control")||s.set("Cache-Control",(0,aQ.getCacheControlHeader)(p.cacheControl)),await (0,aO.I)(y,z,new Response(p.value.body,{headers:s,status:p.value.status||200})),null};w?await f(w):await v.withPropagatedContext(a.headers,()=>v.trace(aM.BaseServerSpan.handleRequest,{spanName:`${u} ${a.url}`,kind:aI.SpanKind.SERVER,attributes:{"http.method":u,"http.target":a.url}},f))}catch(b){if(w||b instanceof aS.NoFallbackError||await dA.onRequestError(a,b,{routerKind:"App Router",routePath:p,routeType:"route",revalidateReason:(0,aN.c)({isRevalidate:t,isOnDemandRevalidate:m})}),q)throw b;return await (0,aO.I)(y,z,new Response(null,{status:500})),null}}},19121:a=>{"use strict";a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},27910:a=>{"use strict";a.exports=require("stream")},29294:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55591:a=>{"use strict";a.exports=require("https")},63033:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},73024:a=>{"use strict";a.exports=require("node:fs")},74075:a=>{"use strict";a.exports=require("zlib")},76760:a=>{"use strict";a.exports=require("node:path")},77598:a=>{"use strict";a.exports=require("node:crypto")},78335:()=>{},79551:a=>{"use strict";a.exports=require("url")},81630:a=>{"use strict";a.exports=require("http")},86439:a=>{"use strict";a.exports=require("next/dist/shared/lib/no-fallback-error.external")},96487:()=>{}};var b=require("../../../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[996,641,698,856],()=>b(b.s=18389));module.exports=c})();