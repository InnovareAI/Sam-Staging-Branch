#!/bin/bash

# Enhanced Restore Point Script with Supabase PITR Support
# Creates both Git snapshot and records database timestamp for PITR

DESCRIPTION="${1:-Restore point}"
TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
TIMESTAMP_FILE=$(date -u +"%Y%m%d_%H%M%S")

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ“¸ Creating Restore Point"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ðŸ“ Description: $DESCRIPTION"
echo "ðŸ•’ Database Timestamp: $TIMESTAMP"
echo ""

# Create git commit
git add -A
git commit -m "Restore point: $DESCRIPTION"

COMMIT_HASH=$(git rev-parse HEAD)

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… Restore Point Created"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Git Commit: $COMMIT_HASH"
echo "DB Timestamp: $TIMESTAMP"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ“‹ To Restore This State:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "1ï¸âƒ£  Restore Code:"
echo "    git checkout $COMMIT_HASH"
echo ""
echo "2ï¸âƒ£  Restore Database (Supabase Pro PITR):"
echo "    â€¢ Go to: https://supabase.com/dashboard/project/latxadqrvrrrcvkktrog"
echo "    â€¢ Settings â†’ Database â†’ Backups â†’ Point-in-Time Recovery"
echo "    â€¢ Select time: $TIMESTAMP"
echo "    â€¢ Click Restore"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Save restore instructions
mkdir -p .restore-points
cat > ".restore-points/restore-$TIMESTAMP_FILE.txt" <<EOF
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
RESTORE POINT: $DESCRIPTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Created: $TIMESTAMP
Git Commit: $COMMIT_HASH

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TO RESTORE THIS STATE:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. RESTORE CODE:
   git checkout $COMMIT_HASH

2. RESTORE DATABASE:

   a) Go to Supabase Dashboard:
      https://supabase.com/dashboard/project/latxadqrvrrrcvkktrog

   b) Navigate to:
      Settings â†’ Database â†’ Backups â†’ Point-in-Time Recovery

   c) Select timestamp:
      $TIMESTAMP

   d) Click "Restore" and confirm

   e) Wait 5-30 minutes for restoration

3. VERIFY RESTORATION:

   Check critical tables:
   â€¢ workspace_accounts (should have correct associations)
   â€¢ workspace_members (team access intact)
   â€¢ users (all user accounts present)
   â€¢ campaigns (active campaigns preserved)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
NOTES:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â€¢ PITR available for 7 days from creation date
â€¢ After 7 days, use monthly backup downloads
â€¢ Always restore database BEFORE running migrations
â€¢ Test in development before production restore

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF

echo ""
echo "ðŸ’¾ Restore instructions saved:"
echo "   .restore-points/restore-$TIMESTAMP_FILE.txt"
echo ""
echo "â° PITR available until: $(date -u -v+7d +"%Y-%m-%d %H:%M:%S UTC" 2>/dev/null || date -u -d "+7 days" +"%Y-%m-%d %H:%M:%S UTC" 2>/dev/null || echo "7 days from now")"
echo ""
