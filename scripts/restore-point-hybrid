#!/bin/bash

# Hybrid Restore Point Script
# Creates restore points with both Supabase Pro PITR + Airtable backup

DESCRIPTION="${1:-Restore point}"
TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
TIMESTAMP_FILE=$(date -u +"%Y%m%d_%H%M%S")

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ“¸ Creating Hybrid Restore Point (Maximum Safety)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ðŸ“ Description: $DESCRIPTION"
echo "ðŸ•’ Timestamp: $TIMESTAMP"
echo ""

# Layer 1: Git snapshot (code)
echo "1ï¸âƒ£  Creating Git snapshot..."
git add -A
git commit -m "Restore point: $DESCRIPTION"
COMMIT_HASH=$(git rev-parse HEAD)
echo "   âœ… Code: $COMMIT_HASH"
echo ""

# Layer 2: Airtable backup (critical data - visual)
echo "2ï¸âƒ£  Backing up to Airtable..."
node scripts/backup-to-airtable.cjs "$DESCRIPTION"
AIRTABLE_STATUS=$?
echo ""

# Layer 3: Supabase Pro PITR (automatic - comprehensive)
echo "3ï¸âƒ£  Supabase Pro PITR (automatic)..."
echo "   âœ… Point-in-time recovery available: $TIMESTAMP"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… Hybrid Restore Point Created"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ðŸ“‹ Backup Layers:"
echo "   1. Code: Git commit $COMMIT_HASH"
echo "   2. Data (Visual): Airtable backup"
if [ $AIRTABLE_STATUS -eq 0 ]; then
  echo "      Status: âœ… Success"
else
  echo "      Status: âš ï¸  Skipped (not configured)"
fi
echo "   3. Data (PITR): Supabase Pro at $TIMESTAMP"
echo ""

# Save restore instructions
mkdir -p .restore-points
cat > ".restore-points/restore-$TIMESTAMP_FILE.txt" <<EOF
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
HYBRID RESTORE POINT: $DESCRIPTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Created: $TIMESTAMP
Git Commit: $COMMIT_HASH

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
RESTORE OPTIONS (Choose based on what you need):
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

OPTION A: Full Restore (Supabase Pro PITR) - RECOMMENDED
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Best for: Complete database restoration including all data

Steps:
1. Restore Code:
   git checkout $COMMIT_HASH

2. Restore Database (Supabase Pro):
   â€¢ Go to: https://supabase.com/dashboard/project/latxadqrvrrrcvkktrog
   â€¢ Settings â†’ Database â†’ Backups â†’ Point-in-Time Recovery
   â€¢ Select time: $TIMESTAMP
   â€¢ Click "Restore"
   â€¢ Wait 5-30 minutes

3. Verify restoration


OPTION B: Selective Restore (Airtable)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Best for: Restoring specific tables or verifying data visually

Steps:
1. View data in Airtable:
   â€¢ Check what was backed up
   â€¢ Verify data integrity visually

2. Restore specific tables:
   node scripts/restore-from-airtable.cjs "$DESCRIPTION"

3. Restore code if needed:
   git checkout $COMMIT_HASH


OPTION C: Emergency Restore (Both)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Best for: When PITR window expired (>7 days) or Supabase issues

Steps:
1. Restore code:
   git checkout $COMMIT_HASH

2. Restore critical tables from Airtable:
   node scripts/restore-from-airtable.cjs "$DESCRIPTION"

3. Verify and fill gaps manually if needed

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
VERIFICATION CHECKLIST:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

After restoration, verify:
â–¡ workspace_accounts - All Unipile connections present
â–¡ workspace_members - Team access intact
â–¡ users - All user accounts present
â–¡ campaigns - Active campaigns preserved
â–¡ Application runs without errors
â–¡ Can log in and access features

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
IMPORTANT NOTES:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â€¢ Supabase PITR available for 7 days: Until $(date -u -v+7d +"%Y-%m-%d" 2>/dev/null || date -u -d "+7 days" +"%Y-%m-%d" 2>/dev/null || echo "7 days from now")
â€¢ Airtable backup available: Indefinitely
â€¢ For restores >7 days old: Use Airtable or monthly backup downloads
â€¢ Always test in development before production restore
â€¢ Consider creating monthly backup downloads for long-term archive

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ“‹ TO RESTORE THIS STATE:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Option A (Full - Recommended):"
echo "  1. git checkout $COMMIT_HASH"
echo "  2. Use Supabase PITR to $TIMESTAMP"
echo ""
echo "Option B (Selective):"
echo "  1. node scripts/restore-from-airtable.cjs \"$DESCRIPTION\""
echo ""
echo "Option C (Emergency):"
echo "  1. git checkout $COMMIT_HASH"
echo "  2. node scripts/restore-from-airtable.cjs \"$DESCRIPTION\""
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ðŸ’¾ Full instructions: .restore-points/restore-$TIMESTAMP_FILE.txt"
echo "â° PITR available until: $(date -u -v+7d +"%Y-%m-%d %H:%M" 2>/dev/null || date -u -d "+7 days" +"%Y-%m-%d %H:%M" 2>/dev/null || echo "7 days from now")"
echo ""
