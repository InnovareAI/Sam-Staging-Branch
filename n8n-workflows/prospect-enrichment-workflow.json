{
  "name": "SAM Prospect Enrichment with BrightData",
  "nodes": [
    {
      "id": "webhook_trigger",
      "name": "Enrichment Job Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300],
      "parameters": {
        "path": "prospect-enrichment",
        "httpMethod": "POST",
        "responseMode": "lastNode",
        "options": {}
      },
      "notes": "Triggered by /api/prospects/enrich-async when user clicks 'Enrich'"
    },
    {
      "id": "parse_webhook_data",
      "name": "Parse Job Data",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [450, 300],
      "parameters": {
        "functionCode": "// Extract job details from webhook\nconst body = $input.item.json.body || $input.item.json;\n\nreturn [{\n  json: {\n    job_id: body.job_id,\n    workspace_id: body.workspace_id,\n    prospect_ids: body.prospect_ids,\n    supabase_url: body.supabase_url,\n    supabase_key: body.supabase_service_key,\n    brightdata_api_token: body.brightdata_api_token || '61813293-6532-4e16-af76-9803cc043afa',\n    brightdata_zone: body.brightdata_zone || 'linkedin_enrichment'\n  }\n}];"
      },
      "notes": "Extracts job_id, workspace_id, prospect_ids, and API credentials"
    },
    {
      "id": "mark_job_processing",
      "name": "Mark Job as Processing",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [650, 300],
      "parameters": {
        "authentication": "serviceRole",
        "resource": "row",
        "operation": "update",
        "tableId": "enrichment_jobs",
        "filterType": "manual",
        "matchingColumns": "id",
        "columnsUi": {
          "columnValues": [
            {
              "column": "status",
              "value": "processing"
            },
            {
              "column": "started_at",
              "value": "={{ new Date().toISOString() }}"
            }
          ]
        }
      },
      "credentials": {
        "supabaseApi": {
          "url": "={{ $json.supabase_url }}",
          "serviceRole": "={{ $json.supabase_key }}"
        }
      },
      "notes": "Updates enrichment_jobs status to 'processing'"
    },
    {
      "id": "get_prospects",
      "name": "Get Prospects to Enrich",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [850, 300],
      "parameters": {
        "authentication": "serviceRole",
        "resource": "row",
        "operation": "get",
        "tableId": "workspace_prospects",
        "filterType": "manual",
        "matchingColumns": "id",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "in",
              "keyValue": "={{ $json.prospect_ids }}"
            }
          ]
        },
        "options": {
          "selectFields": "id,linkedin_url,company_name,location,industry"
        }
      },
      "credentials": {
        "supabaseApi": {
          "url": "={{ $json.supabase_url }}",
          "serviceRole": "={{ $json.supabase_key }}"
        }
      },
      "notes": "Fetches prospects that need enrichment from workspace_prospects"
    },
    {
      "id": "loop_prospects",
      "name": "Loop Through Prospects",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [1050, 300],
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "notes": "Process one prospect at a time to avoid rate limits"
    },
    {
      "id": "check_linkedin_url",
      "name": "Check LinkedIn URL Exists",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1250, 300],
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.linkedin_url }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "notes": "Skip prospects without LinkedIn URL"
    },
    {
      "id": "update_current_prospect",
      "name": "Update Current Prospect Progress",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1450, 200],
      "parameters": {
        "authentication": "serviceRole",
        "resource": "row",
        "operation": "update",
        "tableId": "enrichment_jobs",
        "filterType": "manual",
        "matchingColumns": "id",
        "columnsUi": {
          "columnValues": [
            {
              "column": "current_prospect_id",
              "value": "={{ $json.id }}"
            },
            {
              "column": "current_prospect_url",
              "value": "={{ $json.linkedin_url }}"
            }
          ]
        }
      },
      "credentials": {
        "supabaseApi": {
          "url": "={{ $('Parse Job Data').item.json.supabase_url }}",
          "serviceRole": "={{ $('Parse Job Data').item.json.supabase_key }}"
        }
      },
      "notes": "Update UI with current prospect being enriched"
    },
    {
      "id": "call_brightdata",
      "name": "Scrape LinkedIn Profile",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1650, 200],
      "parameters": {
        "method": "POST",
        "url": "https://api.brightdata.com/request",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Parse Job Data').item.json.brightdata_api_token }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "zone",
              "value": "={{ $('Parse Job Data').item.json.brightdata_zone }}"
            },
            {
              "name": "url",
              "value": "={{ $json.linkedin_url.split('?')[0] }}"
            },
            {
              "name": "format",
              "value": "raw"
            }
          ]
        },
        "options": {
          "timeout": 60000,
          "retry": {
            "maxRetries": 2,
            "retryInterval": 5000
          }
        }
      },
      "notes": "Call BrightData API (35-40s, no timeout in N8N!)"
    },
    {
      "id": "parse_linkedin_html",
      "name": "Parse LinkedIn Data",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1850, 200],
      "parameters": {
        "functionCode": "// Parse LinkedIn HTML to extract structured data\nconst html = $input.item.json;\nconst linkedinUrl = $('Check LinkedIn URL Exists').item.json.linkedin_url;\n\nlet company_name, job_title, location, industry;\n\n// Strategy 1: Extract from \"Name - Title at Company | LinkedIn\" pattern\nconst titleMatch = html.match(/([^-]+)\\s*-\\s*([^|]+)(?:\\s*\\|\\s*LinkedIn)?/i);\nif (titleMatch && titleMatch[2]) {\n  const titleParts = titleMatch[2].trim();\n  const jobCompany = titleParts.match(/(.+?)\\s+at\\s+(.+)/i);\n  if (jobCompany) {\n    job_title = jobCompany[1].trim();\n    company_name = jobCompany[2].trim();\n  }\n}\n\n// Strategy 2: Extract from markdown headers \"## Title at Company\"\nif (!company_name) {\n  const headerMatch = html.match(/##?\\s*([^\\n]+)\\s*at\\s*([^\\n]+)/i);\n  if (headerMatch) {\n    job_title = headerMatch[1].trim();\n    company_name = headerMatch[2].trim();\n  }\n}\n\n// Strategy 3: Extract from \"Current: Title at Company\" pattern\nif (!company_name) {\n  const currentMatch = html.match(/Current[:\\s]+[^at]+at\\s+([^\\n|•]+)/i);\n  if (currentMatch) {\n    company_name = currentMatch[1].trim();\n  }\n}\n\n// Extract location\nconst locPatterns = [\n  /location[:\\s]+([^\\n|•]+)/i,\n  /based in[:\\s]+([^\\n|•]+)/i,\n  /([A-Z][a-z]+(?:,\\s*[A-Z]{2})?(?:,\\s*[A-Z][a-z]+)?)/\n];\n\nfor (const pattern of locPatterns) {\n  const match = html.match(pattern);\n  if (match && match[1]) {\n    location = match[1].trim();\n    break;\n  }\n}\n\n// Extract industry\nconst industryPatterns = [\n  /industry[:\\s]+([^\\n|•]+)/i,\n  /sector[:\\s]+([^\\n|•]+)/i\n];\n\nfor (const pattern of industryPatterns) {\n  const match = html.match(pattern);\n  if (match && match[1]) {\n    industry = match[1].trim();\n    break;\n  }\n}\n\nconst verification_status = company_name ? 'verified' : 'failed';\n\nreturn [{\n  json: {\n    linkedin_url: linkedinUrl,\n    company_name: company_name || null,\n    job_title: job_title || null,\n    location: location || null,\n    industry: industry || null,\n    verification_status: verification_status,\n    prospect_id: $('Check LinkedIn URL Exists').item.json.id,\n    raw_html_sample: html.substring(0, 500) // Keep sample for debugging\n  }\n}];"
      },
      "notes": "Extract company_name, job_title, location, industry from LinkedIn HTML"
    },
    {
      "id": "update_prospect_success",
      "name": "Update Prospect with Enriched Data",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [2050, 200],
      "parameters": {
        "authentication": "serviceRole",
        "resource": "row",
        "operation": "update",
        "tableId": "workspace_prospects",
        "filterType": "manual",
        "matchingColumns": "id",
        "columnsUi": {
          "columnValues": [
            {
              "column": "company_name",
              "value": "={{ $json.company_name || $('Check LinkedIn URL Exists').item.json.company_name }}"
            },
            {
              "column": "location",
              "value": "={{ $json.location || $('Check LinkedIn URL Exists').item.json.location }}"
            },
            {
              "column": "industry",
              "value": "={{ $json.industry || $('Check LinkedIn URL Exists').item.json.industry }}"
            }
          ]
        }
      },
      "credentials": {
        "supabaseApi": {
          "url": "={{ $('Parse Job Data').item.json.supabase_url }}",
          "serviceRole": "={{ $('Parse Job Data').item.json.supabase_key }}"
        }
      },
      "notes": "Update workspace_prospects with enriched data"
    },
    {
      "id": "increment_processed",
      "name": "Increment Processed Count",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [2250, 200],
      "parameters": {
        "authentication": "serviceRole",
        "resource": "database",
        "operation": "executeQuery",
        "query": "UPDATE enrichment_jobs SET processed_count = processed_count + 1, enrichment_results = enrichment_results || '{{ $json | tojson }}'::jsonb WHERE id = '{{ $('Parse Job Data').item.json.job_id }}'"
      },
      "credentials": {
        "supabaseApi": {
          "url": "={{ $('Parse Job Data').item.json.supabase_url }}",
          "serviceRole": "={{ $('Parse Job Data').item.json.supabase_key }}"
        }
      },
      "notes": "Increment processed_count and add result to enrichment_results array"
    },
    {
      "id": "increment_failed",
      "name": "Increment Failed Count",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1450, 400],
      "parameters": {
        "authentication": "serviceRole",
        "resource": "database",
        "operation": "executeQuery",
        "query": "UPDATE enrichment_jobs SET failed_count = failed_count + 1 WHERE id = '{{ $('Parse Job Data').item.json.job_id }}'"
      },
      "credentials": {
        "supabaseApi": {
          "url": "={{ $('Parse Job Data').item.json.supabase_url }}",
          "serviceRole": "={{ $('Parse Job Data').item.json.supabase_key }}"
        }
      },
      "notes": "Increment failed_count for prospects without LinkedIn URL"
    },
    {
      "id": "complete_job",
      "name": "Mark Job Complete",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [2450, 300],
      "parameters": {
        "authentication": "serviceRole",
        "resource": "row",
        "operation": "update",
        "tableId": "enrichment_jobs",
        "filterType": "manual",
        "matchingColumns": "id",
        "columnsUi": {
          "columnValues": [
            {
              "column": "status",
              "value": "completed"
            },
            {
              "column": "completed_at",
              "value": "={{ new Date().toISOString() }}"
            }
          ]
        }
      },
      "credentials": {
        "supabaseApi": {
          "url": "={{ $('Parse Job Data').item.json.supabase_url }}",
          "serviceRole": "="{{ $('Parse Job Data').item.json.supabase_key }}"
        }
      },
      "notes": "Mark enrichment job as completed"
    },
    {
      "id": "respond_webhook",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2650, 300],
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { success: true, job_id: $('Parse Job Data').item.json.job_id, message: 'Enrichment completed' } }}"
      },
      "notes": "Send success response back to Sam"
    }
  ],
  "connections": {
    "webhook_trigger": {
      "main": [[{ "node": "parse_webhook_data", "type": "main", "index": 0 }]]
    },
    "parse_webhook_data": {
      "main": [[{ "node": "mark_job_processing", "type": "main", "index": 0 }]]
    },
    "mark_job_processing": {
      "main": [[{ "node": "get_prospects", "type": "main", "index": 0 }]]
    },
    "get_prospects": {
      "main": [[{ "node": "loop_prospects", "type": "main", "index": 0 }]]
    },
    "loop_prospects": {
      "main": [
        [{ "node": "check_linkedin_url", "type": "main", "index": 0 }],
        [{ "node": "complete_job", "type": "main", "index": 0 }]
      ]
    },
    "check_linkedin_url": {
      "main": [
        [{ "node": "update_current_prospect", "type": "main", "index": 0 }],
        [{ "node": "increment_failed", "type": "main", "index": 0 }]
      ]
    },
    "update_current_prospect": {
      "main": [[{ "node": "call_brightdata", "type": "main", "index": 0 }]]
    },
    "call_brightdata": {
      "main": [[{ "node": "parse_linkedin_html", "type": "main", "index": 0 }]]
    },
    "parse_linkedin_html": {
      "main": [[{ "node": "update_prospect_success", "type": "main", "index": 0 }]]
    },
    "update_prospect_success": {
      "main": [[{ "node": "increment_processed", "type": "main", "index": 0 }]]
    },
    "increment_processed": {
      "main": [[{ "node": "loop_prospects", "type": "main", "index": 0 }]]
    },
    "increment_failed": {
      "main": [[{ "node": "loop_prospects", "type": "main", "index": 0 }]]
    },
    "complete_job": {
      "main": [[{ "node": "respond_webhook", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-11-01T00:00:00.000Z",
  "versionId": "1"
}
