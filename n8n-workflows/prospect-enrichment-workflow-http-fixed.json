{
  "name": "SAM Prospect Enrichment - HTTP Request Fixed",
  "nodes": [
    {
      "id": "webhook_trigger",
      "name": "Enrichment Job Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300],
      "parameters": {
        "path": "prospect-enrichment",
        "httpMethod": "POST",
        "responseMode": "lastNode",
        "options": {}
      },
      "notes": "Triggered by /api/prospects/enrich when user clicks 'Enrich'"
    },
    {
      "id": "parse_webhook_data",
      "name": "Parse Job Data",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [450, 300],
      "parameters": {
        "functionCode": "// Extract job details from webhook\nconst body = $input.item.json.body || $input.item.json;\n\nreturn [{\n  json: {\n    job_id: body.job_id,\n    workspace_id: body.workspace_id,\n    prospect_ids: body.prospect_ids,\n    supabase_url: body.supabase_url,\n    supabase_key: body.supabase_service_key,\n    brightdata_api_token: body.brightdata_api_token || 'hl_8aca120e:vokteG-4zibcy-juwrux',\n    brightdata_zone: body.brightdata_zone || 'residential'\n  }\n}];"
      },
      "notes": "Extracts job_id, workspace_id, prospect_ids, and API credentials"
    },
    {
      "id": "mark_job_processing",
      "name": "Mark Job as Processing",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [650, 300],
      "parameters": {
        "method": "PATCH",
        "url": "={{ $json.supabase_url }}/rest/v1/enrichment_jobs?id=eq.{{ $json.job_id }}",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $json.supabase_key }}"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $json.supabase_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "contentType": "json",
        "body": "={{ JSON.stringify({ status: 'processing', started_at: new Date().toISOString() }) }}",
        "options": {}
      },
      "notes": "Updates enrichment_jobs status to 'processing' using PATCH"
    },
    {
      "id": "get_prospects",
      "name": "Get Prospects to Enrich",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [850, 300],
      "parameters": {
        "method": "GET",
        "url": "={{ $json.supabase_url }}/rest/v1/prospect_approval_data?prospect_id=in.({{ $json.prospect_ids.map(id => `\"${id}\"`).join(',') }})&select=id,prospect_id,name,contact",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $json.supabase_key }}"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $json.supabase_key }}"
            }
          ]
        },
        "options": {}
      },
      "notes": "Fetches prospects from prospect_approval_data using HTTP GET"
    },
    {
      "id": "loop_prospects",
      "name": "Loop Through Prospects",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [1050, 300],
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "notes": "Process one prospect at a time to avoid rate limits"
    },
    {
      "id": "extract_linkedin_url",
      "name": "Extract LinkedIn URL from Contact",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1250, 300],
      "parameters": {
        "functionCode": "// Extract linkedin_url from contact JSONB field\nconst contact = $json.contact || {};\nconst linkedin_url = contact.linkedin_url || null;\n\nreturn [{\n  json: {\n    prospect_id: $json.prospect_id,\n    id: $json.id,\n    name: $json.name,\n    linkedin_url: linkedin_url,\n    current_contact: contact\n  }\n}];"
      },
      "notes": "Extracts LinkedIn URL from contact JSONB"
    },
    {
      "id": "check_linkedin_url",
      "name": "Check LinkedIn URL Exists",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1450, 300],
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.linkedin_url }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "notes": "Skip prospects without LinkedIn URL"
    },
    {
      "id": "update_current_prospect",
      "name": "Update Current Prospect Progress",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1650, 200],
      "parameters": {
        "method": "PATCH",
        "url": "={{ $('Parse Job Data').item.json.supabase_url }}/rest/v1/enrichment_jobs?id=eq.{{ $('Parse Job Data').item.json.job_id }}",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Parse Job Data').item.json.supabase_key }}"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $('Parse Job Data').item.json.supabase_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "contentType": "json",
        "body": "={{ JSON.stringify({ current_prospect_id: $json.prospect_id, current_prospect_url: $json.linkedin_url }) }}",
        "options": {}
      },
      "notes": "Update UI with current prospect being enriched"
    },
    {
      "id": "call_brightdata",
      "name": "Scrape LinkedIn Profile",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1850, 200],
      "parameters": {
        "method": "POST",
        "url": "https://api.brightdata.com/request",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $('Parse Job Data').item.json.brightdata_api_token }}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "json",
        "body": "={{ JSON.stringify({ zone: $('Parse Job Data').item.json.brightdata_zone, url: $json.linkedin_url.split('?')[0], format: 'raw' }) }}",
        "options": {
          "timeout": 60000,
          "retry": {
            "maxRetries": 2,
            "retryInterval": 5000
          }
        }
      },
      "notes": "Call BrightData API (35-40s, no timeout in N8N!)"
    },
    {
      "id": "parse_linkedin_data",
      "name": "Parse LinkedIn Data",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2050, 200],
      "parameters": {
        "functionCode": "// Parse LinkedIn HTML to extract email and phone\nconst html = $input.item.json;\nconst linkedinUrl = $('Extract LinkedIn URL from Contact').item.json.linkedin_url;\nconst currentContact = $('Extract LinkedIn URL from Contact').item.json.current_contact;\n\nlet email = null;\nlet phone = null;\n\n// Strategy 1: Extract email from mailto: links\nconst emailMatch = html.match(/mailto:([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,})/i);\nif (emailMatch && emailMatch[1]) {\n  email = emailMatch[1];\n}\n\n// Strategy 2: Extract email from common patterns\nif (!email) {\n  const emailPattern = /([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,})/;\n  const match = html.match(emailPattern);\n  if (match && match[1]) {\n    email = match[1];\n  }\n}\n\n// Strategy 3: Extract phone from tel: links\nconst phoneMatch = html.match(/tel:([\\d\\s()+-]+)/i);\nif (phoneMatch && phoneMatch[1]) {\n  phone = phoneMatch[1].trim();\n}\n\n// Strategy 4: Extract phone from common patterns\nif (!phone) {\n  const phonePatterns = [\n    /\\+?\\d{1,3}[\\s-]?\\(?\\d{3}\\)?[\\s-]?\\d{3}[\\s-]?\\d{4}/,\n    /\\(\\d{3}\\)\\s?\\d{3}-\\d{4}/\n  ];\n  \n  for (const pattern of phonePatterns) {\n    const match = html.match(pattern);\n    if (match && match[0]) {\n      phone = match[0].trim();\n      break;\n    }\n  }\n}\n\nconst verification_status = (email || phone) ? 'verified' : 'failed';\n\n// Merge with existing contact data\nconst updatedContact = {\n  ...currentContact,\n  linkedin_url: linkedinUrl,\n  email: email || currentContact.email || null,\n  phone: phone || currentContact.phone || null\n};\n\nreturn [{\n  json: {\n    prospect_id: $('Extract LinkedIn URL from Contact').item.json.prospect_id,\n    id: $('Extract LinkedIn URL from Contact').item.json.id,\n    contact: updatedContact,\n    verification_status: verification_status,\n    raw_html_sample: html.substring(0, 500) // Keep sample for debugging\n  }\n}];"
      },
      "notes": "Extract email and phone from LinkedIn HTML"
    },
    {
      "id": "update_prospect_success",
      "name": "Update Prospect with Enriched Data",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2250, 200],
      "parameters": {
        "method": "PATCH",
        "url": "={{ $('Parse Job Data').item.json.supabase_url }}/rest/v1/prospect_approval_data?id=eq.{{ $json.id }}",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Parse Job Data').item.json.supabase_key }}"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $('Parse Job Data').item.json.supabase_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "contentType": "json",
        "body": "={{ JSON.stringify({ contact: $json.contact }) }}",
        "options": {}
      },
      "notes": "Update prospect_approval_data.contact JSONB with enriched email/phone"
    },
    {
      "id": "increment_processed",
      "name": "Increment Processed Count",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2450, 200],
      "parameters": {
        "method": "POST",
        "url": "={{ $('Parse Job Data').item.json.supabase_url }}/rest/v1/rpc/increment_enrichment_processed",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Parse Job Data').item.json.supabase_key }}"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $('Parse Job Data').item.json.supabase_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "json",
        "body": "={{ JSON.stringify({ p_job_id: $('Parse Job Data').item.json.job_id, p_result: $json }) }}",
        "options": {}
      },
      "notes": "Increment processed_count using RPC function (fallback to raw SQL if RPC doesn't exist)"
    },
    {
      "id": "increment_failed",
      "name": "Increment Failed Count",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1450, 400],
      "parameters": {
        "method": "POST",
        "url": "={{ $('Parse Job Data').item.json.supabase_url }}/rest/v1/rpc/increment_enrichment_failed",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Parse Job Data').item.json.supabase_key }}"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $('Parse Job Data').item.json.supabase_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "json",
        "body": "={{ JSON.stringify({ p_job_id: $('Parse Job Data').item.json.job_id }) }}",
        "options": {}
      },
      "notes": "Increment failed_count using RPC function"
    },
    {
      "id": "complete_job",
      "name": "Mark Job Complete",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2650, 300],
      "parameters": {
        "method": "PATCH",
        "url": "={{ $('Parse Job Data').item.json.supabase_url }}/rest/v1/enrichment_jobs?id=eq.{{ $('Parse Job Data').item.json.job_id }}",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Parse Job Data').item.json.supabase_key }}"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $('Parse Job Data').item.json.supabase_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "contentType": "json",
        "body": "={{ JSON.stringify({ status: 'completed', completed_at: new Date().toISOString() }) }}",
        "options": {}
      },
      "notes": "Mark enrichment job as completed using PATCH"
    },
    {
      "id": "respond_webhook",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2850, 300],
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { success: true, job_id: $('Parse Job Data').item.json.job_id, message: 'Enrichment completed' } }}"
      },
      "notes": "Send success response back to Sam"
    }
  ],
  "connections": {
    "webhook_trigger": {
      "main": [[{ "node": "parse_webhook_data", "type": "main", "index": 0 }]]
    },
    "parse_webhook_data": {
      "main": [[{ "node": "mark_job_processing", "type": "main", "index": 0 }]]
    },
    "mark_job_processing": {
      "main": [[{ "node": "get_prospects", "type": "main", "index": 0 }]]
    },
    "get_prospects": {
      "main": [[{ "node": "loop_prospects", "type": "main", "index": 0 }]]
    },
    "loop_prospects": {
      "main": [
        [{ "node": "extract_linkedin_url", "type": "main", "index": 0 }],
        [{ "node": "complete_job", "type": "main", "index": 0 }]
      ]
    },
    "extract_linkedin_url": {
      "main": [[{ "node": "check_linkedin_url", "type": "main", "index": 0 }]]
    },
    "check_linkedin_url": {
      "main": [
        [{ "node": "update_current_prospect", "type": "main", "index": 0 }],
        [{ "node": "increment_failed", "type": "main", "index": 0 }]
      ]
    },
    "update_current_prospect": {
      "main": [[{ "node": "call_brightdata", "type": "main", "index": 0 }]]
    },
    "call_brightdata": {
      "main": [[{ "node": "parse_linkedin_data", "type": "main", "index": 0 }]]
    },
    "parse_linkedin_data": {
      "main": [[{ "node": "update_prospect_success", "type": "main", "index": 0 }]]
    },
    "update_prospect_success": {
      "main": [[{ "node": "increment_processed", "type": "main", "index": 0 }]]
    },
    "increment_processed": {
      "main": [[{ "node": "loop_prospects", "type": "main", "index": 0 }]]
    },
    "increment_failed": {
      "main": [[{ "node": "loop_prospects", "type": "main", "index": 0 }]]
    },
    "complete_job": {
      "main": [[{ "node": "respond_webhook", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-11-16T00:00:00.000Z",
  "versionId": "2"
}
