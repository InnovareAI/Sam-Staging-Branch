{
  "name": "Campaign Execute - LinkedIn via Unipile (Complete)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "campaign-execute",
        "responseMode": "onReceived",
        "options": {}
      },
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 400],
      "webhookId": "campaign-execute"
    },
    {
      "parameters": {
        "jsCode": "// Extract prospects from webhook payload\nconst prospects = $input.item.json.prospects || [];\nconst campaign = $input.item.json.campaign || {};\nconst messages = $input.item.json.messages || {};\n\n// Standard funnel timing (ALL workspaces use same timing)\n// CR ‚Üí 6h ‚Üí FU1 ‚Üí 3d ‚Üí FU2 ‚Üí 5d ‚Üí FU3 ‚Üí 5d ‚Üí FU4 ‚Üí 5d ‚Üí FU5 ‚Üí 5d ‚Üí FU6\nconst timing = $input.item.json.timing || {\n  fu1_delay_hours: 6,    // FU1: 6 hours after CR\n  fu2_delay_days: 3,     // FU2: 3 days after FU1\n  fu3_delay_days: 5,     // FU3: 5 days after FU2\n  fu4_delay_days: 5,     // FU4: 5 days after FU3\n  fu5_delay_days: 5,     // FU5: 5 days after FU4\n  fu6_delay_days: 5      // FU6: 5 days after FU5 (final message)\n};\n\nconsole.log(`üìä Processing ${prospects.length} prospects for campaign: ${campaign.name}`);\nconsole.log(`‚è±Ô∏è Standard Funnel: CR ‚Üí 6h ‚Üí FU1 ‚Üí 3d ‚Üí FU2 ‚Üí 5d ‚Üí FU3/4/5/6`);\n\n// Return each prospect as a separate item for processing\nreturn prospects.map(prospect => ({\n  json: {\n    prospect,\n    campaign,\n    messages,\n    timing\n  }\n}));"
      },
      "name": "Split Prospects",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 400]
    },
    {
      "parameters": {
        "jsCode": "// Extract LinkedIn username from URL\nconst linkedinUrl = $input.item.json.prospect.linkedin_url;\n\nif (!linkedinUrl) {\n  throw new Error(`No LinkedIn URL for prospect ${$input.item.json.prospect.id}`);\n}\n\nconst username = linkedinUrl.split('/in/')[1]?.split('?')[0]?.replace('/', '');\n\nif (!username) {\n  throw new Error('Invalid LinkedIn URL: ' + linkedinUrl);\n}\n\nconsole.log(`üìù Extracted username: ${username}`);\n\nreturn [{\n  json: {\n    ...$input.item.json,\n    linkedin_username: username\n  }\n}];"
      },
      "name": "Extract Username",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 400]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://{{$env.UNIPILE_DSN}}/api/v1/users/{{$json.linkedin_username}}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-KEY",
              "value": "={{$env.UNIPILE_API_KEY}}"
            },
            {
              "name": "Accept",
              "value": "application/json"
            }
          ]
        },
        "options": {}
      },
      "name": "Lookup LinkedIn Profile",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [850, 400]
    },
    {
      "parameters": {
        "jsCode": "// Personalize connection request message\nconst message = $input.item.json.messages.cr || $input.item.json.messages.connection_request;\nconst prospect = $input.item.json.prospect;\nconst profileData = $input.item.json;\n\nif (!message) {\n  throw new Error('No connection request message configured');\n}\n\nconst personalized = message\n  .replace(/\\{\\{?first_name\\}?\\}/gi, prospect.first_name || '')\n  .replace(/\\{\\{?last_name\\}?\\}/gi, prospect.last_name || '')\n  .replace(/\\{\\{?company_name\\}?\\}/gi, prospect.company_name || prospect.company || '')\n  .replace(/\\{\\{?title\\}?\\}/gi, prospect.title || prospect.job_title || '');\n\n// Truncate to 300 characters (LinkedIn limit)\nconst truncated = personalized.substring(0, 300);\n\nconsole.log(`‚úçÔ∏è Personalized CR for ${prospect.first_name} ${prospect.last_name}`);\n\nreturn [{\n  json: {\n    ...profileData,\n    personalizedMessage: truncated,\n    provider_id: profileData.object?.id || profileData.id\n  }\n}];"
      },
      "name": "Personalize CR",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://{{$env.UNIPILE_DSN}}/api/v1/users/invite",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-KEY",
              "value": "={{$env.UNIPILE_API_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"attendee_id\": \"{{$json.provider_id}}\", \"text\": \"{{$json.personalizedMessage}}\"}",
        "options": {}
      },
      "name": "Send Connection Request",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1250, 400]
    },
    {
      "parameters": {
        "jsCode": "// Extract message/invitation ID\nconst unipileResponse = $input.item.json;\nconst prospect = $node['Extract Username'].json.prospect;\n\nconst messageId = \n  unipileResponse.object?.id ||\n  unipileResponse.id ||\n  unipileResponse.data?.id ||\n  unipileResponse.message_id ||\n  unipileResponse.invitation_id ||\n  `untracked_${Date.now()}_${prospect.id}`;\n\nconsole.log(`‚úÖ CR sent to ${prospect.first_name} ${prospect.last_name} - Message ID: ${messageId}`);\n\nreturn [{\n  json: {\n    prospect_id: prospect.id,\n    provider_id: $node['Personalize CR'].json.provider_id,\n    message_id: messageId,\n    status: 'connection_requested',\n    contacted_at: new Date().toISOString(),\n    unipile_response: JSON.stringify(unipileResponse),\n    prospect: prospect,\n    campaign: $node['Extract Username'].json.campaign,\n    messages: $node['Extract Username'].json.messages\n  }\n}];"
      },
      "name": "Extract Message ID",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1450, 400]
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "={{$env.NEXT_PUBLIC_SUPABASE_URL}}/rest/v1/campaign_prospects?id=eq.{{$json.prospect_id}}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"status\": \"connection_requested\", \"contacted_at\": \"{{$json.contacted_at}}\", \"personalization_data\": {\"unipile_message_id\": \"{{$json.message_id}}\", \"provider_id\": \"{{$json.provider_id}}\", \"unipile_response\": {{$json.unipile_response}}}}",
        "options": {}
      },
      "name": "Update Status CR Sent",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1650, 400]
    },
    {
      "parameters": {
        "amount": "={{$node['Split Prospects'].json.timing.fu1_delay_hours || 6}}",
        "unit": "hours"
      },
      "name": "Wait 6 Hours for FU1",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [1850, 400],
      "webhookId": "wait-fu1"
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://{{$env.UNIPILE_DSN}}/api/v1/users/{{$node['Extract Username'].json.linkedin_username}}/relations",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-KEY",
              "value": "={{$env.UNIPILE_API_KEY}}"
            },
            {
              "name": "Accept",
              "value": "application/json"
            }
          ]
        },
        "options": {}
      },
      "name": "Check Connection via Unipile",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2050, 400]
    },
    {
      "parameters": {
        "jsCode": "// Check if prospect is in our connections list\nconst relations = $input.item.json.items || $input.item.json.data || [];\nconst prospectProviderId = $node['Extract Message ID'].json.provider_id;\n\n// Search for prospect in relations list\nconst isConnected = relations.some(relation => \n  relation.id === prospectProviderId || \n  relation.provider_id === prospectProviderId\n);\n\nconsole.log(`üîç Connection check: ${isConnected ? 'CONNECTED' : 'NOT CONNECTED'}`);\nconsole.log(`   Looking for provider_id: ${prospectProviderId}`);\nconsole.log(`   Found ${relations.length} total relations`);\n\nreturn [{\n  json: {\n    ...$node['Extract Message ID'].json,\n    connection_accepted: isConnected\n  }\n}];"
      },
      "name": "Parse Connection Status",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2250, 400]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.connection_accepted}}",
              "value2": true
            }
          ]
        }
      },
      "name": "Connection Accepted?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [2450, 400]
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "={{$env.NEXT_PUBLIC_SUPABASE_URL}}/rest/v1/campaign_prospects?id=eq.{{$node['Extract Message ID'].json.prospect_id}}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"status\": \"connection_not_accepted\", \"personalization_data\": {\"connection_checked_at\": \"{{new Date().toISOString()}}\", \"sequence_ended_reason\": \"Connection not accepted after 6 hours\"}}",
        "options": {}
      },
      "name": "Mark Not Accepted - End Sequence",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2650, 550]
    },
    {
      "parameters": {
        "jsCode": "// Personalize Follow-Up 1\nconst message = $node['Extract Message ID'].json.messages.fu1 || $node['Extract Message ID'].json.messages.follow_up_1;\nconst prospect = $node['Extract Message ID'].json.prospect;\n\nif (!message) {\n  throw new Error('No FU1 message configured');\n}\n\nconst personalized = message\n  .replace(/\\{\\{?first_name\\}?\\}/gi, prospect.first_name || '')\n  .replace(/\\{\\{?last_name\\}?\\}/gi, prospect.last_name || '')\n  .replace(/\\{\\{?company_name\\}?\\}/gi, prospect.company_name || prospect.company || '')\n  .replace(/\\{\\{?title\\}?\\}/gi, prospect.title || prospect.job_title || '');\n\nconsole.log(`‚úçÔ∏è Personalized FU1 for ${prospect.first_name}`);\n\nreturn [{\n  json: {\n    ...$node['Extract Message ID'].json,\n    followUpMessage: personalized\n  }\n}];"
      },
      "name": "Personalize FU1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2650, 250]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://{{$env.UNIPILE_DSN}}/api/v1/messaging/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-KEY",
              "value": "={{$env.UNIPILE_API_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"provider_id\": \"{{$json.provider_id}}\", \"text\": \"{{$json.followUpMessage}}\"}",
        "options": {}
      },
      "name": "Send FU1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2650, 250]
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "={{$env.NEXT_PUBLIC_SUPABASE_URL}}/rest/v1/campaign_prospects?id=eq.{{$json.prospect_id}}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"status\": \"follow_up_1_sent\", \"personalization_data\": {\"fu1_sent_at\": \"{{new Date().toISOString()}}\"}}",
        "options": {}
      },
      "name": "Update FU1 Sent",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2850, 250]
    },
    {
      "parameters": {
        "amount": "={{($node['Split Prospects'].json.timing.fu2_delay_days || 3) * 24}}",
        "unit": "hours"
      },
      "name": "Wait for FU2",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [3050, 250],
      "webhookId": "wait-fu2"
    },
    {
      "parameters": {
        "jsCode": "// Personalize Follow-Up 2\nconst message = $node['Extract Message ID'].json.messages.fu2 || $node['Extract Message ID'].json.messages.follow_up_2;\nconst prospect = $node['Extract Message ID'].json.prospect;\n\nif (!message) {\n  console.log('‚ö†Ô∏è No FU2 configured, ending sequence');\n  return [];\n}\n\nconst personalized = message\n  .replace(/\\{\\{?first_name\\}?\\}/gi, prospect.first_name || '')\n  .replace(/\\{\\{?last_name\\}?\\}/gi, prospect.last_name || '')\n  .replace(/\\{\\{?company_name\\}?\\}/gi, prospect.company_name || prospect.company || '')\n  .replace(/\\{\\{?title\\}?\\}/gi, prospect.title || prospect.job_title || '');\n\nreturn [{ json: { ...$input.item.json, followUpMessage: personalized } }];"
      },
      "name": "Personalize FU2",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3250, 250]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://{{$env.UNIPILE_DSN}}/api/v1/messaging/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-KEY",
              "value": "={{$env.UNIPILE_API_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"provider_id\": \"{{$json.provider_id}}\", \"text\": \"{{$json.followUpMessage}}\"}",
        "options": {}
      },
      "name": "Send FU2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [3450, 250]
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "={{$env.NEXT_PUBLIC_SUPABASE_URL}}/rest/v1/campaign_prospects?id=eq.{{$json.prospect_id}}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"status\": \"follow_up_2_sent\", \"personalization_data\": {\"fu2_sent_at\": \"{{new Date().toISOString()}}\"}}",
        "options": {}
      },
      "name": "Update FU2 Sent",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [3650, 250]
    },
    {
      "parameters": {
        "amount": "={{($node['Split Prospects'].json.timing.fu3_delay_days || 5) * 24}}",
        "unit": "hours"
      },
      "name": "Wait for FU3",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [3850, 250],
      "webhookId": "wait-fu3"
    },
    {
      "parameters": {
        "jsCode": "// Personalize Follow-Up 3\nconst message = $node['Extract Message ID'].json.messages.fu3 || $node['Extract Message ID'].json.messages.follow_up_3;\nconst prospect = $node['Extract Message ID'].json.prospect;\n\nif (!message) {\n  console.log('‚ö†Ô∏è No FU3 configured, ending sequence');\n  return [];\n}\n\nconst personalized = message\n  .replace(/\\{\\{?first_name\\}?\\}/gi, prospect.first_name || '')\n  .replace(/\\{\\{?last_name\\}?\\}/gi, prospect.last_name || '')\n  .replace(/\\{\\{?company_name\\}?\\}/gi, prospect.company_name || prospect.company || '')\n  .replace(/\\{\\{?title\\}?\\}/gi, prospect.title || prospect.job_title || '');\n\nreturn [{ json: { ...$input.item.json, followUpMessage: personalized } }];"
      },
      "name": "Personalize FU3",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [4050, 250]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://{{$env.UNIPILE_DSN}}/api/v1/messaging/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-KEY",
              "value": "={{$env.UNIPILE_API_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"provider_id\": \"{{$json.provider_id}}\", \"text\": \"{{$json.followUpMessage}}\"}",
        "options": {}
      },
      "name": "Send FU3",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [4250, 250]
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "={{$env.NEXT_PUBLIC_SUPABASE_URL}}/rest/v1/campaign_prospects?id=eq.{{$json.prospect_id}}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"status\": \"follow_up_3_sent\", \"personalization_data\": {\"fu3_sent_at\": \"{{new Date().toISOString()}}\"}}",
        "options": {}
      },
      "name": "Update FU3 Sent",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [4450, 250]
    },
    {
      "parameters": {
        "amount": "={{($node['Split Prospects'].json.timing.fu4_delay_days || 5) * 24}}",
        "unit": "hours"
      },
      "name": "Wait for FU4",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [4650, 250],
      "webhookId": "wait-fu4"
    },
    {
      "parameters": {
        "jsCode": "// Personalize Follow-Up 4\nconst message = $node['Extract Message ID'].json.messages.fu4 || $node['Extract Message ID'].json.messages.follow_up_4;\nconst prospect = $node['Extract Message ID'].json.prospect;\n\nif (!message) {\n  console.log('‚ö†Ô∏è No FU4 configured, ending sequence');\n  return [];\n}\n\nconst personalized = message\n  .replace(/\\{\\{?first_name\\}?\\}/gi, prospect.first_name || '')\n  .replace(/\\{\\{?last_name\\}?\\}/gi, prospect.last_name || '')\n  .replace(/\\{\\{?company_name\\}?\\}/gi, prospect.company_name || prospect.company || '')\n  .replace(/\\{\\{?title\\}?\\}/gi, prospect.title || prospect.job_title || '');\n\nreturn [{ json: { ...$input.item.json, followUpMessage: personalized } }];"
      },
      "name": "Personalize FU4",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [4850, 250]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://{{$env.UNIPILE_DSN}}/api/v1/messaging/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-KEY",
              "value": "={{$env.UNIPILE_API_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"provider_id\": \"{{$json.provider_id}}\", \"text\": \"{{$json.followUpMessage}}\"}",
        "options": {}
      },
      "name": "Send FU4",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [5050, 250]
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "={{$env.NEXT_PUBLIC_SUPABASE_URL}}/rest/v1/campaign_prospects?id=eq.{{$json.prospect_id}}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"status\": \"follow_up_4_sent\", \"personalization_data\": {\"fu4_sent_at\": \"{{new Date().toISOString()}}\"}}",
        "options": {}
      },
      "name": "Update FU4 Sent",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [5250, 250]
    },
    {
      "parameters": {
        "amount": "={{($node['Split Prospects'].json.timing.fu5_delay_days || 5) * 24}}",
        "unit": "hours"
      },
      "name": "Wait for FU5",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [5450, 250],
      "webhookId": "wait-fu5"
    },
    {
      "parameters": {
        "jsCode": "// Personalize Follow-Up 5\nconst message = $node['Extract Message ID'].json.messages.fu5 || $node['Extract Message ID'].json.messages.follow_up_5;\nconst prospect = $node['Extract Message ID'].json.prospect;\n\nif (!message) {\n  console.log('‚ö†Ô∏è No FU5 configured, ending sequence');\n  return [];\n}\n\nconst personalized = message\n  .replace(/\\{\\{?first_name\\}?\\}/gi, prospect.first_name || '')\n  .replace(/\\{\\{?last_name\\}?\\}/gi, prospect.last_name || '')\n  .replace(/\\{\\{?company_name\\}?\\}/gi, prospect.company_name || prospect.company || '')\n  .replace(/\\{\\{?title\\}?\\}/gi, prospect.title || prospect.job_title || '');\n\nreturn [{ json: { ...$input.item.json, followUpMessage: personalized } }];"
      },
      "name": "Personalize FU5",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [5650, 250]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://{{$env.UNIPILE_DSN}}/api/v1/messaging/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-KEY",
              "value": "={{$env.UNIPILE_API_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"provider_id\": \"{{$json.provider_id}}\", \"text\": \"{{$json.followUpMessage}}\"}",
        "options": {}
      },
      "name": "Send FU5",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [5850, 250]
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "={{$env.NEXT_PUBLIC_SUPABASE_URL}}/rest/v1/campaign_prospects?id=eq.{{$json.prospect_id}}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"status\": \"follow_up_5_sent\", \"personalization_data\": {\"fu5_sent_at\": \"{{new Date().toISOString()}}\"}}",
        "options": {}
      },
      "name": "Update FU5 Sent",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [6050, 250]
    },
    {
      "parameters": {
        "amount": "={{($node['Split Prospects'].json.timing.fu6_delay_days || 5) * 24}}",
        "unit": "hours"
      },
      "name": "Wait for FU6",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [6250, 250],
      "webhookId": "wait-fu6"
    },
    {
      "parameters": {
        "jsCode": "// Personalize Follow-Up 6 (final message)\nconst message = $node['Extract Message ID'].json.messages.fu6 || $node['Extract Message ID'].json.messages.follow_up_6;\nconst prospect = $node['Extract Message ID'].json.prospect;\n\nif (!message) {\n  console.log('‚ö†Ô∏è No FU6 configured, ending sequence');\n  return [];\n}\n\nconst personalized = message\n  .replace(/\\{\\{?first_name\\}?\\}/gi, prospect.first_name || '')\n  .replace(/\\{\\{?last_name\\}?\\}/gi, prospect.last_name || '')\n  .replace(/\\{\\{?company_name\\}?\\}/gi, prospect.company_name || prospect.company || '')\n  .replace(/\\{\\{?title\\}?\\}/gi, prospect.title || prospect.job_title || '');\n\nreturn [{ json: { ...$input.item.json, followUpMessage: personalized } }];"
      },
      "name": "Personalize FU6",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [6450, 250]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://{{$env.UNIPILE_DSN}}/api/v1/messaging/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-KEY",
              "value": "={{$env.UNIPILE_API_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"provider_id\": \"{{$json.provider_id}}\", \"text\": \"{{$json.followUpMessage}}\"}",
        "options": {}
      },
      "name": "Send FU6",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [6650, 250]
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "={{$env.NEXT_PUBLIC_SUPABASE_URL}}/rest/v1/campaign_prospects?id=eq.{{$json.prospect_id}}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"status\": \"follow_up_6_sent\", \"personalization_data\": {\"fu6_sent_at\": \"{{new Date().toISOString()}}\", \"sequence_completed_at\": \"{{new Date().toISOString()}}\"}}",
        "options": {}
      },
      "name": "Update FU6 Sent",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [6850, 250]
    },
    {
      "parameters": {
        "jsCode": "console.log('‚úÖ Campaign sequence completed successfully');\nreturn $input.all();"
      },
      "name": "Success",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [7050, 250]
    },
    {
      "parameters": {
        "jsCode": "// Error handler\nconst error = $input.item.json.error || $input.item.json;\nconst prospect = $input.item.json.prospect || {};\n\nconsole.error(`‚ùå Error in campaign for prospect ${prospect.id}:`, error);\n\nreturn [{\n  json: {\n    prospect_id: prospect.id,\n    status: 'failed',\n    error_message: error.message || JSON.stringify(error)\n  }\n}];"
      },
      "name": "Error Handler",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1450, 650]
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "={{$env.NEXT_PUBLIC_SUPABASE_URL}}/rest/v1/campaign_prospects?id=eq.{{$json.prospect_id}}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"status\": \"failed\", \"personalization_data\": {\"error\": \"{{$json.error_message}}\", \"failed_at\": \"{{new Date().toISOString()}}\"}}",
        "options": {}
      },
      "name": "Update Failed Status",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1650, 650]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [[{"node": "Split Prospects", "type": "main", "index": 0}]]
    },
    "Split Prospects": {
      "main": [[{"node": "Extract Username", "type": "main", "index": 0}]]
    },
    "Extract Username": {
      "main": [[{"node": "Lookup LinkedIn Profile", "type": "main", "index": 0}]],
      "error": [[{"node": "Error Handler", "type": "main", "index": 0}]]
    },
    "Lookup LinkedIn Profile": {
      "main": [[{"node": "Personalize CR", "type": "main", "index": 0}]],
      "error": [[{"node": "Error Handler", "type": "main", "index": 0}]]
    },
    "Personalize CR": {
      "main": [[{"node": "Send Connection Request", "type": "main", "index": 0}]],
      "error": [[{"node": "Error Handler", "type": "main", "index": 0}]]
    },
    "Send Connection Request": {
      "main": [[{"node": "Extract Message ID", "type": "main", "index": 0}]],
      "error": [[{"node": "Error Handler", "type": "main", "index": 0}]]
    },
    "Extract Message ID": {
      "main": [[{"node": "Update Status CR Sent", "type": "main", "index": 0}]]
    },
    "Update Status CR Sent": {
      "main": [[{"node": "Wait 24-48 Hours", "type": "main", "index": 0}]],
      "error": [[{"node": "Error Handler", "type": "main", "index": 0}]]
    },
    "Wait 24-48 Hours": {
      "main": [[{"node": "Check Connection Status", "type": "main", "index": 0}]]
    },
    "Check Connection Status": {
      "main": [[{"node": "Connection Accepted?", "type": "main", "index": 0}]]
    },
    "Connection Accepted?": {
      "main": [
        [{"node": "Personalize FU1", "type": "main", "index": 0}],
        [{"node": "Mark Not Accepted", "type": "main", "index": 0}]
      ]
    },
    "Personalize FU1": {
      "main": [[{"node": "Send FU1", "type": "main", "index": 0}]]
    },
    "Send FU1": {
      "main": [[{"node": "Update FU1 Sent", "type": "main", "index": 0}]]
    },
    "Update FU1 Sent": {
      "main": [[{"node": "Wait 48-72 Hours", "type": "main", "index": 0}]]
    },
    "Wait 48-72 Hours": {
      "main": [[{"node": "Personalize FU2", "type": "main", "index": 0}]]
    },
    "Personalize FU2": {
      "main": [[{"node": "Send FU2", "type": "main", "index": 0}]]
    },
    "Send FU2": {
      "main": [[{"node": "Update FU2 Sent", "type": "main", "index": 0}]]
    },
    "Update FU2 Sent": {
      "main": [[{"node": "Wait 72-96 Hours", "type": "main", "index": 0}]]
    },
    "Wait 72-96 Hours": {
      "main": [[{"node": "Personalize FU3", "type": "main", "index": 0}]]
    },
    "Personalize FU3": {
      "main": [[{"node": "Send FU3", "type": "main", "index": 0}]]
    },
    "Send FU3": {
      "main": [[{"node": "Update FU3 Sent", "type": "main", "index": 0}]]
    },
    "Update FU3 Sent": {
      "main": [[{"node": "Wait 96-120 Hours", "type": "main", "index": 0}]]
    },
    "Wait 96-120 Hours": {
      "main": [[{"node": "Personalize FU4", "type": "main", "index": 0}]]
    },
    "Personalize FU4": {
      "main": [[{"node": "Send FU4", "type": "main", "index": 0}]]
    },
    "Send FU4": {
      "main": [[{"node": "Update FU4 Sent", "type": "main", "index": 0}]]
    },
    "Update FU4 Sent": {
      "main": [[{"node": "Wait 120-144 Hours", "type": "main", "index": 0}]]
    },
    "Wait 120-144 Hours": {
      "main": [[{"node": "Personalize FU5", "type": "main", "index": 0}]]
    },
    "Personalize FU5": {
      "main": [[{"node": "Send FU5", "type": "main", "index": 0}]]
    },
    "Send FU5": {
      "main": [[{"node": "Update FU5 Sent", "type": "main", "index": 0}]]
    },
    "Update FU5 Sent": {
      "main": [[{"node": "Wait 168-192 Hours", "type": "main", "index": 0}]]
    },
    "Wait 168-192 Hours": {
      "main": [[{"node": "Personalize Goodbye", "type": "main", "index": 0}]]
    },
    "Personalize Goodbye": {
      "main": [[{"node": "Send Goodbye", "type": "main", "index": 0}]]
    },
    "Send Goodbye": {
      "main": [[{"node": "Update Sequence Complete", "type": "main", "index": 0}]]
    },
    "Update Sequence Complete": {
      "main": [[{"node": "Success", "type": "main", "index": 0}]]
    },
    "Error Handler": {
      "main": [[{"node": "Update Failed Status", "type": "main", "index": 0}]]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "tags": []
}
