#!/usr/bin/env node
const { createClient } = require('@supabase/supabase-js');
require('dotenv').config({ path: '.env.local' });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !supabaseServiceKey) {
  console.error('âŒ Missing Supabase credentials');
  process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseServiceKey);

async function regenerateProxyAssignments() {
  console.log('ðŸ”§ Regenerating proxy assignments with correct credentials...\n');
  
  try {
    // Find all proxy assignments with undefined customer ID
    const { data: assignments, error } = await supabase
      .from('linkedin_proxy_assignments')
      .select('*')
      .like('proxy_username', '%undefined%');
    
    if (error) {
      console.error('âŒ Error fetching assignments:', error.message);
      return;
    }
    
    if (!assignments || assignments.length === 0) {
      console.log('âœ… No assignments need regeneration - all look good!');
      return;
    }
    
    console.log(`âš ï¸  Found ${assignments.length} assignment(s) with undefined customer ID\n`);
    console.log('ðŸ’¡ These need to be regenerated by calling the API with proper Netlify env vars\n');
    console.log('ðŸ“‹ Affected accounts:');
    
    assignments.forEach((assignment, index) => {
      console.log(`  ${index + 1}. ${assignment.linkedin_account_name} (${assignment.detected_country})`);
      console.log(`     Current username: ${assignment.proxy_username?.substring(0, 60)}...`);
    });
    
    console.log('\nðŸ”„ To fix this, either:');
    console.log('   1. Open the app at https://app.meet-sam.com');
    console.log('   2. Go to Settings > LinkedIn Account Proxy Management');
    console.log('   3. The assignments will auto-regenerate with correct credentials from Netlify');
    console.log('\n   OR');
    console.log('\n   Run this command to trigger regeneration via API:');
    console.log('   curl -X POST https://app.meet-sam.com/api/linkedin/assign-proxy-ips \\');
    console.log('        -H "Authorization: Bearer YOUR_TOKEN" \\');
    console.log('        -H "Content-Type: application/json" \\');
    console.log('        -d \'{"force_update": true}\'');
    
  } catch (error) {
    console.error('âŒ Error:', error.message);
  }
}

regenerateProxyAssignments().then(() => {
  console.log('\nâœ… Check completed');
  process.exit(0);
});
