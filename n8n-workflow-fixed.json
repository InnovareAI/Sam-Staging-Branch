{
  "name": "SAM Master Campaign Orchestrator",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "connector-campaign",
        "responseMode": "responseNode",
        "options": {
          "rawBody": false
        }
      },
      "id": "0675fc75-259f-4493-a6e2-85144d06d02f",
      "name": "Campaign Execute Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        -5744,
        -176
      ],
      "webhookId": "campaign-execute"
    },
    {
      "parameters": {
        "url": "={{ 'https://' + $env.UNIPILE_DSN + '/api/v1/users/' + $json.linkedin_username + '?account_id=' + $json.unipileAccountId }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-KEY",
              "value": "={{ $env.UNIPILE_API_KEY }}"
            },
            {
              "name": "Accept",
              "value": "application/json"
            }
          ]
        },
        "options": {}
      },
      "id": "c97d35f4-92cd-49b9-aae1-6a11efb3aa24",
      "name": "Get LinkedIn Profile",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -5328,
        -176
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetween": 5000,
      "continueOnFail": true
    },
    {
      "parameters": {
        "functionCode": "// Merge profile data with original prospect data\nconst profileData = $input.first().json;\nconst originalData = $('Code in JavaScript').first().json;\n\n// Merge: keep all original fields and add provider_id from profile\nreturn {\n  ...originalData,\n  provider_id: profileData.provider_id,\n  profile_name: profileData.name,\n  is_connected: profileData.is_connected || false\n};"
      },
      "id": "af27695d-661c-456e-8ae5-eda40938ac1a",
      "name": "Merge Profile Data",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        -5136,
        -176
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ \'https://\' + $env.UNIPILE_DSN + \'/api/v1/users/invite\' }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-KEY",
              "value": "={{ $env.UNIPILE_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  provider_id: $json.provider_id,\n  account_id: $json.unipileAccountId,\n  message: ($json.messages.cr || $json.messages.connection_request || '').replace('{first_name}', $json.prospect.first_name).replace('{last_name}', $json.prospect.last_name).replace('{company_name}', $json.prospect.company_name || '').replace('{title}', $json.prospect.title || '')\n}) }}",
        "options": {}
      },
      "id": "12860410-29cf-4219-a3b6-5887758629e9",
      "name": "Send CR",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -5008,
        -480
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetween": 5000,
      "continueOnFail": true
    },
    {
      "parameters": {
        "functionCode": "// Initialize connection check counter\nconst data = $input.first().json;\nreturn {\n  ...data,\n  connection_check_count: 0,\n  connection_check_start: new Date().toISOString()\n};"
      },
      "id": "829d3c76-824b-494a-9de4-90852a997a7e",
      "name": "Init Connection Check",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        -4752,
        -480
      ]
    },
    {
      "parameters": {
        "functionCode": "// Restore data after wait\nconst originalData = $node['Init Connection Check'].json;\nreturn originalData;"
      },
      "id": "a74093bb-7c9e-49f8-b890-3ed9e5bb3019",
      "name": "Restore After Wait",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        -4704,
        -160
      ]
    },
    {
      "parameters": {
        "url": "={{ \'https://\' + $env.UNIPILE_DSN + \'/api/v1/users/\' }}" + $json.linkedin_username + '?account_id=' + $json.unipileAccountId",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-KEY",
              "value": "={{ $env.UNIPILE_API_KEY }}"
            }
          ]
        },
        "options": {}
      },
      "id": "cbcd76bc-221d-44d4-bf42-c61b5439a5e3",
      "name": "Check Connection Accepted",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -4512,
        -176
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetween": 5000,
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true
          },
          "conditions": [
            {
              "leftValue": "={{ $json.is_connected }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "9382e2eb-6051-4bd7-b2be-f17c565b03e7",
      "name": "Connection Accepted?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -4256,
        -176
      ]
    },
    {
      "parameters": {
        "functionCode": "// Increment check counter and decide if we should keep checking\nconst data = $input.first().json;\nconst checkCount = (data.connection_check_count || 0) + 1;\nconst startTime = new Date(data.connection_check_start || new Date());\nconst now = new Date();\nconst hoursPassed = (now - startTime) / (1000 * 60 * 60);\n\n// Max 3 weeks (21 days = 504 hours) of checking\nconst maxHours = 504;\nconst shouldContinueChecking = hoursPassed < maxHours;\n\nreturn {\n  ...data,\n  connection_check_count: checkCount,\n  should_continue_checking: shouldContinueChecking,\n  hours_passed: Math.floor(hoursPassed)\n};"
      },
      "id": "7d3d0459-253a-4075-a239-e314b476342c",
      "name": "Increment Check Counter",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        -4096,
        -464
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {},
          "conditions": [
            {
              "leftValue": "={{ $json.should_continue_checking }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "02e15951-2dfa-4ce6-9f72-a09387315d99",
      "name": "Should Retry Check?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -3904,
        -448
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://workflows.innovareai.com/webhook/wait-connection-check-1hr",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "resumeData",
              "value": "={{ JSON.stringify($json) }}"
            }
          ]
        },
        "options": {}
      },
      "id": "e6085a2a-6b21-46ec-95c4-7fb91f9a7457",
      "name": "Loop Back to Wait",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -3472,
        -480
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetween": 5000,
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://app.meet-sam.com/api/webhooks/n8n/prospect-status",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { prospect_id: $json.prospect.id, campaign_id: $json.campaign_id, status: \"not_connected\" } }}",
        "options": {}
      },
      "id": "7f50a2ef-fe62-42ca-8a8d-9844ea852c77",
      "name": "Not Connected - Exit",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -3488,
        -224
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetween": 5000,
      "continueOnFail": true
    },
    {
      "parameters": {
        "amount": 4
      },
      "id": "a66c3a39-c2ab-427e-9a85-4a8a925497b9",
      "name": "Wait 4 Hours After Acceptance",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        -4304,
        208
      ],
      "webhookId": "wait-after-acceptance"
    },
    {
      "parameters": {
        "functionCode": "// Restore data after acceptance wait\nconst originalData = $node['Check Connection Accepted'].json;\nreturn originalData;"
      },
      "id": "4264cd2e-466d-46bd-a22a-6f470a3376fb",
      "name": "Restore After Acceptance Wait",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        -4016,
        208
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ \'https://\' + $env.UNIPILE_DSN + \'/api/v1/messaging/messages\' }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-KEY",
              "value": "={{ $env.UNIPILE_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "attendees_ids",
              "value": "={{ [$json.provider_id] }}"
            },
            {
              "name": "account_id",
              "value": "={{ $json.unipileAccountId }}"
            },
            {
              "name": "text",
              "value": "={{ $json.messages.acceptance_message ? $json.messages.acceptance_message.replace('{first_name}', $json.prospect.first_name).replace('{last_name}', $json.prospect.last_name) : 'Thanks for connecting, ' + $json.prospect.first_name + '!' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "826f48b2-aef2-4b5a-9a46-71bbe69131cf",
      "name": "Send Acceptance Message",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -3776,
        208
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetween": 5000,
      "continueOnFail": true
    },
    {
      "parameters": {
        "amount": "={{ $json.timing.fu1_delay_days }}",
        "unit": "days"
      },
      "id": "fcf5d199-bd7e-4a6c-8474-4f5673e35f78",
      "name": "Wait FU1 Delay",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        -3552,
        208
      ],
      "webhookId": "wait-fu1-delay"
    },
    {
      "parameters": {
        "functionCode": "// Restore data after FU1 wait\nconst originalData = $node['Send Acceptance Message'].json;\nreturn originalData;"
      },
      "id": "4656d1c7-22f1-4af7-b17c-2db500c1ec98",
      "name": "Restore After FU1 Wait",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        -4304,
        592
      ]
    },
    {
      "parameters": {
        "url": "={{ \'https://\' + $env.UNIPILE_DSN + \'/api/v1/messaging/messages?attendees_ids={{ $json.provider_id }}&account_id={{ $json.unipileAccountId }}\' }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-KEY",
              "value": "={{ $env.UNIPILE_API_KEY }}"
            }
          ]
        },
        "options": {}
      },
      "id": "9612d9f7-5125-4d3f-82ab-56ab179fcedd",
      "name": "Check Reply FU1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -4080,
        592
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetween": 5000,
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {},
          "conditions": [
            {
              "leftValue": "={{ $json.items?.filter(m => m.from !== $json.unipileAccountId && new Date(m.date) > new Date($json.last_message_sent)).length || 0 }}",
              "rightValue": "0",
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "951b5565-117c-4d54-9773-9799342958bc",
      "name": "Reply Received FU1?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -3872,
        592
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://app.meet-sam.com/api/webhooks/n8n/prospect-status",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { prospect_id: $json.prospect.id, campaign_id: $json.campaign_id, status: \"replied_fu1\" } }}",
        "options": {}
      },
      "id": "8e11853f-9958-4545-b3d4-b83b86c84cd7",
      "name": "Mark Replied - Exit FU1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -3600,
        848
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetween": 5000,
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ \'https://\' + $env.UNIPILE_DSN + \'/api/v1/messaging/messages\' }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-KEY",
              "value": "={{ $env.UNIPILE_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "attendees_ids",
              "value": "={{ [$json.provider_id] }}"
            },
            {
              "name": "account_id",
              "value": "={{ $json.unipileAccountId }}"
            },
            {
              "name": "text",
              "value": "={{ $json.messages.follow_up_1.replace('{first_name}', $json.prospect.first_name).replace('{last_name}', $json.prospect.last_name).replace('{company_name}', $json.prospect.company_name).replace('{title}', $json.prospect.title) }}"
            }
          ]
        },
        "options": {}
      },
      "id": "4dc7e413-3712-402f-9e27-a50f57d6bc16",
      "name": "Send FU1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -3616,
        576
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetween": 5000,
      "continueOnFail": true
    },
    {
      "parameters": {
        "amount": "={{ $json.timing.fu2_delay_days }}",
        "unit": "days"
      },
      "id": "14c8a710-dabd-47cc-b198-0a198553d471",
      "name": "Wait for FU2",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        -3424,
        576
      ],
      "webhookId": "wait-fu2"
    },
    {
      "parameters": {
        "url": "={{ \'https://\' + $env.UNIPILE_DSN + \'/api/v1/messaging/messages?attendees_ids={{ $json.provider_id }}&account_id={{ $json.unipileAccountId }}\' }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-KEY",
              "value": "={{ $env.UNIPILE_API_KEY }}"
            }
          ]
        },
        "options": {}
      },
      "id": "967b1473-4bbf-44d1-8681-c8f4ee24129c",
      "name": "Check Reply FU2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -3120,
        -16
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetween": 5000,
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {},
          "conditions": [
            {
              "leftValue": "={{ $json.items?.filter(m => m.from !== $json.unipileAccountId && new Date(m.date) > new Date($json.last_message_sent)).length || 0 }}",
              "rightValue": "0",
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "061b9352-06aa-4185-acbe-42e838e9abcb",
      "name": "Reply Received FU2?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -2928,
        -16
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://app.meet-sam.com/api/webhooks/n8n/prospect-status",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { prospect_id: $json.prospect.id, campaign_id: $json.campaign_id, status: \"replied_fu2\" } }}",
        "options": {}
      },
      "id": "f4122b76-55d6-405b-9f30-e71f03fb8690",
      "name": "Mark Replied - Exit FU2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -2736,
        -112
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetween": 5000,
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ \'https://\' + $env.UNIPILE_DSN + \'/api/v1/messaging/messages\' }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-KEY",
              "value": "={{ $env.UNIPILE_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "attendees_ids",
              "value": "={{ [$json.provider_id] }}"
            },
            {
              "name": "account_id",
              "value": "={{ $json.unipileAccountId }}"
            },
            {
              "name": "text",
              "value": "={{ $json.messages.follow_up_2.replace('{first_name}', $json.prospect.first_name).replace('{last_name}', $json.prospect.last_name).replace('{company_name}', $json.prospect.company_name).replace('{title}', $json.prospect.title) }}"
            }
          ]
        },
        "options": {}
      },
      "id": "7f64aefe-77be-4298-9f7e-228b93d4846e",
      "name": "Send FU2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -2736,
        144
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetween": 5000,
      "continueOnFail": true
    },
    {
      "parameters": {
        "amount": "={{ $json.timing.fu3_delay_days }}",
        "unit": "days"
      },
      "id": "a33107b5-b0bb-45ae-97f9-327dd7343738",
      "name": "Wait for FU3",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        -2544,
        144
      ],
      "webhookId": "wait-fu3"
    },
    {
      "parameters": {
        "url": "={{ \'https://\' + $env.UNIPILE_DSN + \'/api/v1/messaging/messages?attendees_ids={{ $json.provider_id }}&account_id={{ $json.unipileAccountId }}\' }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-KEY",
              "value": "={{ $env.UNIPILE_API_KEY }}"
            }
          ]
        },
        "options": {}
      },
      "id": "8b105a1a-5720-465e-86c4-5864d114de3b",
      "name": "Check Reply FU3",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -2352,
        144
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetween": 5000,
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {},
          "conditions": [
            {
              "leftValue": "={{ $json.items?.filter(m => m.from !== $json.unipileAccountId && new Date(m.date) > new Date($json.last_message_sent)).length || 0 }}",
              "rightValue": "0",
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "8faa6668-012b-40fb-9c74-32109ab8652b",
      "name": "Reply Received FU3?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -2160,
        144
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://app.meet-sam.com/api/webhooks/n8n/prospect-status",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { prospect_id: $json.prospect.id, campaign_id: $json.campaign_id, status: \"replied_fu3\" } }}",
        "options": {}
      },
      "id": "c1f91b06-4d88-4a3a-8f39-395eb0ebbc4b",
      "name": "Mark Replied - Exit FU3",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -1968,
        -16
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetween": 5000,
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ \'https://\' + $env.UNIPILE_DSN + \'/api/v1/messaging/messages\' }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-KEY",
              "value": "={{ $env.UNIPILE_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "attendees_ids",
              "value": "={{ [$json.provider_id] }}"
            },
            {
              "name": "account_id",
              "value": "={{ $json.unipileAccountId }}"
            },
            {
              "name": "text",
              "value": "={{ $json.messages.follow_up_3.replace('{first_name}', $json.prospect.first_name).replace('{last_name}', $json.prospect.last_name).replace('{company_name}', $json.prospect.company_name).replace('{title}', $json.prospect.title) }}"
            }
          ]
        },
        "options": {}
      },
      "id": "62dbe93a-ed3c-438b-9742-0768da466dad",
      "name": "Send FU3",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -1968,
        240
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetween": 5000,
      "continueOnFail": true
    },
    {
      "parameters": {
        "amount": "={{ $json.timing.fu4_delay_days }}",
        "unit": "days"
      },
      "id": "d082fa81-0d07-4f14-ad9e-f5f6be260e50",
      "name": "Wait for FU4",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        -1776,
        240
      ],
      "webhookId": "wait-fu4"
    },
    {
      "parameters": {
        "url": "={{ \'https://\' + $env.UNIPILE_DSN + \'/api/v1/messaging/messages?attendees_ids={{ $json.provider_id }}&account_id={{ $json.unipileAccountId }}\' }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-KEY",
              "value": "={{ $env.UNIPILE_API_KEY }}"
            }
          ]
        },
        "options": {}
      },
      "id": "3d4fc929-e549-4dd9-bdf2-718e0eccccd7",
      "name": "Check Reply FU4",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -1584,
        240
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetween": 5000,
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {},
          "conditions": [
            {
              "leftValue": "={{ $json.items?.filter(m => m.from !== $json.unipileAccountId && new Date(m.date) > new Date($json.last_message_sent)).length || 0 }}",
              "rightValue": "0",
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "6c99f96f-8b45-48c1-8b27-de2f016b1ab4",
      "name": "Reply Received FU4?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -1392,
        240
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://app.meet-sam.com/api/webhooks/n8n/prospect-status",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { prospect_id: $json.prospect.id, campaign_id: $json.campaign_id, status: \"replied_fu4\" } }}",
        "options": {}
      },
      "id": "efe01b45-5fff-4c32-9fbc-81885015e43f",
      "name": "Mark Replied - Exit FU4",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -1200,
        144
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetween": 5000,
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ \'https://\' + $env.UNIPILE_DSN + \'/api/v1/messaging/messages\' }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-KEY",
              "value": "={{ $env.UNIPILE_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "attendees_ids",
              "value": "={{ [$json.provider_id] }}"
            },
            {
              "name": "account_id",
              "value": "={{ $json.unipileAccountId }}"
            },
            {
              "name": "text",
              "value": "={{ $json.messages.follow_up_4.replace('{first_name}', $json.prospect.first_name).replace('{last_name}', $json.prospect.last_name).replace('{company_name}', $json.prospect.company_name).replace('{title}', $json.prospect.title) }}"
            }
          ]
        },
        "options": {}
      },
      "id": "40aee538-5dfc-4df3-b8ef-7b04cb30ec47",
      "name": "Send FU4",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -1200,
        336
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetween": 5000,
      "continueOnFail": true
    },
    {
      "parameters": {
        "amount": "={{ $json.timing.gb_delay_days }}",
        "unit": "days"
      },
      "id": "04bfb299-0169-4e3b-bf57-934b0a706daf",
      "name": "Wait for GB",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        -1008,
        336
      ],
      "webhookId": "wait-gb"
    },
    {
      "parameters": {
        "url": "={{ \'https://\' + $env.UNIPILE_DSN + \'/api/v1/messaging/messages?attendees_ids={{ $json.provider_id }}&account_id={{ $json.unipileAccountId }}\' }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-KEY",
              "value": "={{ $env.UNIPILE_API_KEY }}"
            }
          ]
        },
        "options": {}
      },
      "id": "e0dbd8a4-32e5-46de-a1fd-e298e3cf11b2",
      "name": "Check Reply GB",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -816,
        336
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetween": 5000,
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {},
          "conditions": [
            {
              "leftValue": "={{ $json.items?.filter(m => m.from !== $json.unipileAccountId && new Date(m.date) > new Date($json.last_message_sent)).length || 0 }}",
              "rightValue": "0",
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "be052d9c-4b94-4fd5-baeb-8e09a104b17c",
      "name": "Reply Received GB?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -624,
        336
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://app.meet-sam.com/api/webhooks/n8n/prospect-status",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { prospect_id: $json.prospect.id, campaign_id: $json.campaign_id, status: \"replied_gb\" } }}",
        "options": {}
      },
      "id": "66713fff-7f8e-4ff5-9003-363ff6c6d7eb",
      "name": "Mark Replied - Exit GB",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -432,
        240
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetween": 5000,
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ \'https://\' + $env.UNIPILE_DSN + \'/api/v1/messaging/messages\' }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-KEY",
              "value": "={{ $env.UNIPILE_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "attendees_ids",
              "value": "={{ [$json.provider_id] }}"
            },
            {
              "name": "account_id",
              "value": "={{ $json.unipileAccountId }}"
            },
            {
              "name": "text",
              "value": "={{ $json.messages.goodbye.replace('{first_name}', $json.prospect.first_name).replace('{last_name}', $json.prospect.last_name).replace('{company_name}', $json.prospect.company_name).replace('{title}', $json.prospect.title) }}"
            }
          ]
        },
        "options": {}
      },
      "id": "080a18ff-6273-47f7-b9c8-c3013e88a705",
      "name": "Send GB (Breakup)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -432,
        448
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetween": 5000,
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://app.meet-sam.com/api/webhooks/n8n/prospect-status",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { prospect_id: $json.prospect.id, campaign_id: $json.campaign_id, status: \"completed\" } }}",
        "options": {}
      },
      "id": "15bae8cb-5967-41d0-ae28-d38b20dc96f4",
      "name": "Mark Campaign Complete",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -240,
        448
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetween": 5000,
      "continueOnFail": true
    },
    {
      "parameters": {
        "amount": "={{ $json.send_delay_minutes || 0 }}",
        "unit": "minutes"
      },
      "id": "da3b0066-adc8-4dd8-b47e-86ca6d854da8",
      "name": "Wait for Cadence Delay",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        -4864,
        112
      ],
      "webhookId": "wait-cadence-delay"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://app.meet-sam.com/api/webhooks/n8n/prospect-status",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { prospect_id: $json.prospect.id, campaign_id: $json.campaign_id, status: \"connection_requested\" } }}",
        "options": {}
      },
      "id": "2a89b348-94e3-4aa4-9b6d-7754ac62b624",
      "name": "Update Status - CR Sent",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -4912,
        -176
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetween": 5000,
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://app.meet-sam.com/api/webhooks/n8n/error-handler",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  \"executionId\": $execution.id,\n  \"workflowId\": $workflow.id,\n  \"nodeName\": $node.name,\n  \"error\": {\n    \"message\": $json.error?.message || 'Unknown error',\n    \"httpCode\": $json.error?.httpCode || $json.error?.statusCode || 0\n  },\n  \"prospectId\": $json.prospect?.id,\n  \"campaignId\": $json.campaign_id,\n  \"timestamp\": $now\n} }}",
        "options": {}
      },
      "id": "fa1d455e-b25e-4657-91e7-940a1711cb4b",
      "name": "Report Error to SAM",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        -5328,
        288
      ],
      "notes": "Reports errors to SAM error handler for automatic recovery"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -32,
        448
      ],
      "id": "895aabc8-d015-4dba-bee4-4a202375e68c",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "jsCode": "const inputData = $input.first().json;\nconst webhookData = inputData.body || inputData;\n\nconst unipileAccountId = webhookData.unipileAccountId || webhookData.unipile_account_id || webhookData.body?.unipileAccountId || webhookData.body?.unipile_account_id;\nconst workspaceId = webhookData.workspaceId || webhookData.workspace_id;\nconst campaignId = webhookData.campaignId || webhookData.campaign_id;\nconst channel = webhookData.channel || 'linkedin';\nconst campaignType = webhookData.campaignType || webhookData.campaign_type;\nconst messages = webhookData.messages || {};\nconst prospects = Array.isArray(webhookData.prospects) ? webhookData.prospects : [];\n\nif (prospects.length === 0) {\n  return [];\n}\n\nreturn prospects.map(prospect => {\n  const linkedinUrl = prospect.linkedin_url || '';\n  const linkedinUsername = linkedinUrl.split('/').filter(Boolean).pop() || '';\n  \n  return {\n    json: {\n      workspaceId,\n      campaignId,\n      unipileAccountId,\n      channel,\n      campaignType,\n      prospect,\n      linkedin_username: linkedinUsername,\n      messages,\n      supabase_url: webhookData.supabase_url,\n      supabase_service_key: webhookData.supabase_service_key,\n      unipile_dsn: webhookData.unipile_dsn,\n      unipileApiKey: webhookData.unipile_api_key\n    }\n  };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5520,
        -176
      ],
      "id": "d8e172eb-c291-4ae5-8e46-53d292cc167a",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "unit": "days"
      },
      "id": "01a77a85-bb93-4c1b-bbf5-d1a7d19d63a8",
      "name": "Wait 1 Day",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        -4448,
        -480
      ],
      "webhookId": "wait-connection-check-1hr"
    }
  ],
  "pinData": {},
  "connections": {
    "webhook_trigger": {
      "main": [
        [
          {
            "node": "campaign_handler",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "workspace_router": {
      "main": [
        [
          {
            "node": "template_selector",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "template_selector": {
      "main": [
        [
          {
            "node": "campaign_handler",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "campaign_handler": {
      "main": [
        [
          {
            "node": "prospect_loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prospect_loop": {
      "main": [
        [
          {
            "node": "send_cr",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "send_cr": {
      "main": [
        [
          {
            "node": "check_connection_accepted",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check_connection_accepted": {
      "main": [
        [
          {
            "node": "if_connection_accepted",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "if_connection_accepted": {
      "main": [
        [
          {
            "node": "mark_not_connected",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "wait_fu1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "wait_fu1": {
      "main": [
        [
          {
            "node": "check_reply_fu1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check_reply_fu1": {
      "main": [
        [
          {
            "node": "if_reply_fu1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "if_reply_fu1": {
      "main": [
        [
          {
            "node": "mark_engaged_fu1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "send_fu1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "send_fu1": {
      "main": [
        [
          {
            "node": "wait_fu2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "wait_fu2": {
      "main": [
        [
          {
            "node": "check_reply_fu2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check_reply_fu2": {
      "main": [
        [
          {
            "node": "if_reply_fu2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "if_reply_fu2": {
      "main": [
        [
          {
            "node": "mark_engaged_fu2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "send_fu2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "send_fu2": {
      "main": [
        [
          {
            "node": "wait_fu3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "wait_fu3": {
      "main": [
        [
          {
            "node": "check_reply_fu3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check_reply_fu3": {
      "main": [
        [
          {
            "node": "if_reply_fu3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "if_reply_fu3": {
      "main": [
        [
          {
            "node": "mark_engaged_fu3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "send_fu3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "send_fu3": {
      "main": [
        [
          {
            "node": "wait_fu4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "wait_fu4": {
      "main": [
        [
          {
            "node": "check_reply_fu4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check_reply_fu4": {
      "main": [
        [
          {
            "node": "if_reply_fu4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "if_reply_fu4": {
      "main": [
        [
          {
            "node": "mark_engaged_fu4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "send_fu4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "send_fu4": {
      "main": [
        [
          {
            "node": "wait_gb",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "wait_gb": {
      "main": [
        [
          {
            "node": "check_reply_gb",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check_reply_gb": {
      "main": [
        [
          {
            "node": "if_reply_gb",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "if_reply_gb": {
      "main": [
        [
          {
            "node": "mark_engaged_gb",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "send_gb",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "send_gb": {
      "main": [
        [
          {
            "node": "update_status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Campaign Execute Webhook": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get LinkedIn Profile": {
      "main": [
        [
          {
            "node": "Merge Profile Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Profile Data": {
      "main": [
        [
          {
            "node": "Wait for Cadence Delay",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send CR": {
      "main": [
        [
          {
            "node": "Update Status - CR Sent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Init Connection Check": {
      "main": [
        [
          {
            "node": "Wait 1 Day",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Restore After Wait": {
      "main": [
        [
          {
            "node": "Check Connection Accepted",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Connection Accepted": {
      "main": [
        [
          {
            "node": "Connection Accepted?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Connection Accepted?": {
      "main": [
        [
          {
            "node": "Increment Check Counter",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait 4 Hours After Acceptance",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Increment Check Counter": {
      "main": [
        [
          {
            "node": "Should Retry Check?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Retry Check?": {
      "main": [
        [
          {
            "node": "Loop Back to Wait",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Not Connected - Exit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait 4 Hours After Acceptance": {
      "main": [
        [
          {
            "node": "Restore After Acceptance Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Restore After Acceptance Wait": {
      "main": [
        [
          {
            "node": "Send Acceptance Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Acceptance Message": {
      "main": [
        [
          {
            "node": "Wait FU1 Delay",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait FU1 Delay": {
      "main": [
        [
          {
            "node": "Restore After FU1 Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Restore After FU1 Wait": {
      "main": [
        [
          {
            "node": "Check Reply FU1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Reply FU1": {
      "main": [
        [
          {
            "node": "Reply Received FU1?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reply Received FU1?": {
      "main": [
        [
          {
            "node": "Send FU1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mark Replied - Exit FU1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send FU1": {
      "main": [
        [
          {
            "node": "Wait for FU2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait for FU2": {
      "main": [
        [
          {
            "node": "Check Reply FU2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Reply FU2": {
      "main": [
        [
          {
            "node": "Reply Received FU2?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reply Received FU2?": {
      "main": [
        [
          {
            "node": "Send FU2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mark Replied - Exit FU2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send FU2": {
      "main": [
        [
          {
            "node": "Wait for FU3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait for FU3": {
      "main": [
        [
          {
            "node": "Check Reply FU3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Reply FU3": {
      "main": [
        [
          {
            "node": "Reply Received FU3?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reply Received FU3?": {
      "main": [
        [
          {
            "node": "Send FU3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mark Replied - Exit FU3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send FU3": {
      "main": [
        [
          {
            "node": "Wait for FU4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait for FU4": {
      "main": [
        [
          {
            "node": "Check Reply FU4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Reply FU4": {
      "main": [
        [
          {
            "node": "Reply Received FU4?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reply Received FU4?": {
      "main": [
        [
          {
            "node": "Send FU4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mark Replied - Exit FU4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send FU4": {
      "main": [
        [
          {
            "node": "Wait for GB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait for GB": {
      "main": [
        [
          {
            "node": "Check Reply GB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Reply GB": {
      "main": [
        [
          {
            "node": "Reply Received GB?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reply Received GB?": {
      "main": [
        [
          {
            "node": "Send GB (Breakup)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mark Replied - Exit GB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send GB (Breakup)": {
      "main": [
        [
          {
            "node": "Mark Campaign Complete",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait for Cadence Delay": {
      "main": [
        [
          {
            "node": "Send CR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Status - CR Sent": {
      "main": [
        [
          {
            "node": "Init Connection Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark Campaign Complete": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Get LinkedIn Profile",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait 1 Day": {
      "main": [
        [
          {
            "node": "Restore After Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "timezone": "America/New_York",
    "saveManualExecutions": true,
    "saveExecutionProgress": true,
    "saveDataSuccessExecution": "all",
    "saveDataErrorExecution": "all",
    "executionTimeout": 3600
  },
  "versionId": "84863645-33b4-45dd-a9c4-f786f0f7ba82",
  "meta": {
    "instanceId": "57bbc7bcc64f32bccb1d26f3f2b7d2387e819fb384e88e55daf276e2e48423c4"
  },
  "id": "aVG6LC4ZFRMN7Bw6",
  "tags": []
}