<!DOCTYPE html>
<html>
<head>
  <title>Auth Flow Test - SAM AI</title>
  <style>
    body {
      font-family: system-ui;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #0f172a;
      color: white;
    }
    .test-section {
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      background: #1e293b;
      border-left: 4px solid #3b82f6;
    }
    .success { border-left-color: #10b981; }
    .error { border-left-color: #ef4444; }
    .warning { border-left-color: #f59e0b; }
    button {
      padding: 12px 24px;
      background: #3b82f6;
      border: none;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover { background: #2563eb; }
    pre {
      background: #0f172a;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .step { margin: 10px 0; padding: 10px; background: #334155; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>üß™ SAM AI Authentication Test</h1>
  <p>This page will test the complete authentication flow and cookie handling.</p>

  <div id="results"></div>

  <div class="test-section">
    <h3>Actions</h3>
    <button onclick="runAllTests()">üî¨ Run All Tests</button>
    <button onclick="clearAllStorage()">üßπ Clear All Storage</button>
    <button onclick="window.location.href='https://app.meet-sam.com/signin'">üîê Go to Sign In</button>
  </div>

  <script>
    const log = (msg, type = 'info') => {
      const div = document.createElement('div');
      div.className = `test-section ${type}`;
      div.innerHTML = `<pre>${msg}</pre>`;
      document.getElementById('results').appendChild(div);
      console.log(msg);
    };

    async function runAllTests() {
      document.getElementById('results').innerHTML = '';

      log('üî¨ Starting Authentication Flow Tests\n', 'info');

      // Test 1: Check cookies for corruption
      log('Test 1: Cookie Corruption Check', 'info');
      const cookies = document.cookie.split(';');
      let corruptedCount = 0;
      cookies.forEach(cookie => {
        const [name, value] = cookie.trim().split('=');
        if (value && value.startsWith('base64-')) {
          corruptedCount++;
          log(`  ‚ùå CORRUPTED: ${name} starts with "base64-"`, 'error');
        }
      });

      if (corruptedCount === 0) {
        log('  ‚úÖ No corrupted cookies found!', 'success');
      } else {
        log(`  ‚ö†Ô∏è Found ${corruptedCount} corrupted cookie(s)`, 'warning');
      }

      // Test 2: Check Supabase auth cookies
      log('\nTest 2: Supabase Auth Cookies', 'info');
      const authCookies = cookies.filter(c =>
        c.includes('sb-') || c.includes('supabase')
      );
      log(`  Found ${authCookies.length} Supabase auth cookies:`, 'info');
      authCookies.forEach(cookie => {
        const [name] = cookie.trim().split('=');
        log(`    - ${name}`, 'info');
      });

      // Test 3: Check localStorage
      log('\nTest 3: localStorage Check', 'info');
      const lsKeys = Object.keys(localStorage);
      log(`  Found ${lsKeys.length} localStorage items`, 'info');
      lsKeys.forEach(key => {
        if (key.includes('supabase') || key.includes('auth')) {
          const value = localStorage.getItem(key);
          log(`    - ${key}: ${value?.substring(0, 50)}...`, 'info');
        }
      });

      // Test 4: Try to initialize Supabase client
      log('\nTest 4: Supabase Client Initialization', 'info');
      try {
        const response = await fetch('https://app.meet-sam.com/api/admin/diagnose-user', {
          credentials: 'include'
        });
        const data = await response.json();

        if (data.authenticated) {
          log('  ‚úÖ User authenticated!', 'success');
          log(`  Email: ${data.user.email}`, 'success');
          log(`  User ID: ${data.user.id}`, 'success');
          log(`  Workspaces: ${data.diagnosis.workspaceCount}`, data.diagnosis.workspaceCount > 0 ? 'success' : 'error');
          log(`  Memberships: ${data.diagnosis.membershipCount}`, data.diagnosis.membershipCount > 0 ? 'success' : 'error');
        } else {
          log('  ‚ùå Not authenticated', 'error');
          log(`  Error: ${data.error || 'No session'}`, 'error');
        }
      } catch (error) {
        log(`  ‚ùå Error checking auth: ${error.message}`, 'error');
      }

      // Test 5: Check for base64- in cookie writes
      log('\nTest 5: Cookie Write Monitor', 'info');
      log('  Installing cookie write interceptor...', 'info');

      const originalDescriptor = Object.getOwnPropertyDescriptor(Document.prototype, 'cookie');
      Object.defineProperty(document, 'cookie', {
        get: function() {
          return originalDescriptor.get.call(this);
        },
        set: function(value) {
          if (value.includes('base64-')) {
            log(`  ‚ö†Ô∏è INTERCEPTED CORRUPTED WRITE: ${value.substring(0, 50)}...`, 'warning');
          }
          return originalDescriptor.set.call(this, value);
        }
      });

      log('  ‚úÖ Cookie write interceptor installed', 'success');
      log('  Any cookie writes with "base64-" will be logged', 'info');

      log('\n‚úÖ All tests complete!', 'success');
      log('\nNext Steps:', 'info');
      log('1. If cookies are corrupted: Click "Clear All Storage"', 'info');
      log('2. Then click "Go to Sign In"', 'info');
      log('3. Sign in and watch console for "üîß Fixed corrupted cookie" messages', 'info');
      log('4. Come back here and run tests again', 'info');
    }

    function clearAllStorage() {
      log('üßπ Clearing all storage...', 'warning');

      // Clear cookies
      let cookieCount = 0;
      document.cookie.split(";").forEach((c) => {
        const name = c.split("=")[0].trim();
        document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/';
        cookieCount++;
      });
      log(`  Cleared ${cookieCount} cookies`, 'success');

      // Clear localStorage
      const lsCount = localStorage.length;
      localStorage.clear();
      log(`  Cleared ${lsCount} localStorage items`, 'success');

      // Clear sessionStorage
      const ssCount = sessionStorage.length;
      sessionStorage.clear();
      log(`  Cleared ${ssCount} sessionStorage items`, 'success');

      // Clear IndexedDB
      indexedDB.databases().then((dbs) => {
        dbs.forEach((db) => {
          if (db.name) {
            indexedDB.deleteDatabase(db.name);
            log(`  Deleted IndexedDB: ${db.name}`, 'success');
          }
        });

        log('\n‚úÖ ALL STORAGE CLEARED!', 'success');
        log('\nNow click "Go to Sign In" and try signing in fresh', 'info');
      });
    }

    // Auto-run tests on load
    window.addEventListener('load', () => {
      setTimeout(() => runAllTests(), 500);
    });
  </script>
</body>
</html>
